<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Data Fetch</title>
  <script type="module" src="../../dist/auto.js"></script>
  <style>
a {
  text-decoration: none;
  color: #42b883;
}
li {
  line-height: 1.5em;
  margin-bottom: 20px;
}
.author,
.date {
  font-weight: bold;
}
  </style>
</head>
<body>
  <wcs-state>
    <script type="module">
const API_URL = "https://api.github.com/repos/wcstack/wcstack/commits?per_page=3&sha=";
const branches = ['main', 'minor'];
const currentBranch = branches[0];

function truncate(v) {
  const newline = v.indexOf('\n')
  return newline > 0 ? v.slice(0, newline) : v
}

function formatDate(v) {
  return v.replace(/T|Z/g, ' ')
}

export default {
  commits: [],
  branches,
  currentBranch,
  isLoading: false,
  message: "No commits found.",
  get "commits.*.commit.author.formattedDate"() {
    // ループコンテキストの現在要素を参照しています。
    return formatDate(this["commits.*.commit.author.date"]);
  },
  get "commits.*.commit.truncatedMessage"() {
    // ループコンテキストの現在要素を参照しています。
    return truncate(this["commits.*.commit.message"]);
  },
  get "commits.*.author"() {
    return this["commits.*"]["author"] || { html_url: '#', login: 'Unknown' };
  },
  async fetchCommits() {
    this.isLoading = true;
    this.message = "No commits found.";
    try {
      const response = await fetch(API_URL + this.currentBranch);
      const data = await response.json();
      if (!Array.isArray(data)) {
        this.commits = [];
        this.message = data.message || 'Failed to fetch commits.';
      } else {
        this.commits = data;
      }
    } catch(e) {
      console.error('Error fetching commits:', e);
      this.message = e.message || 'Error fetching commits.';
    } finally {
      this.isLoading = false;
    }
  },
  async $connectedCallback() {
    await this.fetchCommits();
  },
  async $updatedCallback(paths) {
    if (paths.includes('currentBranch')) {
      await this.fetchCommits();
    }
  }
};
    </script>
  </wcs-state>
  <h1>Latest wcstack/wcstack Commits</h1>
  <p>wcstack/wcstack@{{ currentBranch }}</p>
  <template data-wcs="for: branches">
    <label>
      <input type="radio" data-wcs="value: .; radio: currentBranch">
      {{ . }}
    </label>
  </template>
  <template data-wcs="if: isLoading">
    <p>Loading...</p>
  </template>
  <template data-wcs="else:">
    <template data-wcs="if: commits.length|gt(0)">
    <ul>
      <template data-wcs="for: commits">
      <li>
        <a target="_blank" class="commit" data-wcs="href: .html_url">{{ .sha|slice(0, 7) }}</a>
        - <span class="message">{{ .commit.truncatedMessage }}</span><br>
        by <span class="author">
          <a target="_blank" data-wcs="href: .author.html_url">{{ .commit.author.name }}</a>
        </span>
        at <span class="date">{{ .commit.author.formattedDate }}</span>
      </li>
      </template>
    </ul>
    </template>
    <template data-wcs="else:">
      <div>{{ message }}</div>
    </template>
  </template>
</body>
</html>  