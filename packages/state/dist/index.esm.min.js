const t={bindAttributeName:"data-bind-state",tagNames:{state:"wcs-state",loop:"wcs-loop"}};function e(e,n){return e.querySelector(`${t.tagNames.state}[name="${n}"]`)}function n(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}class i{_content;_childNodeArray=[];_firstNode=null;_lastNode=null;constructor(t){this._content=t,this._childNodeArray=Array.from(this._content.childNodes),this._firstNode=this._childNodeArray.length>0?this._childNodeArray[0]:null,this._lastNode=this._childNodeArray.length>0?this._childNodeArray[this._childNodeArray.length-1]:null}get firstNode(){return this._firstNode}get lastNode(){return this._lastNode}mountAfter(t){const e=t.parentNode,n=t.nextSibling;e&&this._childNodeArray.forEach(t=>{e.insertBefore(t,n)})}unmount(){this._childNodeArray.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)})}}function s(t){return new i(t)}const o=".",a={};function r(t){if(a[t])return a[t];const e=new l(t);return a[t]=e,e}class l{path="";segments=[];wildcardPositions=[];wildcardPaths=[];wildcardParentPaths=[];wildcardPathInfos=[];wildcardParentPathInfos=[];_parentPathInfo=void 0;constructor(t){this.path=t,this.segments=t.split(o).filter(t=>t.length>0),this.wildcardPositions=this.segments.map((t,e)=>"*"===t?e:-1).filter(t=>-1!==t),this.wildcardPaths=this.wildcardPositions.map(t=>this.segments.slice(0,t+1).join(o)),this.wildcardParentPaths=this.wildcardPositions.map(t=>this.segments.slice(0,t).join(o)),this.wildcardPathInfos=this.wildcardPaths.map(t=>r(t)),this.wildcardParentPathInfos=this.wildcardParentPaths.map(t=>r(t))}get parentPathInfo(){if(void 0!==this._parentPathInfo)return this._parentPathInfo;if(0===this.segments.length)return null;const t=this.segments.slice(0,-1).join(o);return this._parentPathInfo=r(t),this._parentPathInfo}}function d(t){throw new Error(`[@wcstack/state] ${t}`)}const h=new WeakMap;function c(t){return h.get(t)||null}function u(t,e){null!==e?h.set(t,e):h.delete(t)}function p(t,e,n){if(t.nodeType===Node.ELEMENT_NODE){const i=t;if(1===e.length){i[e[0]]=n}else{const t=e[0];if("style"===t){const t=i,s=e[1];t.style[s]=n}else if("attr"===t){const t=e[1];null==n?i.removeAttribute(t):i.setAttribute(t,String(n))}else{const s=i[t];if("object"==typeof s&&null!==s){s[e[1]]=n}}}}else if(t.nodeType===Node.TEXT_NODE){t.textContent=String(n)}}const f=`${t.bindAttributeName.replace(/^data-/,"")}:`;const m=t.bindAttributeName.replace(/^data-/,"");function _(e){const n=[],i=document.createTreeWalker(e,NodeFilter.SHOW_ALL,{acceptNode(e){if(console.log("node:",e),e.nodeType===Node.ELEMENT_NODE){return e.hasAttribute(t.bindAttributeName)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}return function(t){if(t.nodeType!==Node.COMMENT_NODE)return!1;const e=t.data.trim();return null!==RegExp(`^{{\\s*${m}:(.+?)\\s*}}$`).exec(e)}(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;i.nextNode();)n.push(i.currentNode);return n}const g=new Set(["radio","checkbox"]),x=new Set(["value","valueAsNumber","valueAsDate"]);function N(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const n=t,i=n.tagName.toLowerCase();if("input"===i){const t=(n.getAttribute("type")||"text").toLowerCase();if("button"===t)return!1;if(g.has(t)&&"checked"===e)return!0;if(x.has(e))return!0}return"select"===i&&"value"===e||"textarea"===i&&"value"===e}const y=new WeakMap;const P=new WeakSet;async function I(n,i){const s=_(n),o=[];s.forEach(n=>{if(!P.has(n)){P.add(n),function(t,e){null!==e?y.set(t,e):y.delete(t)}(n,i);const s=function(n){const i=[],s=new Map,o=[];if(n.nodeType===Node.ELEMENT_NODE){const o=n;if(o.tagName.toLowerCase()===t.tagNames.loop){const t=o;i.push(t.bindingInfo)}else{const n=(o.getAttribute(t.bindAttributeName)||"").split(";").map(t=>t.trim()).filter(t=>t.length>0);for(const t of n){const[n,a]=t.split(":").map(t=>t.trim()),[l,h]=(n??"").split("#").map(t=>t.trim()),c=h?h.split(",").map(t=>t.trim()):[],u=(l??"").split(".").map(t=>t.trim()),[p,...f]=(a??u.at(-1)??"").split("|").map(t=>t.trim()),m=p.split("@").map(t=>t.trim()),_=m[0]||"",g=m[1]||"default",x=r(_);let N=s.get(g)??null;null===N&&(N=e(document,g),null!==N&&s.set(g,N)),null===N&&d(`State element with name "${g}" not found for binding "${t}".`),""!==l&&""!==_||d(`Invalid binding syntax: "${t}".`);const y={propName:l||"",propSegments:u,propModifiers:c,statePathName:_,statePathInfo:x,stateName:g,stateElement:N,filterTexts:f,node:o};i.push(y)}}}else if(n.nodeType===Node.COMMENT_NODE){const t=n,a=t.data.trim(),l=RegExp(`^{{\\s*${f}\\s*(.+?)\\s*}}$`).exec(a);if(null!==l){const n=l[1],[a,...h]=(n??"").split("|").map(t=>t.trim()),c=a.split("@").map(t=>t.trim()),u=c[0]||"",p=c[1]||"default",f=r(u);let m=s.get(p)??null;null===m&&(m=e(document,p),null!==m&&s.set(p,m)),null===m&&d(`State element with name "${p}" not found for binding "${n}".`),""===u&&d(`Invalid binding syntax: "${n}".`);const _=document.createTextNode(""),g=t.parentNode,x=t.nextSibling;null===g&&d("Comment node has no parent node."),g.insertBefore(_,x),o.push(t);const N={propName:"textContent",propSegments:["textContent"],propModifiers:[],statePathName:u,statePathInfo:f,stateName:p,stateElement:m,filterTexts:h,node:_};i.push(N)}}for(const t of o)t.remove();return i}(n);o.push(...s)}});const a=[],l=new Map;for(const t of o){const e=t.stateElement;if(t.propName.startsWith("on")){const n=t.propName.slice(2);t.node.addEventListener(n,n=>{const i=e.state[t.statePathName];"function"==typeof i&&i.call(e.state,n)});continue}if(N(t.node,t.propName)&&-1===t.propModifiers.indexOf("ro")){let e="select"===t.node.tagName.toLowerCase()?"change":"input";for(const n of t.propModifiers)n.startsWith("on")&&(e=n.slice(2));t.node.addEventListener(e,e=>{const n=e.target;if(void 0===n)return void console.warn("[@wcstack/state] event.target is undefined.");if(!(t.propName in n))return void console.warn(`[@wcstack/state] Property "${t.propName}" does not exist on target element.`);const i=n[t.propName];t.stateElement.state[t.statePathName]=i})}e.addBindingInfo(t);let n=l.get(e);void 0===n&&(n=new Map,l.set(e,n));const i=n.get(t.statePathName);if(void 0!==i){a.push({bindingInfo:t,value:i});continue}await e.initializePromise;const s=e.state[t.statePathName];a.push({bindingInfo:t,value:s}),n.set(t.statePathName,s)}for(const t of a)p(t.bindingInfo.node,t.bindingInfo.propSegments,t.value)}class w extends HTMLElement{_uuid=n();_path="";_stateElement=null;_placeHolder=document.createComment(`@@loop:${this._uuid}`);_initializePromise;_resolveInitialize=null;_initialized=!1;_loopContent=null;_loopContents=[];_loopValue=null;_bindingInfo=null;constructor(){super(),this._initializePromise=new Promise(t=>{this._resolveInitialize=t})}get uuid(){return this._uuid}get path(){return this._path}get stateElement(){return null===this._stateElement&&d("Loop stateElement is not set."),this._stateElement}get loopContent(){return null===this._loopContent&&d("Loop content is not initialized."),this._loopContent}get bindingInfo(){return null===this._bindingInfo&&d("Loop bindingInfo is not set."),this._bindingInfo}get initializePromise(){return this._initializePromise}initialize(){const n=this.querySelector("template");n||d(`${t.tagNames.loop} requires a <template> child element.`),this._loopContent=n.content;const i=this.getAttribute(t.bindAttributeName)||"",[s,o]=i.split("@").map(t=>t.trim());""===s&&d(`Invalid loop binding syntax: "${i}".`);const a=o??"default",l=r(s),h=e(document,a);null===h&&d(`State element with name "${a}" not found for loop binding "${i}".`),this._bindingInfo={propName:"loopValue",propSegments:["loopValue"],propModifiers:[],statePathName:s,statePathInfo:l,stateName:a,stateElement:h,filterTexts:[],node:this},h.listPaths.add(s)}async connectedCallback(){this.replaceWith(this._placeHolder),this._initialized||(this.initialize(),this._resolveInitialize?.(),this._initialized=!0)}get loopValue(){return this._loopValue}set loopValue(t){this.render(t,this._loopValue),this._loopValue=t}render(t,e){if(Array.isArray(t)){null===this._placeHolder.parentNode&&d("Loop placeholder has no parent node.");for(let t of this._loopContents)t.unmount();this._loopContents=[];const e=c(t);null===e&&d("List indexes not found for loop value.");let n=this._placeHolder;for(let i=0;i<t.length;i++){const t=e[i],o=document.importNode(this.loopContent,!0);I(o,t);const a=s(o);a.mountAfter(n),this._loopContents.push(a),n=a.lastNode||n}}else for(let t of this._loopContents)t.unmount()}}let b=0;class E{uuid=n();parentListIndex;position;length;_index;_version;_indexes;_listIndexes;constructor(t,e){this.parentListIndex=t,this.position=t?t.position+1:0,this.length=this.position+1,this._index=e,this._version=b}get index(){return this._index}set index(t){this._index=t,this._version=++b,this.indexes[this.position]=t}get version(){return this._version}get dirty(){return null!==this.parentListIndex&&(this.parentListIndex.dirty||this.parentListIndex.version>this._version)}get indexes(){return null===this.parentListIndex?void 0===this._indexes&&(this._indexes=[this._index]):(void 0===this._indexes||this.dirty)&&(this._indexes=[...this.parentListIndex.indexes,this._index],this._version=b),this._indexes}get listIndexes(){return null===this.parentListIndex?void 0===this._listIndexes&&(this._listIndexes=[new WeakRef(this)]):void 0===this._listIndexes&&(this._listIndexes=[...this.parentListIndex.listIndexes,new WeakRef(this)]),this._listIndexes}get varName(){return`$${this.position+1}`}at(t){return t>=0?this.listIndexes[t]?.deref()||null:this.listIndexes[this.listIndexes.length+t]?.deref()||null}}function v(t,e){return new E(t,e)}function L(t,e){const n=[];for(let i=0;i<t.length;i++)n.push(v(e,i));return n}class S{_bindingInfosByPath;_listPaths;constructor(t,e){this._bindingInfosByPath=t,this._listPaths=e}_getNestValue(t,e,n){let i=e;if(i.path in t)return Reflect.get(t,i.path,n);const s=i.parentPathInfo;if(null===s)return;const o=this._getNestValue(t,s,n),a=i.segments[i.segments.length-1];return a in o?Reflect.get(o,a,n):void console.warn(`[@wcstack/state] Property "${e.path}" does not exist on state.`)}get(t,e,n){let i;try{if("string"==typeof e){const s=r(e);if(s.segments.length>1)return i=this._getNestValue(t,s,n)}return e in t?i=Reflect.get(t,e,n):void console.warn(`[@wcstack/state] Property "${String(e)}" does not exist on state.`)}finally{if("string"==typeof e&&this._listPaths.has(e)&&null===c(i)){u(i,L(i??[],null))}}}set(t,e,n,i){let s=!1;if("string"==typeof e){const o=r(e);if(o.segments.length>1){if(null===o.parentPathInfo)return!1;const e=this._getNestValue(t,o.parentPathInfo,i),a=o.segments[o.segments.length-1];s=Reflect.set(e,a,n,i)}else s=Reflect.set(t,e,n,i);if(this._bindingInfosByPath.has(String(e))){const t=this._bindingInfosByPath.get(String(e))||[];for(const e of t)p(e.node,e.propSegments,n)}}else s=Reflect.set(t,e,n,i);if("string"==typeof e&&this._listPaths.has(e)){u(n,L(n??[],null))}return s}}class A extends HTMLElement{_uuid=n();_state;_proxyState;_name="default";_initialized=!1;_bindingInfosByPath=new Map;_initializePromise;_resolveInitialize=null;_listPaths=new Set;constructor(){super(),this._initializePromise=new Promise(t=>{this._resolveInitialize=t})}get uuid(){return this._uuid}get state(){var e,n,i;return void 0===this._state&&d(`${t.tagNames.state} _state is not initialized yet.`),void 0===this._proxyState&&(this._proxyState=(e=this._state,n=this._bindingInfosByPath,i=this._listPaths,new Proxy(e,new S(n,i)))),this._proxyState}get name(){return this._name}async _getState(t){const e=this.querySelector('script[type="module"]');if(e)return await async function(t,e){let n=null;const i=`\n//# sourceURL=${e}\n`;if("function"==typeof URL.createObjectURL){const e=new Blob([t.text+i],{type:"application/javascript"}),s=URL.createObjectURL(e);try{n=await import(s)}finally{URL.revokeObjectURL(s)}}else{const e=btoa(String.fromCodePoint(...(new TextEncoder).encode(t.text+i)));n=await import(`data:application/javascript;base64,${e}`)}return n&&"object"==typeof n.default?n.default:{}}(e,`state#${t}`);const n=this.getAttribute("src");if(n&&n.endsWith(".json"))return await async function(t){try{const e=await fetch(t);return e.ok||d(`Failed to fetch JSON file: ${e.statusText}`),await e.json()}catch(t){return console.error("Failed to load JSON file:",t),{}}}(n);if(n&&n.endsWith(".js"))return await async function(t){try{return(await import(t)).default||{}}catch(t){d(`Failed to load script file: ${t}`)}}(n);n&&d(`Unsupported src file type: ${n}`);const i=this.getAttribute("state");return i?function(t){const e=document.getElementById(t);if(e&&"application/json"===e.type)try{return JSON.parse(e.textContent||"{}")}catch(t){d("Failed to parse JSON from script element:"+t)}return{}}(i):{}}async _initialize(){const t=this.getAttribute("name");null===t?(this._name="default",this.setAttribute("name",this._name)):this._name=t,this._state=await this._getState(this._name)}async connectedCallback(){this._initialized||(await this._initialize(),this._initialized=!0,this._resolveInitialize?.())}get bindingInfosByPath(){return this._bindingInfosByPath}get initializePromise(){return this._initializePromise}get listPaths(){return this._listPaths}addBindingInfo(t){const e=t.statePathName,n=this._bindingInfosByPath.get(e);void 0===n?this._bindingInfosByPath.set(e,[t]):n.push(t)}}function C(){customElements.get(t.tagNames.state)||customElements.define(t.tagNames.state,A),customElements.get(t.tagNames.loop)||customElements.define(t.tagNames.loop,w),document.addEventListener("DOMContentLoaded",async()=>{await I(document.body,null)})}export{C as bootstrapState};
//# sourceMappingURL=index.esm.min.js.map
