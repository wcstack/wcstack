const t="data-wcs",e="wcs-text",n="wcs-for",s="wcs-if",o="wcs-elseif",i="wcs-else",r={state:"wcs-state"},a="en";function l(t){throw new Error(`[@wcstack/state] ${t}`)}const d=new WeakMap;function c(t,e){let n=d.get(t);return n&&n.get(e)||null}function u(t,e,n){let s=d.get(t);s||(s=new Map,d.set(t,s)),null===n?s.delete(e):(s.has(e)&&l(`State element with name "${e}" is already registered.`),s.set(e,n))}const f="*",h=128,p={};for(let t=0;t<128;t++)p[`$${t+1}`]=t;const m=Object.freeze(p);class g{_loopContextStack=Array(h).fill(void 0);_length=0;createLoopContext(t,e){null===t.listIndex&&l("Cannot create loop context for a state address that does not have a list index.");const n=t;this._length>=h&&l("Exceeded maximum loop context stack depth of 128. Possible infinite loop.");const s=this._loopContextStack[this._length-1];if(void 0!==s){s.pathInfo.wildcardCount+1!==n.pathInfo.wildcardCount&&l("Cannot push loop context for a list whose wildcard count is not exactly one more than the current active loop context.");const t=n.pathInfo.wildcardPathInfos[n.pathInfo.wildcardPathInfos.length-2];s.pathInfo!==t&&l("Cannot push loop context for a list whose parent wildcard path info does not match the current active loop context.")}else 1!==n.pathInfo.wildcardCount&&l("Cannot push loop context for a list with wildcard positions when there is no active loop context.");let o;this._loopContextStack[this._length]=n,this._length++;try{o=e(n)}finally{o instanceof Promise?o.finally(()=>{this._length--,this._loopContextStack[this._length]=void 0}):(this._length--,this._loopContextStack[this._length]=void 0)}return o}}const x={};let w=0;function I(t){if(x[t])return x[t];const e=Object.freeze(new N(t));return x[t]=e,e}class N{id=++w;path;segments;lastSegment;cumulativePaths;cumulativePathSet;cumulativePathInfos;cumulativePathInfoSet;parentPath;wildcardPaths;wildcardPathSet;indexByWildcardPath;wildcardPathInfos;wildcardPathInfoSet;wildcardParentPaths;wildcardParentPathSet;wildcardParentPathInfos;wildcardParentPathInfoSet;wildcardPositions;lastWildcardPath;lastWildcardInfo;wildcardCount;parentPathInfo;constructor(t){const e=e=>t===e?this:I(e),n=t.split("."),s=[],o=[],i=[],r={},a=[],l=[],d=[],c=[];let u="",h="",p=0;for(let t=0;t<n.length;t++)u+=n[t],n[t]===f&&(i.push(u),r[u]=p,a.push(e(u)),l.push(h),d.push(e(h)),c.push(t),p++),s.push(u),o.push(e(u)),h=u,u+=".";const m=i.length>0?i[i.length-1]:null,g=s.length>1?s[s.length-2]:null;this.path=t,this.segments=n,this.lastSegment=n[n.length-1],this.cumulativePaths=s,this.cumulativePathSet=new Set(s),this.cumulativePathInfos=o,this.cumulativePathInfoSet=new Set(o),this.wildcardPaths=i,this.wildcardPathSet=new Set(i),this.indexByWildcardPath=r,this.wildcardPathInfos=a,this.wildcardPathInfoSet=new Set(a),this.wildcardParentPaths=l,this.wildcardParentPathSet=new Set(l),this.wildcardParentPathInfos=d,this.wildcardParentPathInfoSet=new Set(d),this.wildcardPositions=c,this.lastWildcardPath=m,this.lastWildcardInfo=m?e(m):null,this.parentPath=g,this.parentPathInfo=g?e(g):null,this.wildcardCount=p}}const y=new Map;class S{path;segments;paths;wildcardCount;wildcardType;wildcardIndexes;pathInfo;constructor(t){const e=t.split("."),n=e.slice(),s=[];let o=0,i=0,r="",a=0,l="none";const d=[];for(let t=0;t<e.length;t++){const l=e[t];if("*"===l)n[t]="*",d.push(null),o++,a++;else{const e=Number(l);Number.isNaN(e)||(n[t]="*",d.push(e),i++,a++)}r+=l,s.push(r),r+=t<l.length-1?".":""}const c=I(n.join("."));(o>0||i>0)&&(l=o===a?"context":i===a?"all":"partial"),this.path=t,this.segments=e,this.paths=s,this.wildcardCount=a,this.wildcardType=l,this.wildcardIndexes=d,this.pathInfo=c}}function b(t){let e;return y.get(t)??(y.set(t,e=new S(t)),e)}const _=new WeakMap,P=new WeakMap;class v{pathInfo;listIndex;_parentAddress;constructor(t,e){this.pathInfo=t,this.listIndex=e}get parentAddress(){if(void 0!==this._parentAddress)return this._parentAddress;const t=this.pathInfo.parentPathInfo;if(null===t)return null;let e=null;return e=this.pathInfo.segments[this.pathInfo.segments.length-1]===f?this.listIndex?.parentListIndex??null:this.listIndex,this._parentAddress=A(t,e)}}function A(t,e){if(null===e){let e=P.get(t);return void 0!==e||(e=new v(t,null),P.set(t,e)),e}{let n=_.get(e);void 0===n&&(n=new WeakMap,_.set(e,n));let s=n.get(t);return void 0!==s||(s=new v(t,e),n.set(t,s)),s}}Set.prototype.difference||(Set.prototype.difference=function(t){const e=new Set(this);for(const n of t)e.delete(n);return e}),Set.prototype.intersection||(Set.prototype.intersection=function(t){const e=new Set;for(const n of t)this.has(n)&&e.add(n);return e});let $=0;function C(){return`u${($++).toString(36)}`}let k=0;class E{uuid=C();parentListIndex;position;length;_index;_version;_indexes;_listIndexes;constructor(t,e){this.parentListIndex=t,this.position=t?t.position+1:0,this.length=this.position+1,this._index=e,this._version=k}get index(){return this._index}set index(t){this._index=t,this._version=++k,this.indexes[this.position]=t}get version(){return this._version}get dirty(){return null!==this.parentListIndex&&(this.parentListIndex.dirty||this.parentListIndex.version>this._version)}get indexes(){return null===this.parentListIndex?void 0===this._indexes&&(this._indexes=[this._index]):(void 0===this._indexes||this.dirty)&&(this._indexes=[...this.parentListIndex.indexes,this._index],this._version=k),this._indexes}get listIndexes(){return null===this.parentListIndex?void 0===this._listIndexes&&(this._listIndexes=[new WeakRef(this)]):void 0===this._listIndexes&&(this._listIndexes=[...this.parentListIndex.listIndexes,new WeakRef(this)]),this._listIndexes}get varName(){return`$${this.position+1}`}at(t){return t>=0?this.listIndexes[t]?.deref()||null:this.listIndexes[this.listIndexes.length+t]?.deref()||null}}function T(t,e){return new E(t,e)}const M=new WeakMap;function L(t){return M.get(t)||null}const W=new WeakMap,O=Object.freeze([]),D=new Set;function R(t,e,n){const s=Array.isArray(e)&&e.length>0?e:O,o=Array.isArray(n)&&n.length>0?n:O,i=function(t,e){const n=Array.isArray(t)&&t.length>0?t:O,s=Array.isArray(e)&&e.length>0?e:O;let o=W.get(n);return o&&o.get(s)||null}(s,o);if(i)return i;const r=L(s)||[];let a;try{if(0===o.length)return a={oldIndexes:r,newIndexes:[],changeIndexSet:D,deleteIndexSet:new Set(r),addIndexSet:D};let e=L(o);if(0===s.length){if(null===e){e=[];for(let n=0;n<o.length;n++){const s=T(t,n);e.push(s)}}return a={oldIndexes:r,newIndexes:e,changeIndexSet:D,deleteIndexSet:D,addIndexSet:new Set(e)}}if(function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}(s,o))return a={oldIndexes:r,newIndexes:r,changeIndexSet:D,deleteIndexSet:D,addIndexSet:D};const n=new Map;for(let t=0;t<s.length;t++){const e=s[t];let o=n.get(e);o||(o=[],n.set(e,o)),o.push(t)}if(null!==e)return function(t,e,n,s,o){const i=new Set(s),r=new Set(n),a=new Set,l=i.difference(r),d=r.difference(i);for(let t=0;t<e.length;t++){const s=e[t],i=o.get(s),r=i&&i.length>0?i.shift():void 0;if(void 0!==r){const e=n[r];e.index!==t&&a.add(e)}}return{oldIndexes:n,newIndexes:s,changeIndexSet:a,deleteIndexSet:d,addIndexSet:l}}(0,o,r,e,n);e=[];const i=new Set,l=new Set;for(let s=0;s<o.length;s++){const a=o[s],d=n.get(a),c=d&&d.length>0?d.shift():void 0;if(void 0===c){const n=T(t,s);e.push(n),l.add(n)}else{const t=r[c];t.index!==s&&(t.index=s,i.add(t)),e.push(t)}}return a={oldIndexes:r,newIndexes:e,changeIndexSet:i,deleteIndexSet:new Set(r).difference(new Set(e)),addIndexSet:l}}finally{void 0!==a&&(!function(t,e,n){let s=W.get(t);s||(s=new WeakMap,W.set(t,s)),s.set(e,n)}(s,o,a),l=o,null!==(d=a.newIndexes)?M.set(l,d):M.delete(l))}var l,d}const F={};function j(t,e){const n=function(t,e){return`${e}@${t}`}(t,e.path);if(F[n])return F[n];const s=Object.freeze(new B(t,e));return F[n]=s,s}class B{pathInfo;stateName;parentAbsolutePathInfo;constructor(t,e){this.pathInfo=e,this.stateName=t,null===e.parentPathInfo?this.parentAbsolutePathInfo=null:this.parentAbsolutePathInfo=j(t,e.parentPathInfo)}}const z=new WeakMap,q=new WeakMap;class U{absolutePathInfo;listIndex;_parentAbsoluteAddress;constructor(t,e){this.absolutePathInfo=t,this.listIndex=e}get parentAbsoluteAddress(){if(void 0!==this._parentAbsoluteAddress)return this._parentAbsoluteAddress;const t=this.absolutePathInfo.parentAbsolutePathInfo;if(null===t)return null;let e=null;return e=this.absolutePathInfo.pathInfo.segments[this.absolutePathInfo.pathInfo.segments.length-1]===f?this.listIndex?.parentListIndex??null:this.listIndex,this._parentAbsoluteAddress=H(t,e)}}function H(t,e){if(null===e){let e=q.get(t);return void 0!==e||(e=new U(t,null),q.set(t,e)),e}{let n=z.get(e);void 0===n&&(n=new WeakMap,z.set(e,n));let s=n.get(t);return void 0!==s||(s=new U(t,e),n.set(t,s)),s}}const V=new WeakMap;function J(t){return V.get(t)??null}function X(t,e){null===e?V.delete(t):V.set(t,e)}function K(t,e,n,s,o){if(!(e.pathInfo.path in t)){const o=Y(t,e.parentAddress??l(`address.parentAddress is undefined path: ${e.pathInfo.path}`),n,s),i=e.pathInfo.segments[e.pathInfo.segments.length-1];if(i===f){const t=e.listIndex?.index??l(`address.listIndex?.index is undefined path: ${e.pathInfo.path}`);return Reflect.get(o,t)}return Reflect.get(o,i)}if(!o.getterPaths.has(e.pathInfo.path))return Reflect.get(t,e.pathInfo.path);s.pushAddress(e);try{return Reflect.get(t,e.pathInfo.path,n)}finally{s.popAddress()}}function Y(t,e,n,s){!function(t,e){if(t.addressStackLength>0){const n=t.lastAddressStack?.pathInfo??null,s=t.stateElement;null!==n&&s.getterPaths.has(n.path)&&n.path!==e.pathInfo.path&&s.addDynamicDependency(e.pathInfo.path,n.path)}}(s,e);const o=s.stateElement;return e.pathInfo.wildcardCount>0||o.getterPaths.has(e.pathInfo.path)?function(t,e,n,s,o){const i=H(j(o.name,e.pathInfo),e.listIndex),r=J(i);if(null!==r)return r.value;const a=K(t,e,n,s,o);return X(i,{value:a}),a}(t,e,n,s,o):K(t,e,n,s,o)}function G(t,e){if(0===t.addressStackLength)return null;const n=t.lastAddressStack;if(null===n)return null;const s=n.pathInfo.indexByWildcardPath[e];return void 0===s?null:n.listIndex?.at(s)??null}const Q=new WeakMap;function Z(t){return Q.get(t)??[]}function tt(t,e){Q.set(t,e)}const et=new WeakMap;const nt=new WeakMap;function st(t,e){let n,s;if(0===t.wildcardCount||0===e.wildcardCount)return 0;if(1===t.wildcardCount&&e.wildcardCount>0&&e.wildcardPathSet.has(t.path))return 1;t.id<e.id?(n=t,s=e):(n=e,s=t);let o=nt.get(n);if(void 0===o)o=new WeakMap,nt.set(n,o);else{const t=o.get(s);if(void 0!==t)return t}const i=n.wildcardPathSet.intersection(s.wildcardPathSet).size;return o.set(s,i),i}const ot=new WeakMap;function it(t){let e=t;for(;e;){const t=ot.get(e);if(t)return t;e=e.parentNode}return null}function rt(t,e){null!==e?ot.set(t,e):ot.delete(t)}const at=new WeakMap;function lt(t){const e=it(t.node);if(null===e)return null;let n=at.get(e);if(void 0===n)n=new WeakMap,at.set(e,n);else{const e=n.get(t);if(void 0!==e)return e}let s=null;try{const n=st(e.pathInfo,t.statePathInfo);return n>0&&(s=e.listIndex.at(n-1)),s}finally{n.set(t,s)}}const dt=new WeakMap;function ct(t){let e=null;if(e=dt.get(t)||null,null!==e)return e;const n=lt(t);return e=H(t.stateAbsolutePathInfo,n),dt.set(t,e),e}function ut(t){dt.delete(t)}const ft=new WeakMap;function ht(t){return ft.get(t)??[]}const pt=new WeakMap;function mt(t){let e=null;return e=pt.get(t)||null,null===e&&(e=[],pt.set(t,e)),e}function gt(t,e){mt(t).push(e)}function xt(t,e){const n=mt(t),s=n.indexOf(e);-1!==s&&n.splice(s,1)}const wt=new WeakMap;function It(t){wt.delete(t)}const Nt=new WeakMap;function yt(t){return Nt.get(t)??[]}const St=new WeakMap;function bt(t){return St.get(t)??[]}function _t(t,e,n){!function(t,e){const n=bt(t);for(const t of n)rt(t,e)}(t,e);const s=yt(t);for(const t of s){gt(ct(t),t),Be(t,n)}}function Pt(t){const e=yt(t);for(const t of e){xt(ct(t),t),ut(t),It(t)}!function(t){const e=bt(t);for(const t of e)rt(t,null)}(t)}function vt(t){const e=t.node,n=t.replaceNode;e!==n&&null!==e.parentNode&&e.parentNode.replaceChild(n,e)}function At(t,e){let n=t;if(0===e.length)return n;for(let t=0;t<e.length&&(n=n?.childNodes[e[t]]??null,null!==n);t++);return n}function $t(t,e){const n=[];for(const s of e)if("text"!==s.bindingType)n.push({...s,node:t,replaceNode:t});else{const e=document.createTextNode("");n.push({...s,node:t,replaceNode:e})}return n}const Ct=new WeakMap;function kt(t,e){Ct.set(t,e)}const Et=new Set(["if","elseif","else","for"]);function Tt(t){l(`filter ${t} requires at least one option`)}function Mt(t){l(`filter ${t} requires a number as option`)}function Lt(t){l(`filter ${t} requires a number value`)}function Wt(t){l(`filter ${t} requires a date value`)}function Ot(t){return!(!t||isNaN(Number(t)))}const Dt={eq:t=>{const e=t?.[0]??Tt("eq");return t=>"number"==typeof t?(Ot(e)||Mt("eq"),t===Number(e)):t===e},ne:t=>{const e=t?.[0]??Tt("ne");return t=>"number"==typeof t?(Ot(e)||Mt("ne"),t!==Number(e)):t!==e},not:t=>t=>("boolean"!=typeof t&&l(`filter ${"not"} requires a boolean value`),!t),lt:t=>{const e=t?.[0]??Tt("lt");return Ot(e)||Mt("lt"),t=>("number"!=typeof t&&Lt("lt"),t<Number(e))},le:t=>{const e=t?.[0]??Tt("le");return Ot(e)||Mt("le"),t=>("number"!=typeof t&&Lt("le"),t<=Number(e))},gt:t=>{const e=t?.[0]??Tt("gt");return Ot(e)||Mt("gt"),t=>("number"!=typeof t&&Lt("gt"),t>Number(e))},ge:t=>{const e=t?.[0]??Tt("ge");return Ot(e)||Mt("ge"),t=>("number"!=typeof t&&Lt("ge"),t>=Number(e))},inc:t=>{const e=t?.[0]??Tt("inc");return Ot(e)||Mt("inc"),t=>("number"!=typeof t&&Lt("inc"),t+Number(e))},dec:t=>{const e=t?.[0]??Tt("dec");return Ot(e)||Mt("dec"),t=>("number"!=typeof t&&Lt("dec"),t-Number(e))},mul:t=>{const e=t?.[0]??Tt("mul");return Ot(e)||Mt("mul"),t=>("number"!=typeof t&&Lt("mul"),t*Number(e))},div:t=>{const e=t?.[0]??Tt("div");return Ot(e)||Mt("div"),t=>("number"!=typeof t&&Lt("div"),t/Number(e))},mod:t=>{const e=t?.[0]??Tt("mod");return Ot(e)||Mt("mod"),t=>("number"!=typeof t&&Lt("mod"),t%Number(e))},fix:t=>{const e=t?.[0]??"0";return Ot(e)||Mt("fix"),t=>("number"!=typeof t&&Lt("fix"),t.toFixed(Number(e)))},locale:t=>{const e=t?.[0]??a;return t=>("number"!=typeof t&&Lt("locale"),t.toLocaleString(e))},uc:t=>t=>String(t).toUpperCase(),lc:t=>t=>String(t).toLowerCase(),cap:t=>t=>{const e=String(t);return 0===e.length?e:1===e.length?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)},trim:t=>t=>String(t).trim(),slice:t=>{const e=t?.[0]??Tt("slice");return Ot(e)||Mt("slice"),t=>String(t).slice(Number(e))},substr:t=>{const e=t?.[0]??Tt("substr");Ot(e)||Mt("substr");const n=t?.[1]??Tt("substr");return Ot(n)||Mt("substr"),t=>String(t).substr(Number(e),Number(n))},pad:t=>{const e=t?.[0]??Tt("pad");Ot(e)||Mt("pad");const n=t?.[1]??"0";return t=>String(t).padStart(Number(e),n)},rep:t=>{const e=t?.[0]??Tt("rep");return Ot(e)||Mt("rep"),t=>String(t).repeat(Number(e))},rev:t=>t=>String(t).split("").reverse().join(""),int:t=>t=>parseInt(String(t),10),float:t=>t=>parseFloat(String(t)),round:t=>{const e=t?.[0]??"0";return Ot(e)||Mt("round"),t=>{"number"!=typeof t&&Lt("round");const n=Math.pow(10,Number(e));return Math.round(t*n)/n}},floor:t=>{const e=t?.[0]??"0";return Ot(e)||Mt("floor"),t=>{"number"!=typeof t&&Lt("floor");const n=Math.pow(10,Number(e));return Math.floor(t*n)/n}},ceil:t=>{const e=t?.[0]??"0";return Ot(e)||Mt("ceil"),t=>{"number"!=typeof t&&Lt("ceil");const n=Math.pow(10,Number(e));return Math.ceil(t*n)/n}},percent:t=>{const e=t?.[0]??"0";return Ot(e)||Mt("percent"),t=>("number"!=typeof t&&Lt("percent"),`${(100*t).toFixed(Number(e))}%`)},date:t=>{const e=t?.[0]??a;return t=>(t instanceof Date||Wt("date"),t.toLocaleDateString(e))},time:t=>{const e=t?.[0]??a;return t=>(t instanceof Date||Wt("time"),t.toLocaleTimeString(e))},datetime:t=>{const e=t?.[0]??a;return t=>(t instanceof Date||Wt("datetime"),t.toLocaleString(e))},ymd:t=>{const e=t?.[0]??"-";return t=>{t instanceof Date||Wt("ymd");const n=t.getFullYear().toString(),s=(t.getMonth()+1).toString().padStart(2,"0"),o=t.getDate().toString().padStart(2,"0");return`${n}${e}${s}${e}${o}`}},falsy:t=>t=>!1===t||null==t||0===t||""===t||Number.isNaN(t),truthy:t=>t=>!1!==t&&null!=t&&0!==t&&""!==t&&!Number.isNaN(t),defaults:t=>{const e=t?.[0]??Tt("defaults");return t=>!1===t||null==t||0===t||""===t||Number.isNaN(t)?e:t},boolean:t=>t=>Boolean(t),number:t=>t=>Number(t),string:t=>t=>String(t),null:t=>t=>""===t?null:t},Rt=Dt,Ft={input:Dt,output:Rt},jt=(t,e)=>n=>{const s=n[t];return s||l(`filter not found: ${t}`),s(e)};const Bt=new Map;function zt(t,e){const n=Ft[e];return t.map(t=>{const s=t.indexOf("("),o=t.lastIndexOf(")");if(-1!==s&&-1===o&&l(`Invalid filter format: missing closing parenthesis in "${t}"`),-1!==o&&-1===s&&l(`Invalid filter format: missing opening parenthesis in "${t}"`),-1===s){const s=t.trim(),o=`${s}():${e}`;let i=Bt.get(o);return void 0===i&&(i=jt(s,[])(n),Bt.set(o,i)),{filterName:s,args:[],filterFn:i}}{const i=t.substring(s+1,o),r=t.substring(0,s).trim(),a=function(t){const e=[];let n="",s=null;for(let o=0;o<t.length;o++){const i=t[o];s?i===s?s=null:n+=i:'"'===i||"'"===i?s=i:","===i?(e.push(n.trim()),n=""):n+=i}return n.trim()&&e.push(n.trim()),e}(i),l=`${r}(${a.join(",")}):${e}`;let d=Bt.get(l);return void 0===d&&(d=jt(r,a)(n),Bt.set(l,d)),{filterName:r,args:a,filterFn:d}}})}const qt=t=>t.trim(),Ut=new Map;const Ht=new Map;function Vt(t){const e=t.indexOf("|");let n="",s=[],o="",i=[];-1!==e?(n=t.slice(0,e).trim(),o=t.slice(e+1).trim(),Ht.has(o)?i=Ht.get(o):(s=o.split("|").map(qt),i=zt(s,"output"),Ht.set(o,i))):n=t.trim();const[r,a="default"]=n.split("@").map(qt),l=I(r);return{stateName:a,statePathName:r,statePathInfo:l,stateAbsolutePathInfo:j(a,l),outFilters:i}}function Jt(t){const[...e]=t.split(";").map(qt).filter(t=>t.length>0),n=e.map(t=>{const e=t.indexOf(":");-1===e&&l(`Invalid bindText: "${t}". Missing ':' separator between propPart and statePart.`);const n=t.slice(0,e).trim(),s=t.slice(e+1).trim();if("else"===n){const t=I("#else");return{propName:"else",propSegments:["else"],propModifiers:[],statePathName:"#else",statePathInfo:t,stateAbsolutePathInfo:j("",t),stateName:"",inFilters:[],outFilters:[],bindingType:"else"}}if("if"===n||"elseif"===n||"for"===n){return{propName:n,propSegments:[n],propModifiers:[],inFilters:[],...Vt(s),bindingType:n}}{const t=Vt(s),e=function(t){const e=t.indexOf("|");let n="",s=[],o="",i=[];-1!==e?(n=t.slice(0,e).trim(),o=t.slice(e+1).trim(),Ut.has(o)?i=Ut.get(o):(s=o.split("|").map(qt),i=zt(s,"input"),Ut.set(o,i))):n=t.trim();const[r,a]=n.split("#").map(qt),l=r.split(".").map(qt);return{propName:r,propSegments:l,propModifiers:a?a.split(",").map(qt):[],inFilters:i}}(n);return e.propSegments[0].startsWith("on")?{...e,...t,bindingType:"event"}:{...e,...t,bindingType:"prop"}}});if(n.length>1){n.some(t=>Et.has(t.bindingType))&&l(`Invalid bindText: "${t}". 'if', 'elseif', 'else', and 'for' bindings must be single binding.`)}return n}const Xt=new WeakMap,Kt=new Set([e,n,s,o,i]),Yt=new RegExp("^\\s*@@\\s*(.*?)\\s*:\\s*(.+?)\\s*$");function Gt(t){const n=Xt.get(t);if("string"==typeof n)return n;if(t.nodeType!==Node.COMMENT_NODE)return null;const s=t.data.trim(),o=Yt.exec(s);if(null===o)return null;const i=o[1]||e;return Kt.has(i)?(Xt.set(t,o[2]),o[2]):null}const Qt=new Map;function Zt(t,e,n){if(null===n)Qt.delete(t);else{Qt.set(t,n);const s=n.parseBindTextResult,o=c(e,s.stateName);null===o&&l(`State element with name "${s.stateName}" not found for fragment info.`),o.setPathInfo(s.statePathName,s.bindingType);for(const t of n.nodeInfos)for(const n of t.parseBindTextResults){const t=c(e,n.stateName);null===t&&l(`State element with name "${n.stateName}" not found for fragment info node.`),t.setPathInfo(n.statePathName,n.bindingType)}}}function te(t){return Qt.get(t)||null}function ee(e){if(e.nodeType===Node.ELEMENT_NODE){return Jt(e.getAttribute(t)||"")}if(e.nodeType===Node.COMMENT_NODE){const t=Gt(e);null===t&&l("Comment node binding text not found.");const n=te(t);let s=n?.parseBindTextResult??null,o=null;return null===s?(s={propName:"textContent",propSegments:["textContent"],propModifiers:[],inFilters:[],...Vt(t),bindingType:"text"},o=null):o=t,[{...s,uuid:o}]}return[]}function ne(e){const n=[],s=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT,{acceptNode(e){if(e.nodeType===Node.ELEMENT_NODE){return e.hasAttribute(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}return null!==Gt(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;s.nextNode();)n.push(s.currentNode);return n}const se=new WeakMap;function oe(t){let e,n=se.get(t)||null;if(null!==n)return n;const s=new Promise(t=>{e=t});return n={promise:s,resolve:e},se.set(t,n),n}function ie(t){oe(t).resolve()}const re=new WeakSet;const ae=new Map,le=new Map;function de(t){if(!t.propName.startsWith("on"))return!1;const e=function(t){const e=t.propModifiers.filter(t=>"prevent"===t||"stop"===t).sort().join(",");return`${t.stateName}::${t.statePathName}::${e}`}(t);let n=ae.get(e);var s,o,i;void 0===n&&(s=t.stateName,o=t.statePathName,i=t.propModifiers,n=t=>{i.includes("prevent")&&t.preventDefault(),i.includes("stop")&&t.stopPropagation();const e=t.target,n=c(e.getRootNode(),s);null===n&&l(`State element with name "${s}" not found for event handler.`);const r=it(e);n.createStateAsync("writable",async e=>{e.$$setLoopContext(r,()=>{const n=e[o];return"function"!=typeof n&&l(`Handler "${o}" is not a function on state "${s}".`),Reflect.apply(n,e,[t,...r?.listIndex.indexes??[]])})})},ae.set(e,n));const r=t.propName.slice(2);t.node.addEventListener(r,n);let a=le.get(e);return void 0===a?(a=new Set([t]),le.set(e,a)):a.add(t),!0}const ce=new Set(["radio","checkbox"]),ue=new Set(["value","valueAsNumber","valueAsDate"]);const fe=new Map,he=new Map;function pe(t){if(function(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const n=t,s=n.tagName.toLowerCase();if("input"===s){const t=(n.getAttribute("type")||"text").toLowerCase();if("button"===t)return!1;if(ce.has(t)&&"checked"===e)return!0;if(ue.has(e))return!0}return"select"===s&&"value"===e||"textarea"===s&&"value"===e}(t.node,t.propName)&&-1===t.propModifiers.indexOf("ro")){const i=function(t){let e="select"===t.node.tagName.toLowerCase()?"change":"input";for(const n of t.propModifiers)n.startsWith("on")&&(e=n.slice(2));return e}(t),r=function(t,e){const n=t.inFilters.map(t=>t.filterName+"("+t.args.join(",")+")").join("|");return`${t.stateName}::${t.propName}::${t.statePathName}::${e}::${n}`}(t,i);let a=fe.get(r);void 0===a&&(e=t.stateName,n=t.propName,s=t.statePathName,o=t.inFilters,a=t=>{const i=t.target;if(void 0===i)return void console.warn("[@wcstack/state] event.target is undefined.");if(!(n in i))return void console.warn(`[@wcstack/state] Property "${n}" does not exist on target element.`);let r=i[n];for(const t of o)r=t.filterFn(r);const a=c(i.getRootNode(),e);null===a&&l(`State element with name "${e}" not found for two-way binding.`);const d=it(i);a.createState("writable",t=>{t.$$setLoopContext(d,()=>{t[s]=r})})},fe.set(r,a)),t.node.addEventListener(i,a);let d=he.get(r);return void 0===d?(d=new Set([t]),he.set(r,d)):d.add(t),!0}var e,n,s,o;return!1}function me(t){for(const e of t)vt(e),de(e)||pe(e)}function ge(t,e){const[n,s]=function(t){const e=ne(t),n=[];for(const t of e)if(!re.has(t)){re.add(t);const e=$t(t,ee(t));kt(t,e),ie(t),n.push(...e)}return[e,n]}(t);for(const t of n)rt(t,e);me(s);for(const t of s){gt(ct(t),t);const e=c(t.replaceNode.getRootNode(),t.stateName);null===e&&l(`State element with name "${t.stateName}" not found for binding.`),"event"!==t.bindingType&&e.setPathInfo(t.statePathName,t.bindingType)}ze(s)}function xe(t,e){const[n,s]=function(t,e){const n=[],s=[];for(const o of e){const e=At(t,o.nodePath);if(null===e&&l(`Node not found by path [${o.nodePath.join(", ")}] in fragment.`),!re.has(e)){re.add(e);const t=$t(e,o.parseBindTextResults);kt(e,t),ie(e),s.push(...t),n.push(e)}}return[n,s]}(t,e);return me(s),{nodes:n,bindingInfos:s}}const we=new WeakMap;function Ie(t){return we.get(t)||[]}const Ne=new Set(["if","elseif","else","for"]);class ye{_content;_childNodeArray=[];_firstNode=null;_lastNode=null;_mounted=!1;constructor(t){this._content=t,this._childNodeArray=Array.from(this._content.childNodes),this._firstNode=this._childNodeArray.length>0?this._childNodeArray[0]:null,this._lastNode=this._childNodeArray.length>0?this._childNodeArray[this._childNodeArray.length-1]:null}get firstNode(){return this._firstNode}get lastNode(){return this._lastNode}get mounted(){return this._mounted}appendTo(t){for(const e of this._childNodeArray)t.appendChild(e);this._mounted=!0}mountAfter(t){const e=t.parentNode,n=t.nextSibling;if(e)for(const t of this._childNodeArray)e.insertBefore(t,n);this._mounted=!0}unmount(){for(const t of this._childNodeArray)null!==t.parentNode&&t.parentNode.removeChild(t);const t=yt(this);for(const e of t){if(Ne.has(e.bindingType)){const t=Ie(e.node);for(const e of t)e.unmount()}It(e),ut(e)}this._mounted=!1}}function Se(t){void 0!==t.uuid&&null!==t.uuid||l("BindingInfo.uuid is null.");const e=te(t.uuid);e||l(`Fragment with UUID "${t.uuid}" not found.`);const n=document.importNode(e.fragment,!0),s=xe(n,e.nodeInfos),o=new ye(n);!function(t,e){Nt.set(t,e)}(o,s.bindingInfos);const i=[];for(const t of s.bindingInfos)t.statePathName in m&&i.push(t);return function(t,e){ft.set(t,e)}(o,i),function(t,e){St.set(t,e)}(o,s.nodes),function(t,e){const n=we.get(t);n?n.push(e):we.set(t,[e])}(t.node,o),o}const be=new WeakMap;function _e(t,e){null===e?be.delete(t):be.set(t,e)}function Pe(t){return be.get(t)||null}const ve=new WeakMap,Ae=new WeakMap,$e=new WeakMap,Ce=new WeakMap;function ke(t){return $e.get(t.node)||[]}function Ee(t,e){const n=$e.get(t.node);void 0===n?$e.set(t.node,[e]):n.push(e)}function Te(t,e){let n=Ae.get(t);if(void 0===n)return null;const s=n.get(e);return void 0===s?null:s}function Me(t,e,n){let s=Ae.get(t);if(void 0===s){if(null===n)return;s=new WeakMap,Ae.set(t,s)}null===n?s.delete(e):s.set(e,n)}const Le=new WeakMap;function We(t,e,n){const s=t.node.isConnected,o=Boolean(n);let i=Ie(t.node);0===i.length&&(i=[Se(t)]);const r=i[0];try{if(o||(r.unmount(),Pt(r)),o){r.mountAfter(t.node);_t(r,it(t.node),e)}}finally{Le.set(t.node,s)}}function Oe(t,e,n){const s=t.node,o=t.propSegments;if(1===o.length){const t=o[0];return void(s[t]!==n&&(s[t]=n))}let i=s[o[0]];for(let t=1;t<o.length-1;t++){const e=o[t];if(null==i)return;i=i[e]}i[o[o.length-1]]!==n&&(i[o[o.length-1]]=n)}function De(t,e){const n=function(t){let e=null;if(e=wt.get(t)||null,null!==e)return e;if(t.statePathInfo.wildcardCount>0){const n=lt(t);null===n&&l(`Cannot resolve state address for binding with wildcard statePathName "${t.statePathName}" because list index is null.`),e=A(t.statePathInfo,n)}else e=A(t.statePathInfo,null);return wt.set(t,e),e}(e);if(n.pathInfo.path in m){const t=it(e.node);return null===t&&l(`ListIndex not found for binding: ${e.statePathName}`),function(t,e){null===t.listIndex&&l("ListIndex not found for loopContext:");const n=m[e];void 0===n&&l(`Invalid index name: ${e}`);const s=t.listIndex.at(n);return null===s&&l(`Index not found at position ${n} for loopContext:`),s.index}(t,n.pathInfo.path)}return t.$$getByAddress(n)}const Re={class:function(t,e,n){const s=t.node,o=t.propSegments[1];"boolean"!=typeof n&&l("Invalid value for class application: expected boolean, got "+typeof n),s.classList.toggle(o,n)},attr:function(t,e,n){const s=t.node,o=t.propSegments[1];s.getAttribute(o)!==n&&s.setAttribute(o,n)},style:function(t,e,n){const s=t.propSegments[1],o=t.node.style;o[s]!==n&&(o[s]=n)}},Fe={text:function(t,e,n){t.replaceNode.nodeValue!==n&&(t.replaceNode.nodeValue=n)},for:function(t,e,n){const s=t.statePathInfo,o=lt(t),i=ct(t),r=Z(i),a=R(o,r,n);if(e.newListValueByAbsAddress.set(i,Array.isArray(n)?n:[]),Array.isArray(r)&&r.length===a.deleteIndexSet.size&&a.deleteIndexSet.size>0&&null!==t.node.parentNode){let e=Ce.get(t.node);if(void 0===e){const n=ve.get(t.node)||t.node;e=function(t,e){let n=t.previousSibling,s=e.nextSibling,o=!0;for(;null!==n;){if(n.nodeType===Node.ELEMENT_NODE||n.nodeType===Node.TEXT_NODE&&""!==(n.textContent?.trim()??"")){o=!1;break}n=n.previousSibling}for(;null!==s;){if(s.nodeType===Node.ELEMENT_NODE||s.nodeType===Node.TEXT_NODE&&""!==(s.textContent?.trim()??"")){o=!1;break}s=s.nextSibling}return o}(t.node,n),Ce.set(t.node,e)}if(e){const e=t.node.parentNode;e.textContent="",e.appendChild(t.node)}}for(const e of a.deleteIndexSet){const n=Te(t.node,e);null!==n&&(n.unmount(),Pt(n),Ee(t,n),Me(t.node,e,null))}let d=t.node;const c=I(s.path+"."+f),u=e.stateElement.loopContextStack;let h=null;a.newIndexes.length==a.addIndexSet.size&&a.newIndexes.length>0&&d.isConnected&&(h=document.createDocumentFragment(),_e(h,e.rootNode));for(const n of a.newIndexes){let o;if(a.addIndexSet.has(n)){const i=A(c,n);u.createLoopContext(i,n=>{const s=ke(t);o=s.pop(),void 0===o&&(o=Se(t)),null!==h?o.appendTo(h):d.nextSibling!==o.firstNode&&o.mountAfter(d),_t(o,n,e)}),void 0===o&&l(`Content not found for ListIndex: ${n.index} at path "${s.path}"`)}else{if(o=Te(t.node,n),a.changeIndexSet.has(n)){const t=ht(o);for(const n of t)Be(n,e)}null===o&&l(`Content not found for ListIndex: ${n.index} at path "${s.path}"`),d.nextSibling!==o.firstNode&&o.mountAfter(d)}d=o.lastNode||d,Me(t.node,n,o)}ve.set(t.node,d),null!==h&&(t.node.parentNode.insertBefore(h,t.node.nextSibling),_e(h,null))},if:We,else:We,elseif:We};function je(t,e){const n=function(t,e){let n=t;for(const t of e)n=t.filterFn(n);return n}(De(e.state,t),t.outFilters);let s=Fe[t.bindingType];if(void 0===s){const e=t.propSegments[0];s=Re[e],void 0===s&&(s=Oe)}s(t,e,n)}function Be(t,e){if(e.appliedBindingSet.has(t))return;if(e.appliedBindingSet.add(t),"event"===t.bindingType)return;if(function(t){let e=et.get(t);if(void 0!==e)return e;try{if(t.nodeType!==Node.ELEMENT_NODE)return e=!1;const n=t;return e=!!n.tagName.includes("-")||!(!n.hasAttribute("is")||!n.getAttribute("is")?.includes("-"))}finally{et.set(t,e??!1)}}(t.replaceNode)){const e=t.replaceNode;if(void 0===customElements.get(e.tagName.toLowerCase()))return}let n=t.replaceNode.getRootNode();if(n instanceof DocumentFragment&&!(n instanceof ShadowRoot)&&(n=Pe(n),null===n&&l("Root node for fragment not found for binding.")),t.stateName!==e.stateName||n!==e.rootNode){const s=c(n,t.stateName);null===s&&l(`State element with name "${t.stateName}" not found for binding.`),s.createState("readonly",o=>{const i={stateName:t.stateName,rootNode:n,stateElement:s,state:o,appliedBindingSet:e.appliedBindingSet,newListValueByAbsAddress:e.newListValueByAbsAddress};je(t,i)})}else je(t,e)}function ze(t){let e=0;const n=new Set,s=new Map;for(;e<t.length;){let o=t[e];const i=o.stateName;let r=o.replaceNode.getRootNode();r instanceof DocumentFragment&&!(r instanceof ShadowRoot)&&(r=Pe(r),null===r&&l("Root node for fragment not found for binding."));const a=c(r,i);null===a&&l(`State element with name "${i}" not found for binding.`),a.createState("readonly",l=>{const d={rootNode:r,stateName:i,stateElement:a,state:l,appliedBindingSet:n,newListValueByAbsAddress:s};for(;;){Be(o,d),e++;const n=t[e];if(!n)break;const s=n.replaceNode.getRootNode();if(n.stateName!==i||s!==d.rootNode)break;o=n}})}for(const[t,e]of s.entries())tt(t,e)}const qe=new class{_queueAbsoluteAddresses=[];constructor(){}enqueueAbsoluteAddress(t){const e=0===this._queueAbsoluteAddresses.length;this._queueAbsoluteAddresses.push(t),e&&queueMicrotask(()=>{const t=this._queueAbsoluteAddresses;this._queueAbsoluteAddresses=[],this._applyChange(t)})}testApplyChange(t){this._applyChange(t)}_applyChange(t){const e=new Set(t),n=[];for(const t of e){const e=mt(t);n.push(...e)}ze(n)}};function Ue(){return qe}const He=new WeakMap;function Ve(t,e){null===e?He.delete(t):He.set(t,e)}function Je(t,e,n){const s=I(t.wildcardParentPaths[e]),o=j(t.stateName,s),i=A(s,n),r=Z(H(o,n)),a=t.stateProxy.$$getByAddress(i),l=function(t,e){switch(e){case"old":return t.oldIndexes;case"new":return t.newIndexes;case"add":return t.addIndexSet;case"change":return t.changeIndexSet;case"delete":return t.deleteIndexSet;default:return[]}}(R(i.listIndex,r,a),t.searchType);if(e===t.wildcardPaths.length-1)t.targetListIndexes.push(...l);else for(const n of l)Je(t,e+1,n)}function Xe(t,e,n,s,o,i,r,a){const d={stateName:t,staticMap:n,dynamicMap:s,result:new Set,listPathSet:o,visited:new Set,stateProxy:i,searchType:r};return function(t,e,n){const s=[{address:e,depth:0}];for(;s.length>0;){const{address:e,depth:o}=s.pop();if(o>1e3&&l(`Maximum dependency depth of 1000 exceeded. Possible circular dependency detected at path: ${e.pathInfo.path}`),t.visited.has(e))continue;t.visited.add(e),n(e);const i=e.pathInfo.path,r=o+1,a=[],d=t.staticMap.get(i);if(d)for(const n of d){const s=I(n);if(t.listPathSet.has(i)&&s.lastSegment===f){const n=t.stateProxy.$$getByAddress(e),o=Z(H(j(t.stateName,e.pathInfo),e.listIndex)),i=R(e.listIndex,o,n);for(const e of i.newIndexes){const n=A(s,e);t.result.add(n),a.push({address:n,depth:r})}}else{const n=A(s,e.listIndex);t.result.add(n),a.push({address:n,depth:r})}}const c=t.dynamicMap.get(i);if(c)for(const n of c){const s=I(n),o=[];if(s.wildcardCount>0){const n=st(e.pathInfo,s);if(s.wildcardCount-n>=1){let i;n>0?(null===e.listIndex&&l(`Cannot expand dynamic dependency with wildcard for non-list address: ${e.pathInfo.path}`),i=e.listIndex.at(n-1)):i=null;const r={stateName:t.stateName,targetListIndexes:[],wildcardPaths:s.wildcardPaths,wildcardParentPaths:s.wildcardParentPaths,stateProxy:t.stateProxy,searchType:t.searchType};Je(r,n,i),o.push(...r.targetListIndexes)}else{null===e.listIndex&&l(`Cannot expand dynamic dependency with wildcard for non-list address: ${e.pathInfo.path}`);const t=e.listIndex.at(n-1);o.push(t)}}else o.push(null);for(const e of o){const n=A(s,e);t.result.add(n),a.push({address:n,depth:r})}}for(let t=a.length-1;t>=0;t--)s.push(a[t])}}(d,e,a),Array.from(d.result)}function Ke(t,e,n,s,o,i){try{if(!(e.pathInfo.path in t)){const n=Y(t,e.parentAddress??l(`address.parentAddress is undefined path: ${e.pathInfo.path}`),o,i),r=e.pathInfo.segments[e.pathInfo.segments.length-1];if(r===f){const t=e.listIndex?.index??l(`address.listIndex?.index is undefined path: ${e.pathInfo.path}`);return Reflect.set(n,t,s)}return Reflect.set(n,r,s)}if(!i.stateElement.setterPaths.has(e.pathInfo.path))return Reflect.set(t,e.pathInfo.path,s);i.pushAddress(e);try{return Reflect.set(t,e.pathInfo.path,s,o)}finally{i.popAddress()}}finally{const t=Ue();t.enqueueAbsoluteAddress(n),Xe(i.stateName,e,i.stateElement.staticDependency,i.stateElement.dynamicDependency,i.stateElement.listPaths,o,"new",n=>{if(n===e)return;const s=H(j(i.stateName,n.pathInfo),n.listIndex);X(s,null),t.enqueueAbsoluteAddress(s)})}}function Ye(t,e,n,s,o,i){let r=e.parentAddress??l(`address.parentAddress is undefined path: ${e.pathInfo.path}`),a=function(t){return He.get(t)??null}(r);if(null===a){const e=Y(t,r,o,i)??[],n=L(e)??[];a={value:[...e],listIndexes:[...n]},Ve(r,a)}try{return Ke(t,e,n,s,o,i)}finally{const n=a.value.indexOf(s),l=Y(t,r,o,i)??[],d=Array.isArray(l)?L(l)??[]:[],c=e.listIndex.index,u=-1!==n?a.listIndexes[n]:T(r.listIndex,-1);d[c]=u;if(new Set(l).size===a.value.length){for(let t=0;t<d.length;t++)d[t].index=t;Ve(r,null)}}}function Ge(t,e,n,s,o){const i=o.stateElement,r=i.elementPaths.has(e.pathInfo.path),a=e.pathInfo.wildcardCount>0||i.getterPaths.has(e.pathInfo.path),l=H(j(i.name,e.pathInfo),e.listIndex);try{return r?Ye(t,e,l,n,s,o):Ke(t,e,l,n,s,o)}finally{if(a){const t=J(l);null===t?X(l,{value:n}):t.value=n}}}function Qe(t,e,n,s){return(e,o,i)=>{const r=I(e);if(s.addressStackLength>0){const t=s.lastAddressStack?.pathInfo??null,e=s.stateElement;null!==t&&t.path!==r.path&&e.getterPaths.has(t.path)&&e.addDynamicDependency(r.path,t.path)}r.wildcardParentPathInfos.length>o.length&&l(`indexes length is insufficient: ${e}`);let a=null;for(let e=0;e<r.wildcardParentPathInfos.length;e++){const i=r.wildcardParentPathInfos[e],d=A(i,a),c=L(Y(t,d,n,s));null==c&&l(`ListIndexes not found: ${i.path}`);a=c[o[e]]??l(`ListIndex not found: ${i.path}`)}const d=A(r,a);if(!(void 0!==i))return Y(t,d,n,s);Ge(t,d,i,n,s)}}const Ze=new WeakMap;function tn(t,e,n,s){const o=e.pathInfo;switch(e.wildcardType){case"none":return null;case"context":return G(s,o.wildcardPaths.at(-1)??l(`lastWildcardPath is null: ${e.pathInfo.path}`))??l(`ListIndex not found: ${e.pathInfo.path}`);case"all":{let o=null;for(let i=0;i<e.pathInfo.wildcardCount;i++){const r=e.pathInfo.wildcardParentPathInfos[i]??l(`wildcardParentPathInfo is null: ${e.pathInfo.path}`);o=(L(Y(t,A(r,o),n,s))??l(`ListIndex not found: ${r.path}`))[e.wildcardIndexes[i]??l(`wildcardIndex is null: ${e.pathInfo.path}`)]??l(`ListIndex not found: ${r.path}`)}return o}case"partial":l(`Partial wildcard type is not supported yet: ${e.pathInfo.path}`)}}function en(t,e,n){void 0!==t.loopContext&&l("already in loop context"),t.setLoopContext(e);try{t.pushAddress(e);try{return n()}finally{t.popAddress()}}finally{t.clearLoopContext()}}function nn(t,e,n,s){const o=m[e];if(void 0!==o){0===s.addressStackLength&&l(`No active state reference to get list index for "${e.toString()}".`);const t=s.lastAddressStack?.listIndex;return t?.indexes[o]??l(`ListIndex not found: ${e.toString()}`)}if("string"==typeof e){if("$stateElement"===e)return s.stateElement;if("$$setLoopContextAsync"===e)return(t,e=async()=>{})=>async function(t,e,n){return await en(t,e,n)}(s,t,e);if("$$setLoopContext"===e)return(t,e=()=>{})=>function(t,e,n){return en(t,e,n)}(s,t,e);if("$$getByAddress"===e)return e=>Y(t,e,n,s);if("$getAll"===e)return(e,o)=>function(t,e,n,s){const o=Qe(t,0,n,s);return(e,i)=>{const r=new Map,a=I(e);if(s.addressStackLength>0){const t=s.lastAddressStack?.pathInfo??null,e=s.stateElement;null!==t&&t.path!==a.path&&e.getterPaths.has(t.path)&&e.addDynamicDependency(a.path,t.path)}if(void 0===i){for(let t=0;t<a.wildcardParentPathInfos.length;t++){const e=a.wildcardParentPathInfos[t],n=G(s,e.path);if(n){i=n.indexes;break}}void 0===i&&(i=[])}const d=(e,o,i,a,c,u,f)=>{const h=e[o]??null;if(null===h)return void f.push(u);const p=A(h,i),m=Ze.get(p),g=Y(t,p,n,s),x=R(i,m,g).newIndexes,w=a[c]??null;if(r.set(p,g),null===w)for(let t=0;t<x.length;t++){const n=x[t];d(e,o+1,n,a,c+1,u.concat(n.index),f)}else{const t=x[w]??l(`ListIndex not found: ${h.path}`);o+1<e.length?d(e,o+1,t,a,c+1,u.concat(t.index),f):f.push(u.concat(t.index))}},c=[];d(a.wildcardParentPathInfos,0,null,i,0,[],c);const u=[];for(let t=0;t<c.length;t++)u.push(o(a.path,c[t]));for(const[t,e]of r.entries())Ze.set(t,e);return u}}(t,0,n,s)(e,o);if("$postUpdate"===e)return e=>function(t,e,n,s){const o=s.stateElement;return e=>{const i=b(e),r=tn(t,i,n,s),a=A(i.pathInfo,r),l=H(j(o.name,a.pathInfo),a.listIndex),d=Ue();d.enqueueAbsoluteAddress(l),Xe(s.stateName,a,s.stateElement.staticDependency,s.stateElement.dynamicDependency,s.stateElement.listPaths,n,"new",t=>{const e=H(j(s.stateName,t.pathInfo),t.listIndex);X(e,null),d.enqueueAbsoluteAddress(e)})}}(t,0,n,s)(e);if("$resolve"===e)return(e,o,i)=>Qe(t,0,n,s)(e,o,i);if("$trackDependency"===e)return t=>function(t,e,n,s){return t=>{0===s.addressStackLength&&l(`No active state reference to track dependency for path "${t}".`);const e=s.lastAddressStack?.pathInfo??l("Internal error: lastAddressStack is null"),n=s.stateElement;s.stateElement.getterPaths.has(e.path)&&e.path!==t&&n.addDynamicDependency(t,e.path)}}(0,0,0,s)(t);const o=b(e),i=tn(t,o,n,s),r=A(o.pathInfo,i);return Y(t,r,n,s)}if("symbol"==typeof e)return Reflect.get(t,e,n)}class sn{_stateElement;_stateName;_addressStack=Array(h).fill(void 0);_addressStackIndex=-1;_loopContext;_mutability;constructor(t,e,n){this._stateName=e;const s=c(t,this._stateName);null===s&&l(`StateHandler: State element with name "${this._stateName}" not found.`),this._stateElement=s,this._mutability=n}get stateName(){return this._stateName}get stateElement(){return this._stateElement}get lastAddressStack(){let t;return this._addressStackIndex>=0&&(t=this._addressStack[this._addressStackIndex]),void 0===t&&l("Last address stack is undefined."),t}get addressStackLength(){return this._addressStackIndex+1}get loopContext(){return this._loopContext}pushAddress(t){this._addressStackIndex++,this._addressStackIndex>=h&&l("Exceeded maximum address stack depth of 128. Possible infinite loop."),this._addressStack[this._addressStackIndex]=t}popAddress(){if(this._addressStackIndex<0)return null;const t=this._addressStack[this._addressStackIndex];return void 0===t&&l(`Address stack at index ${this._addressStackIndex} is undefined.`),this._addressStack[this._addressStackIndex]=void 0,this._addressStackIndex--,t}setLoopContext(t){this._loopContext=t}clearLoopContext(){this._loopContext=void 0}get(t,e,n){return nn(t,e,n,this)}set(t,e,n,s){return"readonly"===this._mutability&&l(`State "${this._stateName}" is readonly.`),function(t,e,n,s,o){if("string"==typeof e){const i=b(e),r=tn(t,i,s,o);return Ge(t,A(i.pathInfo,r),n,s,o)}return Reflect.set(t,e,n,s)}(t,e,n,s,this)}has(t,e){return Reflect.has(t,e)}}const on=/\{\{\s*(.+?)\s*\}\}/g,rn=new Set(["SCRIPT","STYLE"]);function an(t){!function(t){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT),n=[];for(;e.nextNode();)n.push(e.currentNode);for(const t of n)t.parentElement&&rn.has(t.parentElement.tagName)||ln(t)}(t);const e=Array.from(t.querySelectorAll("template"));for(const t of e)if("http://www.w3.org/2000/svg"===t.namespaceURI){const e=document.createElement("template"),n=Array.from(t.childNodes);for(let t=0;t<n.length;t++){const s=n[t];e.content.appendChild(s)}for(const n of t.attributes)e.setAttribute(n.name,n.value);t.replaceWith(e),an(e.content)}else an(t.content)}function ln(t){const e=t.data;if(on.lastIndex=0,!on.test(e))return;on.lastIndex=0;const n=document.createDocumentFragment();let s,o=0;for(;null!==(s=on.exec(e));){s.index>o&&n.appendChild(document.createTextNode(e.slice(o,s.index)));const t=s[1];n.appendChild(document.createComment(`@@: ${t}`)),o=s.index+s[0].length}o<e.length&&n.appendChild(document.createTextNode(e.slice(o))),t.parentNode.replaceChild(n,t)}let dn;const cn=/^(\s*@@\s*(?:.*?)\s*:\s*)(.+?)(\s*)$/;function un(t,e){const n=e+"."+f,s=t.indexOf("|"),o=t.indexOf("@");let i,r;if(-1!==s?(i=t.slice(0,s).trim(),r=t.slice(s)):-1!==o?(i=t.slice(0,o).trim(),r=t.slice(o)):(i=t.trim(),r=""),"."===i)i=n;else{if(!i.startsWith("."))return t;i=n+"."+i.slice(1)}return r.length>0?i+r:i}function fn(t,e){const n=cn.exec(t);if(null===n)return t;const s=n[1],o=n[2],i=n[3];return s+un(o,e)+i}function hn(t,e){const n=t.split(";");let s=!1;const o=n.map(t=>{const n=t.trim();if(0===n.length)return t;const o=n.indexOf(":");if(-1===o)return t;const i=n.slice(0,o).trim(),r=n.slice(o+1).trim(),a=un(r,e);return a!==r?(s=!0,`${i}: ${a}`):t});return s?o.join(";"):t}function pn(t,e){return hn(t,e)}function mn(t){let e=t;const n=[];for(;null!==e.parentNode;){const t=Array.from(e.parentNode.childNodes).indexOf(e);n.unshift(t),e=e.parentNode}return n}function gn(t){const e=[],n=ne(t);for(const t of n){const n=ee(t);e.push({nodePath:mn(t),parseBindTextResults:n})}return e}const xn=new Map([["for",n],["if",s],["elseif",o],["else",i]]),wn=function(){if(dn)return dn;const t=[],e=jt("not",t)(Rt);return dn={filterName:"not",args:t,filterFn:e},dn}();function In(t,e){const n=e.outFilters;return{...e,outFilters:[...n,wn],bindingType:t}}function Nn(e,n,s,o){!function(t){const e=Array.from(t.childNodes);for(const n of e)n.nodeType===Node.TEXT_NODE&&""===(n.textContent||"").trim()&&t.removeChild(n)}(n),"string"==typeof o&&function(e,n){const s=t,o=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT|NodeFilter.SHOW_ELEMENT);for(;o.nextNode();){const t=o.currentNode;if(t.nodeType===Node.COMMENT_NODE){const e=t;e.data=fn(e.data,n);continue}const e=t;if(e instanceof HTMLTemplateElement)continue;const i=e.getAttribute(s);if(null!==i){const t=hn(i,n);t!==i&&e.setAttribute(s,t)}}}(n,o),yn(e,n,o);return{fragment:n,parseBindTextResult:s,nodeInfos:gn(n)}}function yn(e,n,s){const o=i,r=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,{acceptNode(e){const n=e;if("template"===n.tagName.toLowerCase()){if((n.getAttribute(t)||"").length>0)return NodeFilter.FILTER_ACCEPT}return NodeFilter.FILTER_SKIP}});let a=null;const d=[],c=[];for(;r.nextNode();){const t=r.currentNode;c.push(t)}for(const n of c){let i=n.getAttribute(t)||"";"string"==typeof s&&(i=pn(i,s));let r=Jt(i)[0];const c=xn.get(r.bindingType);if(void 0===c)continue;const u=r.bindingType,f=n.content,h=C();let p=null;const m="for"===u?r.statePathName:s;if("else"===u){null===a&&l("'else' binding found without preceding 'if' or 'elseif' binding."),r=In("else",a.parseBindTextResult),p=Nn(e,f,r,m),Zt(h,e,p);const t=d.at(-1),s=document.createComment(`@@${c}:${h}`);void 0!==t?(n.remove(),t.fragment.appendChild(s),t.nodeInfos.push({nodePath:mn(s),parseBindTextResults:ee(s)})):n.replaceWith(s)}else if("elseif"===u){null===a&&l("'elseif' binding found without preceding 'if' or 'elseif' binding."),p=Nn(e,f,r,m),Zt(h,e,p);const t=document.createComment(`@@${c}:${h}`),s=C(),i={fragment:document.createDocumentFragment(),parseBindTextResult:In("else",a.parseBindTextResult),nodeInfos:[]};i.fragment.appendChild(t),i.nodeInfos.push({nodePath:mn(t),parseBindTextResults:ee(t)}),Zt(s,e,i);const u=d.at(-1);d.push(i);const g=document.createComment(`@@${o}:${s}`);void 0!==u?(n.remove(),u.fragment.appendChild(g),u.nodeInfos.push({nodePath:mn(g),parseBindTextResults:ee(g)})):n.replaceWith(g)}else{p=Nn(e,f,r,m),Zt(h,e,p);const t=document.createComment(`@@${c}:${h}`);n.replaceWith(t)}"if"===u?(d.length=0,a=p):"elseif"===u?a=p:"else"===u&&(a=null,d.length=0)}}async function Sn(t){const e=t.querySelectorAll(r.state),n=[];await customElements.whenDefined(r.state);for(const t of e){const e=t;n.push(e.initializePromise)}await Promise.all(n)}const bn=t=>{const e=c(t.replaceNode.getRootNode(),t.stateName);null===e&&l(`State element with name "${t.stateName}" not found for binding.`);const n=t.statePathName;return()=>{let s;const o=it(t.node);return e.createState("readonly",t=>{t.$$setLoopContext(o,()=>{s=t[n]})}),s}},_n=t=>{const e=c(t.replaceNode.getRootNode(),t.stateName);null===e&&l(`State element with name "${t.stateName}" not found for binding.`);const n=t.statePathName;return s=>{const o=it(t.node);e.createState("writable",t=>{t.$$setLoopContext(o,()=>{t[n]=s})})}};class Pn{constructor(){}$$bind(t){const e=t.propSegments.slice(1).join(".");Object.defineProperty(this,e,{get:bn(t),set:_n(t),enumerable:!0,configurable:!0})}}const vn=(t,e)=>n=>{t.createState("readonly",t=>{t.$postUpdate(e)})};class An{constructor(){}$$bind(t,e){const n=e.propSegments.slice(1).join(".");Object.defineProperty(this,n,{get:()=>{},set:vn(t,n),enumerable:!0,configurable:!0})}}const $n=t=>()=>t,Cn=(t,e)=>()=>t[e],kn=(t,e)=>n=>{t[e]=n};async function En(e,n,s,o){null===n.shadowRoot&&l("Component has no shadow root."),n.hasAttribute(t)||l(`Component has no "${t}" attribute for state binding.`);const i=n.shadowRoot;e.setInitialState(o),await Sn(i),an(i),yn(i,i),await async function(t){const e=oe(t);await e.promise}(n);const r=(a=n,Ct.get(a)||null);var a;null===r&&l("Bindings not found for component node.");const d=new An,c=new Pn;for(const t of r){d.$$bind(e,t),c.$$bind(t);const n=t.propSegments[0],o=t.propSegments.slice(1).join(".");s!==n&&l(`Binding prop "${n}" does not match stateProp "${s}".`),e.bindProperty(o,{get:Cn(c,o),set:kn(c,o),enumerable:!0,configurable:!0})}Object.defineProperty(n,s,{get:$n(d),enumerable:!0,configurable:!0}),ge(i,null)}function Tn(t){const e=new Set,n=new Set,s=function(t){let e={},n=t;for(;n&&n!==Object.prototype;)Object.assign(e,Object.getOwnPropertyDescriptors(n)),n=Object.getPrototypeOf(n);return e}(t);for(const[t,o]of Object.entries(s))"function"==typeof o.get&&e.add(t),"function"==typeof o.set&&n.add(t);return{getterPaths:e,setterPaths:n}}class Mn extends HTMLElement{__state;_name="default";_initialized=!1;_initializePromise;_resolveInitialize=null;_loadingPromise;_resolveLoading=null;_setStatePromise=null;_resolveSetState=null;_listPaths=new Set;_elementPaths=new Set;_getterPaths=new Set;_setterPaths=new Set;_loopContextStack=function(){return new g}();_dynamicDependency=new Map;_staticDependency=new Map;_pathSet=new Set;_version=0;_rootNode=null;constructor(){super(),this._initializePromise=new Promise(t=>{this._resolveInitialize=t}),this._loadingPromise=new Promise(t=>{this._resolveLoading=t}),this._setStatePromise=new Promise(t=>{this._resolveSetState=t})}get _state(){return void 0===this.__state&&l(`${r.state} _state is not initialized yet.`),this.__state}set _state(t){this.__state=t,this._listPaths.clear(),this._elementPaths.clear(),this._getterPaths.clear(),this._pathSet.clear();const e=Tn(t);for(const t of e.getterPaths)this._getterPaths.add(t);for(const t of e.setterPaths)this._setterPaths.add(t);this._resolveLoading?.()}get name(){return this._name}async _initialize(){try{if(this.hasAttribute("state")){const t=this.getAttribute("state");this._state=function(t){const e=document.getElementById(t);if(e&&"application/json"===e.type)try{return JSON.parse(e.textContent||"{}")}catch(t){l("Failed to parse JSON from script element:"+t)}return{}}(t)}else if(this.hasAttribute("src")){const t=this.getAttribute("src");t&&t.endsWith(".json")?this._state=await async function(t){try{const e=await fetch(t);return e.ok||l(`Failed to fetch JSON file: ${e.statusText}`),await e.json()}catch(t){return console.error("Failed to load JSON file:",t),{}}}(t):t&&t.endsWith(".js")?this._state=await async function(t){try{return(await import(t)).default||{}}catch(t){l(`Failed to load script file: ${t}`)}}(t):l(`Unsupported src file type: ${t}`)}else if(this.hasAttribute("json")){const t=this.getAttribute("json");this._state=JSON.parse(t)}else{const t=this.querySelector('script[type="module"]');if(t)this._state=await async function(t,e){let n=null;const s=`\n//# sourceURL=${e}\n`;if("function"==typeof URL.createObjectURL){const e=new Blob([t.text+s],{type:"application/javascript"}),o=URL.createObjectURL(e);try{n=await import(o)}finally{URL.revokeObjectURL(o)}}else{const e=btoa(String.fromCodePoint(...(new TextEncoder).encode(t.text+s)));n=await import(`data:application/javascript;base64,${e}`)}return n&&"object"==typeof n.default?n.default:{}}(t,`state#${this._name}`);else{const t=setTimeout(()=>{console.warn(`[@wcstack/state] Warning: No state source found for <${r.state}> element with name="${this._name}".`)},6e4);this._state=await this._setStatePromise,clearTimeout(t)}}}catch(t){l(`Failed to initialize state: ${t}`)}await this._loadingPromise,this._name=this.getAttribute("name")||"default",u(this.rootNode,this._name,this)}async _bindWebComponent(){if(this.hasAttribute("bind-component")){this.rootNode instanceof ShadowRoot||l("bind-component can only be used inside a shadow root.");const t=this.rootNode.host,e=this.getAttribute("bind-component");try{await customElements.whenDefined(t.tagName.toLowerCase()),e in t||l(`Component does not have property "${e}" for state binding.`);const n=t[e];"object"==typeof n&&null!==n||l(`Component property "${e}" is not an object for state binding.`),await this.bindWebComponent(t,e,n)}catch(t){l(`Failed to bind web component: ${t}`)}}}async connectedCallback(){this._rootNode=this.getRootNode(),this._initialized||(this._bindWebComponent(),await this._initialize(),this._initialized=!0,this._resolveInitialize?.())}disconnectedCallback(){null!==this._rootNode&&(u(this.rootNode,this._name,null),this._rootNode=null)}get initializePromise(){return this._initializePromise}get listPaths(){return this._listPaths}get elementPaths(){return this._elementPaths}get getterPaths(){return this._getterPaths}get setterPaths(){return this._setterPaths}get loopContextStack(){return this._loopContextStack}get dynamicDependency(){return this._dynamicDependency}get staticDependency(){return this._staticDependency}get version(){return this._version}get rootNode(){return null===this._rootNode&&l("State rootNode is not available."),this._rootNode}_addDependency(t,e,n){const s=t.get(e);return void 0===s?(t.set(e,[n]),!0):!s.includes(n)&&(s.push(n),!0)}addDynamicDependency(t,e){return this._addDependency(this._dynamicDependency,t,e)}addStaticDependency(t,e){return this._addDependency(this._staticDependency,t,e)}setPathInfo(t,e){if("for"===e&&(this._listPaths.add(t),this._elementPaths.add(t+"."+f)),!this._pathSet.has(t)){const e=I(t);if(this._pathSet.add(t),null!==e.parentPath){let t=e;for(;null!==t.parentPath&&this.addStaticDependency(t.parentPath,t.path);)t=I(t.parentPath)}}}_createState(t,e,n){try{const s=function(t,e,n,s){const o=new sn(t,n,s);return new Proxy(e,o)}(t,this._state,this._name,e);return n(s)}finally{}}async createStateAsync(t,e){return await this._createState(this.rootNode,t,e)}createState(t,e){this._createState(this.rootNode,t,e)}nextVersion(){return this._version++,this._version}async bindWebComponent(t,e,n){await En(this,t,e,n)}bindProperty(t,e){Object.defineProperty(this._state,t,e)}setInitialState(t){this._initialized&&l("setInitialState cannot be called after state is initialized."),this._resolveSetState?.(t)}}function Ln(){customElements.get(r.state)||customElements.define(r.state,Mn),document.addEventListener("DOMContentLoaded",async()=>{await Sn(document),an(document),yn(document,document),ge(document.body,null)})}export{Ln as bootstrapState};
//# sourceMappingURL=index.esm.min.js.map
