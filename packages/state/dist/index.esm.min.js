const t="data-wcs",e="wcs-text",n="wcs-for",o="wcs-if",s="wcs-elseif",a="wcs-else",i={state:"wcs-state"},r="en";function l(t){throw new Error(`[@wcstack/state] ${t}`)}const d=new WeakMap;let c=0;function u(t){let e,n=d.get(t)||null;if(null!==n)return n;const o=new Promise(t=>{e=t});return n={id:++c,promise:o,resolve:e},d.set(t,n),n}async function f(t){const e=u(t);await e.promise}function h(t){u(t).resolve()}function p(t){const e=t.node,n=t.replaceNode;e!==n&&null!==e.parentNode&&e.parentNode.replaceChild(n,e)}function m(t,e){let n=t;if(0===e.length)return n;for(let t=0;t<e.length&&(n=n?.childNodes[e[t]]??null,null!==n);t++);return n}function g(t,e){const n=[];for(const o of e)if("text"!==o.bindingType)n.push({...o,node:t,replaceNode:t});else{const e=document.createTextNode("");n.push({...o,node:t,replaceNode:e})}return n}const w=new WeakMap;function I(t){return w.get(t)||null}function b(t,e){w.set(t,e)}const y=".",S="*",x=128,N={};for(let t=0;t<128;t++)N[`$${t+1}`]=t;const _=Object.freeze(N),P="$connectedCallback",v="$disconnectedCallback",A="$stateReadyCallback",$=new Map;let C=0;function k(t){let e=$.get(t);return void 0!==e||(e=Object.freeze(new E(t)),$.set(t,e)),e}class E{id=++C;path;segments;lastSegment;cumulativePaths;cumulativePathSet;cumulativePathInfos;cumulativePathInfoSet;parentPath;wildcardPaths;wildcardPathSet;indexByWildcardPath;wildcardPathInfos;wildcardPathInfoSet;wildcardParentPaths;wildcardParentPathSet;wildcardParentPathInfos;wildcardParentPathInfoSet;wildcardPositions;lastWildcardPath;lastWildcardInfo;wildcardCount;parentPathInfo;constructor(t){const e=e=>t===e?this:k(e),n=t.split("."),o=[],s=[],a=[],i={},r=[],l=[],d=[],c=[];let u="",f="",h=0;for(let t=0;t<n.length;t++)u+=n[t],n[t]===S&&(a.push(u),i[u]=h,r.push(e(u)),l.push(f),d.push(e(f)),c.push(t),h++),o.push(u),s.push(e(u)),f=u,u+=".";const p=a.length>0?a[a.length-1]:null,m=o.length>1?o[o.length-2]:null;this.path=t,this.segments=n,this.lastSegment=n[n.length-1],this.cumulativePaths=o,this.cumulativePathSet=new Set(o),this.cumulativePathInfos=s,this.cumulativePathInfoSet=new Set(s),this.wildcardPaths=a,this.wildcardPathSet=new Set(a),this.indexByWildcardPath=i,this.wildcardPathInfos=r,this.wildcardPathInfoSet=new Set(r),this.wildcardParentPaths=l,this.wildcardParentPathSet=new Set(l),this.wildcardParentPathInfos=d,this.wildcardParentPathInfoSet=new Set(d),this.wildcardPositions=c,this.lastWildcardPath=p,this.lastWildcardInfo=p?e(p):null,this.parentPath=m,this.parentPathInfo=m?e(m):null,this.wildcardCount=h}}const M=new Set(["if","elseif","else","for"]);function T(t){l(`filter ${t} requires at least one option`)}function L(t){l(`filter ${t} requires a number as option`)}function W(t){l(`filter ${t} requires a number value`)}function R(t){l(`filter ${t} requires a date value`)}function O(t){return!(!t||isNaN(Number(t)))}const D={eq:t=>{const e=t?.[0]??T("eq");return t=>"number"==typeof t?(O(e)||L("eq"),t===Number(e)):t===e},ne:t=>{const e=t?.[0]??T("ne");return t=>"number"==typeof t?(O(e)||L("ne"),t!==Number(e)):t!==e},not:t=>t=>("boolean"!=typeof t&&l(`filter ${"not"} requires a boolean value`),!t),lt:t=>{const e=t?.[0]??T("lt");return O(e)||L("lt"),t=>("number"!=typeof t&&W("lt"),t<Number(e))},le:t=>{const e=t?.[0]??T("le");return O(e)||L("le"),t=>("number"!=typeof t&&W("le"),t<=Number(e))},gt:t=>{const e=t?.[0]??T("gt");return O(e)||L("gt"),t=>("number"!=typeof t&&W("gt"),t>Number(e))},ge:t=>{const e=t?.[0]??T("ge");return O(e)||L("ge"),t=>("number"!=typeof t&&W("ge"),t>=Number(e))},inc:t=>{const e=t?.[0]??T("inc");return O(e)||L("inc"),t=>("number"!=typeof t&&W("inc"),t+Number(e))},dec:t=>{const e=t?.[0]??T("dec");return O(e)||L("dec"),t=>("number"!=typeof t&&W("dec"),t-Number(e))},mul:t=>{const e=t?.[0]??T("mul");return O(e)||L("mul"),t=>("number"!=typeof t&&W("mul"),t*Number(e))},div:t=>{const e=t?.[0]??T("div");return O(e)||L("div"),t=>("number"!=typeof t&&W("div"),t/Number(e))},mod:t=>{const e=t?.[0]??T("mod");return O(e)||L("mod"),t=>("number"!=typeof t&&W("mod"),t%Number(e))},fix:t=>{const e=t?.[0]??"0";return O(e)||L("fix"),t=>("number"!=typeof t&&W("fix"),t.toFixed(Number(e)))},locale:t=>{const e=t?.[0]??r;return t=>("number"!=typeof t&&W("locale"),t.toLocaleString(e))},uc:t=>t=>String(t).toUpperCase(),lc:t=>t=>String(t).toLowerCase(),cap:t=>t=>{const e=String(t);return 0===e.length?e:1===e.length?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)},trim:t=>t=>String(t).trim(),slice:t=>{const e=[],n=t?.[0]??T("slice");O(n)||L("slice"),e.push(Number(n));const o=t?.[1];return void 0!==o&&(O(o)||L("slice"),e.push(Number(o))),t=>String(t).slice(...e)},substr:t=>{const e=t?.[0]??T("substr");O(e)||L("substr");const n=t?.[1]??T("substr");return O(n)||L("substr"),t=>String(t).substr(Number(e),Number(n))},pad:t=>{const e=t?.[0]??T("pad");O(e)||L("pad");const n=t?.[1]??"0";return t=>String(t).padStart(Number(e),n)},rep:t=>{const e=t?.[0]??T("rep");return O(e)||L("rep"),t=>String(t).repeat(Number(e))},rev:t=>t=>String(t).split("").reverse().join(""),int:t=>t=>parseInt(String(t),10),float:t=>t=>parseFloat(String(t)),round:t=>{const e=t?.[0]??"0";return O(e)||L("round"),t=>{"number"!=typeof t&&W("round");const n=Math.pow(10,Number(e));return Math.round(t*n)/n}},floor:t=>{const e=t?.[0]??"0";return O(e)||L("floor"),t=>{"number"!=typeof t&&W("floor");const n=Math.pow(10,Number(e));return Math.floor(t*n)/n}},ceil:t=>{const e=t?.[0]??"0";return O(e)||L("ceil"),t=>{"number"!=typeof t&&W("ceil");const n=Math.pow(10,Number(e));return Math.ceil(t*n)/n}},percent:t=>{const e=t?.[0]??"0";return O(e)||L("percent"),t=>("number"!=typeof t&&W("percent"),`${(100*t).toFixed(Number(e))}%`)},date:t=>{const e=t?.[0]??r;return t=>(t instanceof Date||R("date"),t.toLocaleDateString(e))},time:t=>{const e=t?.[0]??r;return t=>(t instanceof Date||R("time"),t.toLocaleTimeString(e))},datetime:t=>{const e=t?.[0]??r;return t=>(t instanceof Date||R("datetime"),t.toLocaleString(e))},ymd:t=>{const e=t?.[0]??"-";return t=>{t instanceof Date||R("ymd");const n=t.getFullYear().toString(),o=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0");return`${n}${e}${o}${e}${s}`}},falsy:t=>t=>!1===t||null==t||0===t||""===t||Number.isNaN(t),truthy:t=>t=>!1!==t&&null!=t&&0!==t&&""!==t&&!Number.isNaN(t),defaults:t=>{const e=t?.[0]??T("defaults");return t=>!1===t||null==t||0===t||""===t||Number.isNaN(t)?e:t},boolean:t=>t=>Boolean(t),number:t=>t=>Number(t),string:t=>t=>String(t),null:t=>t=>""===t?null:t},F=D,j={input:D,output:F},B=(t,e)=>n=>{const o=n[t];return o||l(`filter not found: ${t}`),o(e)};const z=new Map;function q(t,e){const n=j[e];return t.map(t=>{const o=t.indexOf("("),s=t.lastIndexOf(")");if(-1!==o&&-1===s&&l(`Invalid filter format: missing closing parenthesis in "${t}"`),-1!==s&&-1===o&&l(`Invalid filter format: missing opening parenthesis in "${t}"`),-1===o){const o=t.trim(),s=`${o}():${e}`;let a=z.get(s);return void 0===a&&(a=B(o,[])(n),z.set(s,a)),{filterName:o,args:[],filterFn:a}}{const a=t.substring(o+1,s),i=t.substring(0,o).trim(),r=function(t){const e=[];let n="",o=null;for(let s=0;s<t.length;s++){const a=t[s];o?a===o?o=null:n+=a:'"'===a||"'"===a?o=a:","===a?(e.push(n.trim()),n=""):n+=a}return n.trim()&&e.push(n.trim()),e}(a),l=`${i}(${r.join(",")}):${e}`;let d=z.get(l);return void 0===d&&(d=B(i,r)(n),z.set(l,d)),{filterName:i,args:r,filterFn:d}}})}const U=t=>t.trim(),H=new Map;const V=new Map;function J(t){const e=t.indexOf("|");let n="",o=[],s="",a=[];-1!==e?(n=t.slice(0,e).trim(),s=t.slice(e+1).trim(),V.has(s)?a=V.get(s):(o=s.split("|").map(U),a=q(o,"output"),V.set(s,a))):n=t.trim();const[i,r="default"]=n.split("@").map(U);return{stateName:r,statePathName:i,statePathInfo:k(i),outFilters:a}}function X(t){const[...e]=t.split(";").map(U).filter(t=>t.length>0),n=e.map(t=>{const e=t.indexOf(":");-1===e&&l(`Invalid bindText: "${t}". Missing ':' separator between propPart and statePart.`);const n=t.slice(0,e).trim(),o=t.slice(e+1).trim();if("else"===n){return{propName:"else",propSegments:["else"],propModifiers:[],statePathName:"#else",statePathInfo:k("#else"),stateName:"",inFilters:[],outFilters:[],bindingType:"else"}}if("if"===n||"elseif"===n||"for"===n||"radio"===n||"checkbox"===n){return{propName:n,propSegments:[n],propModifiers:[],inFilters:[],...J(o),bindingType:n}}{const t=J(o),e=function(t){const e=t.indexOf("|");let n="",o=[],s="",a=[];-1!==e?(n=t.slice(0,e).trim(),s=t.slice(e+1).trim(),H.has(s)?a=H.get(s):(o=s.split("|").map(U),a=q(o,"input"),H.set(s,a))):n=t.trim();const[i,r]=n.split("#").map(U),l=i.split(".").map(U);return{propName:i,propSegments:l,propModifiers:r?r.split(",").map(U):[],inFilters:a}}(n);return e.propSegments[0].startsWith("on")?{...e,...t,bindingType:"event"}:{...e,...t,bindingType:"prop"}}});if(n.length>1){n.some(t=>M.has(t.bindingType))&&l(`Invalid bindText: "${t}". 'if', 'elseif', 'else', and 'for' bindings must be single binding.`)}return n}const K=new WeakMap,Y=new Set([e,n,o,s,a]),G=new RegExp("^\\s*@@\\s*(.*?)\\s*:\\s*(.+?)\\s*$");function Q(t){const n=K.get(t);if("string"==typeof n)return n;if(t.nodeType!==Node.COMMENT_NODE)return null;const o=t.data.trim(),s=G.exec(o);if(null===s)return null;const a=s[1]||e;return Y.has(a)?(K.set(t,s[2]),s[2]):null}const Z=new Map;function tt(t,e,n){if(null===n)Z.delete(t);else{Z.set(t,n);const o=n.parseBindTextResult,s=Nn(e,o.stateName);null===s&&l(`State element with name "${o.stateName}" not found for fragment info.`),s.setPathInfo(o.statePathName,o.bindingType);for(const t of n.nodeInfos)for(const n of t.parseBindTextResults){const t=Nn(e,n.stateName);null===t&&l(`State element with name "${n.stateName}" not found for fragment info node.`),t.setPathInfo(n.statePathName,n.bindingType)}}}function et(t){return Z.get(t)||null}function nt(e){if(e.nodeType===Node.ELEMENT_NODE){return X(e.getAttribute(t)||"")}if(e.nodeType===Node.COMMENT_NODE){const t=Q(e);null===t&&l("Comment node binding text not found.");const n=et(t);let o=n?.parseBindTextResult??null,s=null;return null===o?(o={propName:"textContent",propSegments:["textContent"],propModifiers:[],inFilters:[],...J(t),bindingType:"text"},s=null):s=t,[{...o,uuid:s}]}return[]}function ot(e){const n=[],o=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT,{acceptNode(e){if(e.nodeType===Node.ELEMENT_NODE){return e.hasAttribute(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}return null!==Q(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;o.nextNode();)n.push(o.currentNode);return n}const st=new WeakSet;const at=new WeakMap;function it(t){let e=t;for(;e;){const t=at.get(e);if(t)return t;e=e.parentNode}return null}function rt(t,e){null!==e?at.set(t,e):at.delete(t)}const lt=Symbol("$$setLoopContextAsync"),dt=Symbol("$$setLoopContext"),ct=Symbol("$$getByAddress"),ut=Symbol("$$setByAddress"),ft=Symbol("$$connectedCallback"),ht=Symbol("$$disconnectedCallback"),pt=Symbol("$$updatedCallback"),mt=new Map,gt=new Map;function wt(t){if(!t.propName.startsWith("on"))return!1;const e=function(t){const e=t.propModifiers.filter(t=>"prevent"===t||"stop"===t).sort().join(",");return`${t.stateName}::${t.statePathName}::${e}`}(t);let n=mt.get(e);var o,s,a;void 0===n&&(o=t.stateName,s=t.statePathName,a=t.propModifiers,n=t=>{a.includes("prevent")&&t.preventDefault(),a.includes("stop")&&t.stopPropagation();const e=t.target,n=Nn(e.getRootNode(),o);null===n&&l(`State element with name "${o}" not found for event handler.`);const i=it(e);n.createStateAsync("writable",async e=>{e[dt](i,()=>{const n=e[s];return"function"!=typeof n&&l(`Handler "${s}" is not a function on state "${o}".`),Reflect.apply(n,e,[t,...i?.listIndex.indexes??[]])})})},mt.set(e,n));const i=t.propName.slice(2);t.node.addEventListener(i,n);let r=gt.get(e);return void 0===r?(r=new Set([t]),gt.set(e,r)):r.add(t),!0}const It=new Set(["radio","checkbox"]),bt=new Set(["value","valueAsNumber","valueAsDate"]);const yt=new Map,St=new Map;function xt(t){if(function(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const n=t,o=n.tagName.toLowerCase();if("input"===o){const t=(n.getAttribute("type")||"text").toLowerCase();if("button"===t)return!1;if(It.has(t)&&"checked"===e)return!0;if(bt.has(e))return!0}return"select"===o&&"value"===e||"textarea"===o&&"value"===e}(t.node,t.propName)&&-1===t.propModifiers.indexOf("ro")){const a=function(t){let e="select"===t.node.tagName.toLowerCase()?"change":"input";for(const n of t.propModifiers)n.startsWith("on")&&(e=n.slice(2));return e}(t),i=function(t,e){const n=t.inFilters.map(t=>t.filterName+"("+t.args.join(",")+")").join("|");return`${t.stateName}::${t.propName}::${t.statePathName}::${e}::${n}`}(t,a);let r=yt.get(i);void 0===r&&(e=t.stateName,n=t.propName,o=t.statePathName,s=t.inFilters,r=t=>{const a=t.target;if(null===a)return void console.warn("[@wcstack/state] event.target is null.");if(!(n in a))return void console.warn(`[@wcstack/state] Property "${n}" does not exist on target element.`);let i=a[n];for(const t of s)i=t.filterFn(i);const r=Nn(a.getRootNode(),e);null===r&&l(`State element with name "${e}" not found for two-way binding.`);const d=it(a);r.createState("writable",t=>{t[dt](d,()=>{t[o]=i})})},yt.set(i,r)),t.node.addEventListener(a,r);let d=St.get(i);return void 0===d?(d=new Set([t]),St.set(i,d)):d.add(t),!0}var e,n,o,s;return!1}const Nt=new WeakMap;function _t(t){return Nt.get(t)??[]}function Pt(t,e){Nt.set(t,e)}const vt=new WeakMap;function At(t,e){if(vt.has(t)){const n=vt.get(t);if(n.has(e))return n.get(e)}else vt.set(t,new WeakMap);const n=Object.freeze(new $t(t,e));return vt.get(t).set(e,n),n}class $t{pathInfo;stateName;stateElement;parentAbsolutePathInfo;constructor(t,e){this.pathInfo=e,this.stateName=t.name,this.stateElement=t,null===e.parentPathInfo?this.parentAbsolutePathInfo=null:this.parentAbsolutePathInfo=At(t,e.parentPathInfo)}}const Ct=new WeakMap,kt=new WeakMap;class Et{absolutePathInfo;listIndex;_parentAbsoluteAddress;constructor(t,e){this.absolutePathInfo=t,this.listIndex=e}get parentAbsoluteAddress(){if(void 0!==this._parentAbsoluteAddress)return this._parentAbsoluteAddress;const t=this.absolutePathInfo.parentAbsolutePathInfo;if(null===t)return null;let e=null;return e=this.absolutePathInfo.pathInfo.segments[this.absolutePathInfo.pathInfo.segments.length-1]===S?this.listIndex?.parentListIndex??null:this.listIndex,this._parentAbsoluteAddress=Mt(t,e)}}function Mt(t,e){if(null===e){let e=kt.get(t);return void 0!==e||(e=new Et(t,null),kt.set(t,e)),e}{let n=Ct.get(e);void 0===n&&(n=new WeakMap,Ct.set(e,n));let o=n.get(t);return void 0!==o||(o=new Et(t,e),n.set(t,o)),o}}const Tt=new WeakMap;function Lt(t,e){null===e?Tt.delete(t):Tt.set(t,e)}function Wt(t){return Tt.get(t)||null}const Rt=new Map;function Ot(t,e){let n,o;if(0===t.wildcardCount||0===e.wildcardCount)return 0;if(1===t.wildcardCount&&e.wildcardCount>0&&e.wildcardPathSet.has(t.path))return 1;t.id<e.id?(n=t,o=e):(n=e,o=t);const s=`${n.path}\t${o.path}`;let a=Rt.get(s);if(void 0!==a)return a;return a=n.wildcardPathSet.intersection(o.wildcardPathSet).size,Rt.set(s,a),a}const Dt=new WeakMap;function Ft(t){const e=it(t.node);if(null===e)return null;let n=Dt.get(e);if(void 0===n)n=new WeakMap,Dt.set(e,n);else{const e=n.get(t);if(void 0!==e)return e}let o=null;try{const n=Ot(e.pathInfo,t.statePathInfo);return n>0&&(o=e.listIndex.at(n-1)),o}finally{n.set(t,o)}}const jt=new WeakMap;function Bt(t){let e=null;if(e=jt.get(t)||null,null!==e)return e;let n=t.replaceNode.getRootNode();if(!1===t.replaceNode.isConnected){const e=Wt(n);null===e?l(`Cannot get absolute state address for disconnected binding: ${t.bindingType} ${t.statePathName} on ${t.node.nodeName}`):n=e}const o=Ft(t),s=Nn(n,t.stateName);null===s&&l(`State element with name "${t.stateName}" not found for binding.`);return e=Mt(At(s,t.statePathInfo),o),jt.set(t,e),e}function zt(t){jt.delete(t)}const qt=new WeakMap;const Ut=new WeakMap;function Ht(t,e){let n=t;for(const t of e)n=t.filterFn(n);return n}const Vt=Object.freeze([]);const Jt=new WeakMap,Xt=new WeakMap;class Kt{pathInfo;listIndex;_parentAddress;constructor(t,e){this.pathInfo=t,this.listIndex=e}get parentAddress(){if(void 0!==this._parentAddress)return this._parentAddress;const t=this.pathInfo.parentPathInfo;if(null===t)return null;let e=null;return e=this.pathInfo.segments[this.pathInfo.segments.length-1]===S?this.listIndex?.parentListIndex??null:this.listIndex,this._parentAddress=Yt(t,e)}}function Yt(t,e){if(null===e){let e=Xt.get(t);return void 0!==e||(e=new Kt(t,null),Xt.set(t,e)),e}{let n=Jt.get(e);void 0===n&&(n=new WeakMap,Jt.set(e,n));let o=n.get(t);return void 0!==o||(o=new Kt(t,e),n.set(t,o)),o}}const Gt=new WeakMap;function Qt(t){return Gt.get(t)??[]}Set.prototype.difference||(Set.prototype.difference=function(t){const e=new Set(this);for(const n of t)e.delete(n);return e}),Set.prototype.intersection||(Set.prototype.intersection=function(t){const e=new Set;for(const n of t)this.has(n)&&e.add(n);return e});let Zt=0;function te(){return`u${(Zt++).toString(36)}`}let ee=0;class ne{uuid=te();parentListIndex;position;length;_index;_version;_indexes;_listIndexes;constructor(t,e){this.parentListIndex=t,this.position=t?t.position+1:0,this.length=this.position+1,this._index=e,this._version=ee}get index(){return this._index}set index(t){this._index=t,this._version=++ee,this.indexes[this.position]=t}get version(){return this._version}get dirty(){return null!==this.parentListIndex&&(this.parentListIndex.dirty||this.parentListIndex.version>this._version)}get indexes(){return null===this.parentListIndex?void 0===this._indexes&&(this._indexes=[this._index]):(void 0===this._indexes||this.dirty)&&(this._indexes=[...this.parentListIndex.indexes,this._index],this._version=ee),this._indexes}get listIndexes(){return null===this.parentListIndex?void 0===this._listIndexes&&(this._listIndexes=[new WeakRef(this)]):void 0===this._listIndexes&&(this._listIndexes=[...this.parentListIndex.listIndexes,new WeakRef(this)]),this._listIndexes}get varName(){return`$${this.position+1}`}at(t){return t>=0?this.listIndexes[t]?.deref()||null:this.listIndexes[this.listIndexes.length+t]?.deref()||null}}function oe(t,e){return new ne(t,e)}const se=new WeakMap;function ae(t){return se.get(t)||null}const ie=new WeakMap,re=Object.freeze([]),le=new Set;function de(t,e,n){const o=Array.isArray(e)&&e.length>0?e:re,s=Array.isArray(n)&&n.length>0?n:re,a=function(t,e){const n=Array.isArray(t)&&t.length>0?t:re,o=Array.isArray(e)&&e.length>0?e:re;let s=ie.get(n);return s&&s.get(o)||null}(o,s);if(a)return a;const i=ae(o)||[];let r;try{if(0===s.length)return r={oldIndexes:i,newIndexes:[],changeIndexSet:le,deleteIndexSet:new Set(i),addIndexSet:le};let e=ae(s);if(0===o.length){if(null===e){e=[];for(let n=0;n<s.length;n++){const o=oe(t,n);e.push(o)}}return r={oldIndexes:i,newIndexes:e,changeIndexSet:le,deleteIndexSet:le,addIndexSet:new Set(e)}}if(function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}(o,s))return r={oldIndexes:i,newIndexes:i,changeIndexSet:le,deleteIndexSet:le,addIndexSet:le};const n=new Map;for(let t=0;t<o.length;t++){const e=o[t];let s=n.get(e);s||(s=[],n.set(e,s)),s.push(t)}if(null!==e)return function(t,e,n,o,s){const a=new Set(o),i=new Set(n),r=new Set,l=a.difference(i),d=i.difference(a);for(let t=0;t<e.length;t++){const o=e[t],a=s.get(o),i=a&&a.length>0?a.shift():void 0;if(void 0!==i){const e=n[i];e.index!==t&&r.add(e)}}return{oldIndexes:n,newIndexes:o,changeIndexSet:r,deleteIndexSet:d,addIndexSet:l}}(0,s,i,e,n);e=[];const a=new Set,l=new Set;for(let o=0;o<s.length;o++){const r=s[o],d=n.get(r),c=d&&d.length>0?d.shift():void 0;if(void 0===c){const n=oe(t,o);e.push(n),l.add(n)}else{const t=i[c];t.index!==o&&(t.index=o,a.add(t)),e.push(t)}}return r={oldIndexes:i,newIndexes:e,changeIndexSet:a,deleteIndexSet:new Set(i).difference(new Set(e)),addIndexSet:l}}finally{void 0!==r&&(!function(t,e,n){let o=ie.get(t);o||(o=new WeakMap,ie.set(t,o)),o.set(e,n)}(o,s,r),l=s,null!==(d=r.newIndexes)?se.set(l,d):se.delete(l))}var l,d}const ce=new WeakMap;function ue(t){let e=null;return e=ce.get(t)||null,null===e&&(e=new Set,ce.set(t,e)),e}function fe(t,e){ue(t).add(e)}function he(t,e){ue(t).delete(e)}const pe=new WeakMap;function me(t){pe.delete(t)}const ge=new WeakMap;function we(t){return ge.get(t)??[]}const Ie=new WeakMap;function be(t){return Ie.get(t)??[]}function ye(t,e,n){!function(t,e){const n=be(t);for(const t of n)rt(t,e)}(t,e);const o=we(t);for(const t of o){fe(Bt(t),t),Ue(t,n)}}function Se(t){if(!t.mounted)return;const e=we(t);for(const t of e){he(Bt(t),t),zt(t),me(t)}!function(t){const e=be(t);for(const t of e)rt(t,null)}(t)}const xe=new WeakMap,Ne=Object.freeze(new Set);function _e(t){const e=xe.get(t);return void 0!==e?e:Ne}const Pe=new Set(["if","elseif","else","for"]);class ve{_content;_childNodeArray=[];_firstNode=null;_lastNode=null;_mounted=!1;constructor(t){this._content=t,this._childNodeArray=Array.from(this._content.childNodes),this._firstNode=this._childNodeArray.length>0?this._childNodeArray[0]:null,this._lastNode=this._childNodeArray.length>0?this._childNodeArray[this._childNodeArray.length-1]:null}get firstNode(){return this._firstNode}get lastNode(){return this._lastNode}get mounted(){return this._mounted}appendTo(t){for(const e of this._childNodeArray)t.appendChild(e);this._mounted=!0}mountAfter(t){const e=t.parentNode,n=t.nextSibling;if(e)for(const t of this._childNodeArray)e.insertBefore(t,n);this._mounted=!0}unmount(){for(const t of this._childNodeArray)null!==t.parentNode&&t.parentNode.removeChild(t);const t=we(this);for(const e of t){if(Pe.has(e.bindingType)){const t=_e(e.node);for(const e of t)e.unmount()}me(e),zt(e)}this._mounted=!1}}function Ae(t){void 0!==t.uuid&&null!==t.uuid||l("BindingInfo.uuid is null.");const e=et(t.uuid);e||l(`Fragment with UUID "${t.uuid}" not found.`);const n=document.importNode(e.fragment,!0),o=function(t,e){const[n,o]=function(t,e){const n=[],o=[];for(const s of e){const e=m(t,s.nodePath);if(null===e&&l(`Node not found by path [${s.nodePath.join(", ")}] in fragment.`),!st.has(e)){st.add(e);const t=g(e,s.parseBindTextResults);b(e,t),h(e),o.push(...t),n.push(e)}}return[n,o]}(t,e);return tn(o),{nodes:n,bindingInfos:o}}(n,e.nodeInfos),s=new ve(n);!function(t,e){ge.set(t,e)}(s,o.bindingInfos);const a=[];for(const t of o.bindingInfos)t.statePathName in _&&a.push(t);return function(t,e){Gt.set(t,e)}(s,a),function(t,e){Ie.set(t,e)}(s,o.nodes),function(t,e){const n=xe.get(t);n?n.add(e):xe.set(t,new Set([e]))}(t.node,s),s}const $e=new WeakMap,Ce=new WeakMap,ke=new WeakMap,Ee=new WeakMap;function Me(t){return ke.get(t.node)||[]}function Te(t,e){const n=ke.get(t.node);void 0===n?ke.set(t.node,[e]):n.push(e)}function Le(t,e){let n=Ce.get(t);if(void 0===n)return null;const o=n.get(e);return void 0===o?null:o}function We(t,e,n){let o=Ce.get(t);if(void 0===o){if(null===n)return;o=new WeakMap,Ce.set(t,o)}null===n?o.delete(e):o.set(e,n)}const Re=new WeakMap;function Oe(t,e,n){const o=t.node.isConnected,s=Boolean(n);let a;const i=_e(t.node);a=0===i.size?Ae(t):i.values().next().value;try{if(s||(Se(a),a.unmount()),s){a.mountAfter(t.node);ye(a,it(t.node),e)}}finally{Re.set(t.node,o)}}function De(t,e,n){const o=t.node,s=t.propSegments;if(1===s.length){const t=s[0];return void(o[t]!==n&&(o[t]=n))}let a=o[s[0]];for(let t=1;t<s.length-1;t++){const e=s[t];if(null==a)return;a=a[e]}if(a[s[s.length-1]]!==n){if(Object.isFrozen(a))return;a[s[s.length-1]]=n}}function Fe(t,e,n){const o=t.node,s=t.propSegments;s.length<=1&&l(`Invalid propSegments for web component binding: ${s.join(".")}`);const[a,...i]=s,r=o[a];void 0===r&&l(`Property "${a}" not found on web component.`),r[i.join(".")]=n}function je(t,e){const n=function(t){let e=null;if(e=pe.get(t)||null,null!==e)return e;if(t.statePathInfo.wildcardCount>0){const n=Ft(t);null===n&&l(`Cannot resolve state address for binding with wildcard statePathName "${t.statePathName}" because list index is null.`),e=Yt(t.statePathInfo,n)}else e=Yt(t.statePathInfo,null);return pe.set(t,e),e}(e);if(n.pathInfo.path in _){const t=it(e.node);return null===t&&l(`ListIndex not found for binding: ${e.statePathName}`),function(t,e){null===t.listIndex&&l("ListIndex not found for loopContext:");const n=_[e];void 0===n&&l(`Invalid index name: ${e}`);const o=t.listIndex.at(n);return null===o&&l(`Index not found at position ${n} for loopContext:`),o.index}(t,n.pathInfo.path)}return t[ct](n)}const Be={class:function(t,e,n){const o=t.node,s=t.propSegments[1];"boolean"!=typeof n&&l("Invalid value for class application: expected boolean, got "+typeof n),o.classList.toggle(s,n)},attr:function(t,e,n){const o=t.node,s=t.propSegments[1];o.getAttribute(s)!==n&&o.setAttribute(s,n)},style:function(t,e,n){const o=t.propSegments[1],s=t.node.style;s[o]!==n&&(s[o]=n)}},ze={text:function(t,e,n){t.replaceNode.nodeValue!==n&&(t.replaceNode.nodeValue=n)},for:function(t,e,n){const o=t.statePathInfo,s=Ft(t),a=Bt(t),i=_t(a),r=de(s,i,n);if(e.newListValueByAbsAddress.set(a,Array.isArray(n)?n:[]),Array.isArray(i)&&i.length===r.deleteIndexSet.size&&r.deleteIndexSet.size>0&&null!==t.node.parentNode){let e=Ee.get(t.node);if(void 0===e){const n=$e.get(t.node)||t.node;e=function(t,e){let n=t.previousSibling,o=e.nextSibling,s=!0;for(;null!==n;){if(n.nodeType===Node.ELEMENT_NODE||n.nodeType===Node.TEXT_NODE&&""!==(n.textContent?.trim()??"")){s=!1;break}n=n.previousSibling}for(;null!==o;){if(o.nodeType===Node.ELEMENT_NODE||o.nodeType===Node.TEXT_NODE&&""!==(o.textContent?.trim()??"")){s=!1;break}o=o.nextSibling}return s}(t.node,n),Ee.set(t.node,e)}if(e){const e=t.node.parentNode;e.textContent="",e.appendChild(t.node)}}for(const e of r.deleteIndexSet){const n=Le(t.node,e);null!==n&&(Se(n),n.unmount(),Te(t,n),We(t.node,e,null))}let d=t.node;const c=k(o.path+"."+S),u=e.stateElement.loopContextStack;let f=null;r.newIndexes.length==r.addIndexSet.size&&r.newIndexes.length>0&&d.isConnected&&(f=document.createDocumentFragment(),Lt(f,e.rootNode));for(const n of r.newIndexes){let s;if(r.addIndexSet.has(n)){const a=Yt(c,n);u.createLoopContext(a,n=>{const o=Me(t);s=o.pop(),void 0===s&&(s=Ae(t)),null!==f?s.appendTo(f):d.nextSibling!==s.firstNode&&s.mountAfter(d),ye(s,n,e)}),void 0===s&&l(`Content not found for ListIndex: ${n.index} at path "${o.path}"`)}else{if(s=Le(t.node,n),r.changeIndexSet.has(n)){const t=Qt(s);for(const n of t)Ue(n,e)}null===s&&l(`Content not found for ListIndex: ${n.index} at path "${o.path}"`),d.nextSibling!==s.firstNode&&s.mountAfter(d)}d=s.lastNode||d,We(t.node,n,s)}$e.set(t.node,d),null!==f&&(t.node.parentNode.insertBefore(f,t.node.nextSibling),Lt(f,null))},if:Oe,else:Oe,elseif:Oe,radio:function(t,e,n){const o=t.node,s=Ht(o.value,t.inFilters);o.checked=n===s},checkbox:function(t,e,n){const o=t.node,s=Ht(o.value,t.inFilters),a=Array.isArray(n)?n:Vt;o.checked=a.includes(s)}};function qe(t,e){const n=Ht(je(e.state,t),t.outFilters);let o=ze[t.bindingType];if(void 0===o){const n=t.propSegments[0];o=Be[n],void 0===o&&(o=function(t,e){const n=Ut.get(t);return!!n&&!0===n.get(e)}(t.replaceNode,e.stateElement)?Fe:De)}o(t,e,n)}function Ue(t,e){if(e.appliedBindingSet.has(t))return;e.appliedBindingSet.add(t);const n=Bt(t);if(e.updatedAbsAddressSetByStateElement.has(e.stateElement)){e.updatedAbsAddressSetByStateElement.get(e.stateElement).add(n)}else e.updatedAbsAddressSetByStateElement.set(e.stateElement,new Set([n]));if("event"===t.bindingType)return;if(function(t){let e=qt.get(t);if(void 0!==e)return e;try{if(t.nodeType!==Node.ELEMENT_NODE)return e=!1;const n=t;return e=!!n.tagName.includes("-")||!(!n.hasAttribute("is")||!n.getAttribute("is")?.includes("-"))}finally{qt.set(t,e??!1)}}(t.replaceNode)){const e=t.replaceNode;if(void 0===customElements.get(e.tagName.toLowerCase()))return}let o=t.replaceNode.getRootNode();if(o instanceof DocumentFragment&&!(o instanceof ShadowRoot)&&(o=Wt(o),null===o&&l("Root node for fragment not found for binding.")),t.stateName!==e.stateName||o!==e.rootNode){const n=Nn(o,t.stateName);null===n&&l(`State element with name "${t.stateName}" not found for binding.`),n.createState("readonly",s=>{const a={stateName:t.stateName,rootNode:o,stateElement:n,state:s,appliedBindingSet:e.appliedBindingSet,newListValueByAbsAddress:e.newListValueByAbsAddress,updatedAbsAddressSetByStateElement:e.updatedAbsAddressSetByStateElement};qe(t,a)})}else qe(t,e)}function He(t){let e=0;const n=new Set,o=new Map,s=new Map;for(;e<t.length;){let a=t[e];const i=a.stateName;if(!1===a.replaceNode.isConnected){e++;continue}let r=a.replaceNode.getRootNode();r instanceof DocumentFragment&&!(r instanceof ShadowRoot)&&(r=Wt(r),null===r&&l("Root node for fragment not found for binding."));const d=Nn(r,i);null===d&&l(`State element with name "${i}" not found for binding.`),d.createState("readonly",l=>{const c={rootNode:r,stateName:i,stateElement:d,state:l,appliedBindingSet:n,newListValueByAbsAddress:o,updatedAbsAddressSetByStateElement:s};for(;;){Ue(a,c),e++;const n=t[e];if(!n)break;const o=n.replaceNode.getRootNode();if(n.stateName!==i||o!==c.rootNode)break;a=n}})}for(const[t,e]of o.entries())Pt(t,e);for(const[t,e]of s.entries())t.createState("writable",t=>{t[pt](Array.from(e))})}const Ve=new Map,Je=new Map;const Xe=(t,e,n)=>o=>{const s=o.target;if(null===s)return void console.warn("[@wcstack/state] event.target is null.");if("radio"!==s.type)return void console.warn("[@wcstack/state] event.target is not a radio input element.");if(!1===s.checked)return;let a=s.value;for(const t of n)a=t.filterFn(a);const i=Nn(s.getRootNode(),t);null===i&&l(`State element with name "${t}" not found for two-way binding.`);const r=it(s);i.createState("writable",t=>{t[dt](r,()=>{t[e]=a})})};function Ke(t){if("radio"===t.bindingType&&-1===t.propModifiers.indexOf("ro")){const e=function(t){let e="input";for(const n of t.propModifiers)n.startsWith("on")&&(e=n.slice(2));return e}(t),n=function(t,e){const n=t.inFilters.map(t=>t.filterName+"("+t.args.join(",")+")").join("|");return`${t.stateName}::${t.statePathName}::${e}::${n}`}(t,e);let o=Ve.get(n);void 0===o&&(o=Xe(t.stateName,t.statePathName,t.inFilters),Ve.set(n,o)),t.node.addEventListener(e,o);let s=Je.get(n);return void 0===s?(s=new Set([t]),Je.set(n,s)):s.add(t),!0}return!1}const Ye=new Map,Ge=new Map;const Qe=(t,e,n)=>o=>{const s=o.target;if(null===s)return void console.warn("[@wcstack/state] event.target is null.");if("checkbox"!==s.type)return void console.warn("[@wcstack/state] event.target is not a checkbox input element.");const a=s.checked;let i=s.value;for(const t of n)i=t.filterFn(i);const r=Nn(s.getRootNode(),t);null===r&&l(`State element with name "${t}" not found for two-way binding.`);const d=it(s);r.createState("writable",t=>{t[dt](d,()=>{let n=t[e];if(Array.isArray(n))if(a)-1===n.indexOf(i)&&(t[e]=n.concat(i));else{const o=n.indexOf(i);-1!==o&&(t[e]=n.toSpliced(o,1))}else t[e]=a?[i]:[]})})};function Ze(t){if("checkbox"===t.bindingType&&-1===t.propModifiers.indexOf("ro")){const e=function(t){let e="input";for(const n of t.propModifiers)n.startsWith("on")&&(e=n.slice(2));return e}(t),n=function(t,e){const n=t.inFilters.map(t=>t.filterName+"("+t.args.join(",")+")").join("|");return`${t.stateName}::${t.statePathName}::${e}::${n}`}(t,e);let o=Ye.get(n);void 0===o&&(o=Qe(t.stateName,t.statePathName,t.inFilters),Ye.set(n,o)),t.node.addEventListener(e,o);let s=Ge.get(n);return void 0===s?(s=new Set([t]),Ge.set(n,s)):s.add(t),!0}return!1}function tn(t){for(const e of t)p(e),wt(e)||(xt(e),Ke(e),Ze(e))}function en(t,e){const[n,o]=function(t){const e=ot(t),n=[];for(const t of e)if(!st.has(t)){st.add(t);const e=g(t,nt(t));b(t,e),h(t),n.push(...e)}return[e,n]}(t);for(const t of n)rt(t,e);tn(o);for(const t of o){fe(Bt(t),t);const e=Nn(t.replaceNode.getRootNode(),t.stateName);null===e&&l(`State element with name "${t.stateName}" not found for binding.`),"event"!==t.bindingType&&e.setPathInfo(t.statePathName,t.bindingType)}He(o)}const nn=/\{\{\s*(.+?)\s*\}\}/g,on=new Set(["SCRIPT","STYLE"]);function sn(t){!function(t){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT),n=[];for(;e.nextNode();)n.push(e.currentNode);for(const t of n)t.parentElement&&on.has(t.parentElement.tagName)||an(t)}(t);const e=Array.from(t.querySelectorAll("template"));for(const t of e)if("http://www.w3.org/2000/svg"===t.namespaceURI){const e=document.createElement("template"),n=Array.from(t.childNodes);for(let t=0;t<n.length;t++){const o=n[t];e.content.appendChild(o)}for(const n of t.attributes)e.setAttribute(n.name,n.value);t.replaceWith(e),sn(e.content)}else sn(t.content)}function an(t){const e=t.data;if(nn.lastIndex=0,!nn.test(e))return;nn.lastIndex=0;const n=document.createDocumentFragment();let o,s=0;for(;null!==(o=nn.exec(e));){o.index>s&&n.appendChild(document.createTextNode(e.slice(s,o.index)));const t=o[1];n.appendChild(document.createComment(`@@: ${t}`)),s=o.index+o[0].length}s<e.length&&n.appendChild(document.createTextNode(e.slice(s))),t.parentNode.replaceChild(n,t)}let rn;const ln=/^(\s*@@\s*(?:.*?)\s*:\s*)(.+?)(\s*)$/;function dn(t,e){const n=e+y+S,o=t.indexOf("|"),s=t.indexOf("@");let a,i;if(-1!==o?(a=t.slice(0,o).trim(),i=t.slice(o)):-1!==s?(a=t.slice(0,s).trim(),i=t.slice(s)):(a=t.trim(),i=""),"."===a)a=n;else{if(!a.startsWith("."))return t;a=n+y+a.slice(1)}return i.length>0?a+i:a}function cn(t,e){const n=ln.exec(t);if(null===n)return t;const o=n[1],s=n[2],a=n[3];return o+dn(s,e)+a}function un(t,e){const n=t.split(";");let o=!1;const s=n.map(t=>{const n=t.trim();if(0===n.length)return t;const s=n.indexOf(":");if(-1===s)return t;const a=n.slice(0,s).trim(),i=n.slice(s+1).trim(),r=dn(i,e);return r!==i?(o=!0,`${a}: ${r}`):t});return o?s.join(";"):t}function fn(t,e){return un(t,e)}function hn(t){let e=t;const n=[];for(;null!==e.parentNode;){const t=Array.from(e.parentNode.childNodes).indexOf(e);n.unshift(t),e=e.parentNode}return n}function pn(t){const e=[],n=ot(t);for(const t of n){const n=nt(t);e.push({nodePath:hn(t),parseBindTextResults:n})}return e}const mn=new Map([["for",n],["if",o],["elseif",s],["else",a]]),gn=function(){if(rn)return rn;const t=[],e=B("not",t)(F);return rn={filterName:"not",args:t,filterFn:e},rn}();function wn(t,e){const n=e.outFilters;return{...e,outFilters:[...n,gn],bindingType:t}}function In(e,n,o,s){!function(t){const e=Array.from(t.childNodes);for(const n of e)n.nodeType===Node.TEXT_NODE&&""===(n.textContent||"").trim()&&t.removeChild(n)}(n),"string"==typeof s&&function(e,n){const o=t,s=document.createTreeWalker(e,NodeFilter.SHOW_COMMENT|NodeFilter.SHOW_ELEMENT);for(;s.nextNode();){const t=s.currentNode;if(t.nodeType===Node.COMMENT_NODE){const e=t;e.data=cn(e.data,n);continue}const e=t;if(e instanceof HTMLTemplateElement)continue;const a=e.getAttribute(o);if(null!==a){const t=un(a,n);t!==a&&e.setAttribute(o,t)}}}(n,s),bn(e,n,s);return{fragment:n,parseBindTextResult:o,nodeInfos:pn(n)}}function bn(e,n,o){const s=a,i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,{acceptNode(e){const n=e;if("template"===n.tagName.toLowerCase()){if((n.getAttribute(t)||"").length>0)return NodeFilter.FILTER_ACCEPT}return NodeFilter.FILTER_SKIP}});let r=null;const d=[],c=[];for(;i.nextNode();){const t=i.currentNode;c.push(t)}for(const n of c){let a=n.getAttribute(t)||"";"string"==typeof o&&(a=fn(a,o));let i=X(a)[0];const c=mn.get(i.bindingType);if(void 0===c)continue;const u=i.bindingType,f=n.content,h=te();let p=null;const m="for"===u?i.statePathName:o;if("else"===u){null===r&&l("'else' binding found without preceding 'if' or 'elseif' binding."),i=wn("else",r.parseBindTextResult),p=In(e,f,i,m),tt(h,e,p);const t=d.at(-1),o=document.createComment(`@@${c}:${h}`);void 0!==t?(n.remove(),t.fragment.appendChild(o),t.nodeInfos.push({nodePath:hn(o),parseBindTextResults:nt(o)})):n.replaceWith(o)}else if("elseif"===u){null===r&&l("'elseif' binding found without preceding 'if' or 'elseif' binding."),p=In(e,f,i,m),tt(h,e,p);const t=document.createComment(`@@${c}:${h}`),o=te(),a={fragment:document.createDocumentFragment(),parseBindTextResult:wn("else",r.parseBindTextResult),nodeInfos:[]};a.fragment.appendChild(t),a.nodeInfos.push({nodePath:hn(t),parseBindTextResults:nt(t)}),tt(o,e,a);const u=d.at(-1);d.push(a);const g=document.createComment(`@@${s}:${o}`);void 0!==u?(n.remove(),u.fragment.appendChild(g),u.nodeInfos.push({nodePath:hn(g),parseBindTextResults:nt(g)})):n.replaceWith(g)}else{p=In(e,f,i,m),tt(h,e,p);const t=document.createComment(`@@${c}:${h}`);n.replaceWith(t)}"if"===u?(d.length=0,r=p):"elseif"===u?r=p:"else"===u&&(r=null,d.length=0)}}async function yn(t){const e=t.querySelectorAll(i.state),n=[];await customElements.whenDefined(i.state);for(const t of e){const e=t;n.push(e.initializePromise)}await Promise.all(n)}async function Sn(e){if(e===document)await yn(document),sn(document),bn(document,document),en(document.body,null);else{const n=e;n.host.hasAttribute(t)&&await f(n.host),await yn(n),sn(n),bn(n,n),en(n,null)}}const xn=new WeakMap;function Nn(t,e){let n=xn.get(t);return n&&n.get(e)||null}function _n(t,e,n){let o=xn.get(t);if(null===n){if(!o)return;o.delete(e),0===o.size&&xn.delete(t)}else o||(o=new Map,xn.set(t,o),("HTMLDocument"===t.constructor.name||"Document"===t.constructor.name||"ShadowRoot"===t.constructor.name)&&queueMicrotask(()=>{Sn(t)})),o.has(e)&&l(`State element with name "${e}" is already registered.`),o.set(e,n)}class Pn{_loopContextStack=Array(x).fill(void 0);_length=0;createLoopContext(t,e){null===t.listIndex&&l("Cannot create loop context for a state address that does not have a list index.");const n=t;this._length>=x&&l("Exceeded maximum loop context stack depth of 128. Possible infinite loop.");const o=this._loopContextStack[this._length-1];if(void 0!==o){o.pathInfo.wildcardCount+1!==n.pathInfo.wildcardCount&&l("Cannot push loop context for a list whose wildcard count is not exactly one more than the current active loop context.");const t=n.pathInfo.wildcardPathInfos[n.pathInfo.wildcardPathInfos.length-2];o.pathInfo!==t&&l("Cannot push loop context for a list whose parent wildcard path info does not match the current active loop context.")}else 1!==n.pathInfo.wildcardCount&&l("Cannot push loop context for a list with wildcard positions when there is no active loop context.");let s;this._loopContextStack[this._length]=n,this._length++;try{s=e(n)}finally{s instanceof Promise?s.finally(()=>{this._length--,this._loopContextStack[this._length]=void 0}):(this._length--,this._loopContextStack[this._length]=void 0)}return s}}const vn=new Map;class An{path;segments;paths;wildcardCount;wildcardType;wildcardIndexes;pathInfo;constructor(t){const e=t.split("."),n=e.slice(),o=[];let s=0,a=0,i="",r=0,l="none";const d=[];for(let t=0;t<e.length;t++){const l=e[t];if("*"===l)n[t]="*",d.push(null),s++,r++;else{const e=Number(l);Number.isNaN(e)||(n[t]="*",d.push(e),a++,r++)}i+=l,o.push(i),i+=t<l.length-1?".":""}const c=k(n.join("."));(s>0||a>0)&&(l=s===r?"context":a===r?"all":"partial"),this.path=t,this.segments=e,this.paths=o,this.wildcardCount=r,this.wildcardType=l,this.wildcardIndexes=d,this.pathInfo=c}}function $n(t){let e;return vn.get(t)??(vn.set(t,e=new An(t)),e)}const Cn=new WeakMap;function kn(t,e){null===e?Cn.delete(t):Cn.set(t,e)}function En(t){const e=Cn.get(t);e&&(e.dirty=!0)}function Mn(t,e,n,o,s){if(!(e.pathInfo.path in t)){const s=Ln(t,e.parentAddress??l(`address.parentAddress is undefined path: ${e.pathInfo.path}`),n,o),a=e.pathInfo.segments[e.pathInfo.segments.length-1];if(a===S){const t=e.listIndex?.index??l(`address.listIndex?.index is undefined path: ${e.pathInfo.path}`);return Reflect.get(s,t)}return Reflect.get(s,a)}if(!s.getterPaths.has(e.pathInfo.path))return Reflect.get(t,e.pathInfo.path);o.pushAddress(e);try{return Reflect.get(t,e.pathInfo.path,n)}finally{o.popAddress()}}function Tn(t,e,n,o,s){const a=Mt(At(s,e.pathInfo),e.listIndex),i=function(t){return Cn.get(t)??null}(a);if(null!==i&&!1===i.dirty)return i.value;const r=Mn(t,e,n,o,s);return kn(a,{value:r,dirty:!1}),r}function Ln(t,e,n,o){!function(t,e){if(t.addressStackLength>0){const n=t.lastAddressStack?.pathInfo??null,o=t.stateElement;null!==n&&o.getterPaths.has(n.path)&&n.path!==e.pathInfo.path&&o.addDynamicDependency(e.pathInfo.path,n.path)}}(o,e);const s=o.stateElement;return e.pathInfo.wildcardCount>0||s.getterPaths.has(e.pathInfo.path)?Tn(t,e,n,o,s):Mn(t,e,n,o,s)}function Wn(t,e){if(0===t.addressStackLength)return null;const n=t.lastAddressStack;if(null===n)return null;const o=n.pathInfo.indexByWildcardPath[e];return void 0===o?null:n.listIndex?.at(o)??null}const Rn=new class{_queueAbsoluteAddresses=[];constructor(){}enqueueAbsoluteAddress(t){const e=0===this._queueAbsoluteAddresses.length;this._queueAbsoluteAddresses.push(t),e&&queueMicrotask(()=>{const t=this._queueAbsoluteAddresses;this._queueAbsoluteAddresses=[],this._applyChange(t)})}testApplyChange(t){this._applyChange(t)}_applyChange(t){const e=new Set(t),n=[];for(const t of e){const e=ue(t);for(const t of e)!1!==t.replaceNode.isConnected&&n.push(t)}He(n)}};function On(){return Rn}const Dn=new WeakMap;function Fn(t,e){null===e?Dn.delete(t):Dn.set(t,e)}function jn(t,e,n){const o=k(t.wildcardParentPaths[e]),s=At(t.stateElement,o),a=Yt(o,n),i=_t(Mt(s,n)),r=t.stateProxy[ct](a),l=function(t,e){switch(e){case"old":return t.oldIndexes;case"new":return t.newIndexes;case"add":return t.addIndexSet;case"change":return t.changeIndexSet;case"delete":return t.deleteIndexSet;default:return[]}}(de(a.listIndex,i,r),t.searchType);if(e===t.wildcardPaths.length-1)t.targetListIndexes.push(...l);else for(const n of l)jn(t,e+1,n)}function Bn(t,e,n,o,s,a,i,r,d){const c={stateElement:e,staticMap:o,dynamicMap:s,result:new Set,listPathSet:a,visited:new Set,stateProxy:i,searchType:r};return function(t,e,n){const o=[{address:e,depth:0}];for(;o.length>0;){const{address:e,depth:s}=o.pop();if(s>1e3&&l(`Maximum dependency depth of 1000 exceeded. Possible circular dependency detected at path: ${e.pathInfo.path}`),t.visited.has(e))continue;t.visited.add(e),n(e);const a=e.pathInfo.path,i=s+1,r=[],d=t.staticMap.get(a);if(d)for(const n of d){const o=k(n);if(t.listPathSet.has(a)&&o.lastSegment===S){const n=t.stateProxy[ct](e),s=_t(Mt(At(t.stateElement,e.pathInfo),e.listIndex)),a=de(e.listIndex,s,n);for(const e of a.newIndexes){const n=Yt(o,e);t.result.add(n),r.push({address:n,depth:i})}}else{const n=Yt(o,e.listIndex);t.result.add(n),r.push({address:n,depth:i})}}const c=t.dynamicMap.get(a);if(c)for(const n of c){const o=k(n),s=[];if(o.wildcardCount>0){const n=Ot(e.pathInfo,o);if(o.wildcardCount-n>=1){let a;n>0?(null===e.listIndex&&l(`Cannot expand dynamic dependency with wildcard for non-list address: ${e.pathInfo.path}`),a=e.listIndex.at(n-1)):a=null;const i={stateElement:t.stateElement,targetListIndexes:[],wildcardPaths:o.wildcardPaths,wildcardParentPaths:o.wildcardParentPaths,stateProxy:t.stateProxy,searchType:t.searchType};jn(i,n,a),s.push(...i.targetListIndexes)}else{null===e.listIndex&&l(`Cannot expand dynamic dependency with wildcard for non-list address: ${e.pathInfo.path}`);const t=e.listIndex.at(n-1);s.push(t)}}else s.push(null);for(const e of s){const n=Yt(o,e);t.result.add(n),r.push({address:n,depth:i})}}for(let t=r.length-1;t>=0;t--)o.push(r[t])}}(c,n,d),Array.from(c.result)}function zn(t,e,n,o,s,a){try{if(!(e.pathInfo.path in t)){const n=Ln(t,e.parentAddress??l(`address.parentAddress is undefined path: ${e.pathInfo.path}`),s,a),i=e.pathInfo.segments[e.pathInfo.segments.length-1];if(i===S){const t=e.listIndex?.index??l(`address.listIndex?.index is undefined path: ${e.pathInfo.path}`);return Reflect.set(n,t,o)}return Reflect.set(n,i,o)}if(!a.stateElement.setterPaths.has(e.pathInfo.path))return Reflect.set(t,e.pathInfo.path,o);a.pushAddress(e);try{return Reflect.set(t,e.pathInfo.path,o,s)}finally{a.popAddress()}}finally{const t=On();t.enqueueAbsoluteAddress(n),Bn(a.stateName,a.stateElement,e,a.stateElement.staticDependency,a.stateElement.dynamicDependency,a.stateElement.listPaths,s,"new",n=>{if(n===e)return;const o=Mt(At(a.stateElement,n.pathInfo),n.listIndex);En(o),t.enqueueAbsoluteAddress(o)})}}function qn(t,e,n,o,s,a){let i=e.parentAddress??l(`address.parentAddress is undefined path: ${e.pathInfo.path}`),r=function(t){return Dn.get(t)??null}(i);if(null===r){const e=Ln(t,i,s,a)??[],n=ae(e)??[];r={value:[...e],listIndexes:[...n]},Fn(i,r)}try{return zn(t,e,n,o,s,a)}finally{const n=r.value.indexOf(o),l=Ln(t,i,s,a)??[],d=Array.isArray(l)?ae(l)??[]:[],c=e.listIndex.index,u=-1!==n?r.listIndexes[n]:oe(i.listIndex,-1);d[c]=u;if(new Set(l).size===r.value.length){for(let t=0;t<d.length;t++)d[t].index=t;Fn(i,null)}}}function Un(t,e,n,o,s){const a=s.stateElement,i=a.elementPaths.has(e.pathInfo.path),r=e.pathInfo.wildcardCount>0||a.getterPaths.has(e.pathInfo.path),l=Mt(At(a,e.pathInfo),e.listIndex);try{return i?qn(t,e,l,n,o,s):zn(t,e,l,n,o,s)}finally{r&&kn(l,{value:n,dirty:!1})}}function Hn(t,e,n,o){return(e,s,a)=>{const i=k(e);if(o.addressStackLength>0){const t=o.lastAddressStack?.pathInfo??null,e=o.stateElement;null!==t&&t.path!==i.path&&e.getterPaths.has(t.path)&&e.addDynamicDependency(i.path,t.path)}i.wildcardParentPathInfos.length>s.length&&l(`indexes length is insufficient: ${e}`);let r=null;for(let e=0;e<i.wildcardParentPathInfos.length;e++){const a=i.wildcardParentPathInfos[e],d=Yt(a,r),c=ae(Ln(t,d,n,o));null==c&&l(`ListIndexes not found: ${a.path}`);r=c[s[e]]??l(`ListIndex not found: ${a.path}`)}const d=Yt(i,r);if(!(void 0!==a))return Ln(t,d,n,o);Un(t,d,a,n,o)}}const Vn=new WeakMap;function Jn(t,e,n,o){const s=e.pathInfo;switch(e.wildcardType){case"none":return null;case"context":return Wn(o,s.wildcardPaths.at(-1)??l(`lastWildcardPath is null: ${e.pathInfo.path}`))??l(`ListIndex not found: ${e.pathInfo.path}`);case"all":{let s=null;for(let a=0;a<e.pathInfo.wildcardCount;a++){const i=e.pathInfo.wildcardParentPathInfos[a]??l(`wildcardParentPathInfo is null: ${e.pathInfo.path}`);s=(ae(Ln(t,Yt(i,s),n,o))??l(`ListIndex not found: ${i.path}`))[e.wildcardIndexes[a]??l(`wildcardIndex is null: ${e.pathInfo.path}`)]??l(`ListIndex not found: ${i.path}`)}return s}case"partial":l(`Partial wildcard type is not supported yet: ${e.pathInfo.path}`)}}function Xn(t,e,n){void 0!==t.loopContext&&l("already in loop context"),t.setLoopContext(e);try{t.pushAddress(e);try{return n()}finally{t.popAddress()}}finally{t.clearLoopContext()}}function Kn(t,e,n,o){const s=_[e];if(void 0!==s){0===o.addressStackLength&&l(`No active state reference to get list index for "${e.toString()}".`);const t=o.lastAddressStack?.listIndex;return t?.indexes[s]??l(`ListIndex not found: ${e.toString()}`)}if("string"==typeof e){if("$"!==e[0]){const s=$n(e),a=Jn(t,s,n,o),i=Yt(s.pathInfo,a);return Ln(t,i,n,o)}switch(e){case"$stateElement":return o.stateElement;case"$getAll":return(e,s)=>function(t,e,n,o){const s=Hn(t,0,n,o);return(e,a)=>{const i=new Map,r=k(e);if(o.addressStackLength>0){const t=o.lastAddressStack?.pathInfo??null,e=o.stateElement;null!==t&&t.path!==r.path&&e.getterPaths.has(t.path)&&e.addDynamicDependency(r.path,t.path)}if(void 0===a){for(let t=0;t<r.wildcardParentPathInfos.length;t++){const e=r.wildcardParentPathInfos[t],n=Wn(o,e.path);if(n){a=n.indexes;break}}void 0===a&&(a=[])}const d=(e,s,a,r,c,u,f)=>{const h=e[s]??null;if(null===h)return void f.push(u);const p=Yt(h,a),m=Vn.get(p),g=Ln(t,p,n,o),w=de(a,m,g).newIndexes,I=r[c]??null;if(i.set(p,g),null===I)for(let t=0;t<w.length;t++){const n=w[t];d(e,s+1,n,r,c+1,u.concat(n.index),f)}else{const t=w[I]??l(`ListIndex not found: ${h.path}`);s+1<e.length?d(e,s+1,t,r,c+1,u.concat(t.index),f):f.push(u.concat(t.index))}},c=[];d(r.wildcardParentPathInfos,0,null,a,0,[],c);const u=[];for(let t=0;t<c.length;t++)u.push(s(r.path,c[t]));for(const[t,e]of i.entries())Vn.set(t,e);return u}}(t,0,n,o)(e,s);case"$postUpdate":return e=>function(t,e,n,o){const s=o.stateElement;return e=>{const a=$n(e),i=Jn(t,a,n,o),r=Yt(a.pathInfo,i),l=Mt(At(s,r.pathInfo),r.listIndex),d=On();d.enqueueAbsoluteAddress(l),Bn(o.stateName,o.stateElement,r,o.stateElement.staticDependency,o.stateElement.dynamicDependency,o.stateElement.listPaths,n,"new",t=>{const e=Mt(At(s,t.pathInfo),t.listIndex);En(e),d.enqueueAbsoluteAddress(e)})}}(t,0,n,o)(e);case"$resolve":return(e,s,a)=>Hn(t,0,n,o)(e,s,a);case"$trackDependency":return t=>function(t,e,n,o){return t=>{0===o.addressStackLength&&l(`No active state reference to track dependency for path "${t}".`);const e=o.lastAddressStack?.pathInfo??l("Internal error: lastAddressStack is null"),n=o.stateElement;o.stateElement.getterPaths.has(e.path)&&e.path!==t&&n.addDynamicDependency(t,e.path)}}(0,0,0,o)(t)}}else if("symbol"==typeof e){switch(e){case lt:return(t,e=async()=>{})=>async function(t,e,n){return await Xn(t,e,n)}(o,t,e);case dt:return(t,e=()=>{})=>function(t,e,n){return Xn(t,e,n)}(o,t,e);case ct:return e=>Ln(t,e,n,o);case ut:return(e,s)=>Un(t,e,s,n,o);case ft:return()=>async function(t,e,n){const o=Reflect.get(t,P);"function"==typeof o&&await o.call(n)}(t,0,n);case ht:return()=>function(t,e,n){const o=Reflect.get(t,v);"function"==typeof o&&o.call(n)}(t,0,n);case pt:return e=>function(t,e,n,o){const s=Reflect.get(t,"$updatedCallback");if("function"==typeof s){const t=new Set,a={};for(const n of e){const e=n.absolutePathInfo.pathInfo;let s;if(s=n.absolutePathInfo.stateName===o.stateName?e.path:e.path+"@"+n.absolutePathInfo.stateName,t.add(s),e.wildcardCount>0){const t=n.listIndex.indexes??[],e=a[s];void 0===e?a[s]=[t]:e.push(t)}}return s.call(n,Array.from(t),a)}}(t,e,n,o)}return Reflect.get(t,e,n)}}class Yn{_stateElement;_stateName;_addressStack=Array(x).fill(void 0);_addressStackIndex=-1;_loopContext;_mutability;constructor(t,e,n){this._stateName=e;const o=Nn(t,this._stateName);null===o&&l(`StateHandler: State element with name "${this._stateName}" not found.`),this._stateElement=o,this._mutability=n}get stateName(){return this._stateName}get stateElement(){return this._stateElement}get lastAddressStack(){let t;return this._addressStackIndex>=0&&(t=this._addressStack[this._addressStackIndex]),void 0===t&&l("Last address stack is undefined."),t}get addressStackLength(){return this._addressStackIndex+1}get loopContext(){return this._loopContext}pushAddress(t){this._addressStackIndex++,this._addressStackIndex>=x&&l("Exceeded maximum address stack depth of 128. Possible infinite loop."),this._addressStack[this._addressStackIndex]=t}popAddress(){if(this._addressStackIndex<0)return null;const t=this._addressStack[this._addressStackIndex];return void 0===t&&l(`Address stack at index ${this._addressStackIndex} is undefined.`),this._addressStack[this._addressStackIndex]=void 0,this._addressStackIndex--,t}setLoopContext(t){this._loopContext=t}clearLoopContext(){this._loopContext=void 0}get(t,e,n){return Kn(t,e,n,this)}set(t,e,n,o){return"readonly"===this._mutability&&l(`State "${this._stateName}" is readonly.`),function(t,e,n,o,s){if("string"==typeof e){const a=$n(e),i=Jn(t,a,o,s);return Un(t,Yt(a.pathInfo,i),n,o,s)}return Reflect.set(t,e,n,o)}(t,e,n,o,this)}has(t,e){return Reflect.has(t,e)}}const Gn=new WeakMap;const Qn=new WeakMap;function Zn(t,e){const n=Qn.get(t);return n?n.get(e)??null:null}const to=new WeakMap,eo=new WeakMap,no=new WeakMap,oo=new WeakMap;function so(t,e){return{innerAbsPathInfo:At(t,k(e.propSegments.slice(1).join(y))),outerAbsPathInfo:Bt(e).absolutePathInfo}}function ao(t,e){let n=to.get(t);if(void 0===n&&(n=new Map,to.set(t,n)),n.has(e))return n.get(e);let o=eo.get(t);void 0===o&&(o=new Map,eo.set(t,o));const s=no.get(t);void 0===s&&l("Primary mapping rule set not found for web component.");let a=null;for(const t of s)if(e.pathInfo.cumulativePathInfoSet.has(t.innerAbsPathInfo.pathInfo)){t.innerAbsPathInfo.pathInfo.segments.length===e.pathInfo.segments.length&&l("Duplicate mapping rule for web component."),a=t;break}null===a&&l(`Mapping rule not found for inner path "${e.pathInfo.path}". Did you forget to bind this property in the component's data-wcs attribute? Available mappings: ${Array.from(s).map(t=>t.innerAbsPathInfo.pathInfo.path).join(", ")}`);const i=oo.get(a);void 0===i&&l("Binding not found for primary mapping rule on web component.");const r=e.pathInfo.segments.slice(a.innerAbsPathInfo.pathInfo.segments.length),d=k(a.outerAbsPathInfo.pathInfo.segments.concat(r).join(y)),c=Nn(t.getRootNode(),i.stateName);null===c&&l(`State element with name "${i.stateName}" not found for web component.`);const u=At(c,d);n.set(e,u),o.set(u,e);return function(t,e){const n=I(t);null===n?b(t,[e]):n.push(e)}(t,{...i,propName:e.pathInfo.path,propSegments:e.pathInfo.segments,statePathName:u.pathInfo.path,statePathInfo:u.pathInfo}),u}function io(t){return function(t){const e=Object.getPrototypeOf(t),n=Object.create(e),o=Object.getOwnPropertyDescriptors(t);for(const t in o){const e=o[t];!1===e.writable&&(e.writable=!0)}return Object.defineProperties(n,o),n}(t)}class ro{_webComponent;_innerStateElement;constructor(t,e){this._webComponent=t,this._innerStateElement=Zn(t,e)??l("State element not found for web component.")}get(t,e,n){if("string"==typeof e){if("then"===e)return;if(e in t)return Reflect.get(t,e,n);if("$"===e[0])return;const o=k(e),s=At(this._innerStateElement,o),a=ao(this._webComponent,s);null===a&&l(`Outer path info not found for inner path "${s.pathInfo.path}" on web component.`);const i=it(this._webComponent);let r;return a.stateElement.createState("readonly",t=>{t[dt](i,()=>{r=t[a.pathInfo.path];let e=null;null!==i&&null!==i.listIndex&&a.pathInfo.wildcardCount>0&&(e=i.listIndex.at(a.pathInfo.wildcardCount-1));!function(t,e){Gn.set(t,e)}(Mt(a,e),r)})}),r}return Reflect.get(t,e,n)}set(t,e,n,o){if("string"==typeof e){const t=k(e),o=At(this._innerStateElement,t),s=ao(this._webComponent,o);null===s&&l(`Outer path info not found for inner path "${o.pathInfo.path}" on web component.`);const a=it(this._webComponent);return s.stateElement.createState("writable",t=>{t[dt](a,()=>{t[s.pathInfo.path]=n})}),!0}return Reflect.set(t,e,n,o)}has(t,e){if("string"==typeof e){if(e in t)return Reflect.has(t,e);if("$"===e[0])return!1;const n=k(e),o=At(this._innerStateElement,n);return null!==ao(this._webComponent,o)}return Reflect.has(t,e)}}class lo{_innerStateElement;constructor(t,e){this._innerStateElement=Zn(t,e)??l("State element not found for web component.")}get(t,e,n){if("string"==typeof e){const t=k(e),n=Mt(At(this._innerStateElement,t),null);return o=n,Gn.get(o)}return Reflect.get(t,e,n);var o}set(t,e,n,o){if("string"==typeof e){const t=k(e),n=At(this._innerStateElement,t);return this._innerStateElement.createState("readonly",t=>{t.$postUpdate(n.pathInfo.path)}),!0}return Reflect.set(t,e,n,o)}}class co{_innerStateElement;constructor(t,e){this._innerStateElement=Zn(t,e)??l("State element not found for web component.")}get(t,e,n){if("string"==typeof e){let t;return this._innerStateElement.createState("readonly",n=>{t=n[e]}),t}return Reflect.get(t,e,n)}set(t,e,n,o){return"string"==typeof e?(this._innerStateElement.createState("writable",t=>{t[e]=n}),!0):Reflect.set(t,e,n,o)}}const uo=t=>()=>t;function fo(e,n,o,s){if(null===n.shadowRoot&&l("Component has no shadow root."),function(t,e,n){let o=Qn.get(t);o||(o=new Map,Qn.set(t,o)),o.set(e,n)}(n,o,e),n.hasAttribute(t)){const t=(I(n)??[]).filter(t=>t.propSegments[0]===o);!function(t,e,n){if(0===n.length)return;const o=Zn(t,e);null===o&&l("State element not found for web component.");const s=new Map,a=new Map;for(const e of n){const n=so(o,e);let i=no.get(t);void 0===i?no.set(t,new Set([n])):i.add(n);const r=n.innerAbsPathInfo,l=n.outerAbsPathInfo;oo.set(n,e),s.set(r,l),a.set(l,r)}to.set(t,s),eo.set(t,a)}(n,o,t);const s=function(t,e){const n=new lo(t,e);return new Proxy({},n)}(n,o),a=function(t,e){const n=new ro(t,e),o=Zn(t,e);null===o&&l("State element not found for web component."),null===o.boundComponentStateProp&&l("State element is not bound to any component state prop."),o.boundComponentStateProp in t||l(`State element is not bound to a valid component state prop: ${o.boundComponentStateProp}`);const s=t[o.boundComponentStateProp];return"object"==typeof s&&null!==s||l(`Invalid state object for component state prop: ${o.boundComponentStateProp}`),new Proxy(io(s),n)}(n,o);e.setInitialState(a),Object.defineProperty(n,o,{get:uo(s),enumerable:!0,configurable:!0})}else{e.setInitialState(io(s));const t=function(t,e){const n=new co(t,e);return new Proxy({},n)}(n,o);Object.defineProperty(n,o,{get:uo(t),enumerable:!0,configurable:!0})}if(function(t,e){let n=Ut.get(t);n||(n=new WeakMap,Ut.set(t,n)),n.set(e,!0)}(n,e),A in n){const t=n[A];"function"==typeof t?t.call(n,o).catch(t=>{l(`Error in ${A}: ${t instanceof Error?t.message:String(t)}`)}):l(`${A} is not a function.`)}}function ho(t){const e=new Set,n=new Set,o=function(t){let e={},n=t;for(;n&&n!==Object.prototype;)Object.assign(e,Object.getOwnPropertyDescriptors(n)),n=Object.getPrototypeOf(n);return e}(t);for(const[t,s]of Object.entries(o))"function"==typeof s.get&&e.add(t),"function"==typeof s.set&&n.add(t);return{getterPaths:e,setterPaths:n}}class po extends HTMLElement{__state;_name="default";_initialized=!1;_initializePromise;_resolveInitialize=null;_loadingPromise;_resolveLoading=null;_setStatePromise=null;_resolveSetState=null;_listPaths=new Set;_elementPaths=new Set;_getterPaths=new Set;_setterPaths=new Set;_loopContextStack=function(){return new Pn}();_dynamicDependency=new Map;_staticDependency=new Map;_pathSet=new Set;_version=0;_rootNode=null;_boundComponent=null;_boundComponentStateProp=null;constructor(){super(),this._initializePromise=new Promise(t=>{this._resolveInitialize=t}),this._loadingPromise=new Promise(t=>{this._resolveLoading=t}),this._setStatePromise=new Promise(t=>{this._resolveSetState=t})}get _state(){return void 0===this.__state&&l(`${i.state} _state is not initialized yet.`),this.__state}set _state(t){this.__state=t,this._listPaths.clear(),this._elementPaths.clear(),this._getterPaths.clear(),this._pathSet.clear();const e=ho(t);for(const t of e.getterPaths)this._getterPaths.add(t);for(const t of e.setterPaths)this._setterPaths.add(t);this._resolveLoading?.()}get name(){return this._name}async _initialize(){try{if(this.hasAttribute("state")){const t=this.getAttribute("state");this._state=function(t){const e=document.getElementById(t);if(e&&"application/json"===e.type)try{return JSON.parse(e.textContent||"{}")}catch(t){l("Failed to parse JSON from script element:"+t)}return{}}(t)}else if(this.hasAttribute("src")){const t=this.getAttribute("src");t&&t.endsWith(".json")?this._state=await async function(t){try{const e=await fetch(t);return e.ok||l(`Failed to fetch JSON file: ${e.statusText}`),await e.json()}catch(t){return console.error("Failed to load JSON file:",t),{}}}(t):t&&t.endsWith(".js")?this._state=await async function(t){try{return(await import(t)).default||{}}catch(t){l(`Failed to load script file: ${t}`)}}(t):l(`Unsupported src file type: ${t}`)}else if(this.hasAttribute("json")){const t=this.getAttribute("json");this._state=JSON.parse(t)}else{const t=this.querySelector('script[type="module"]');if(t)this._state=await async function(t,e){let n=null;const o=`\n//# sourceURL=${e}\n`;if("function"==typeof URL.createObjectURL){const e=new Blob([t.text+o],{type:"application/javascript"}),s=URL.createObjectURL(e);try{n=await import(s)}finally{URL.revokeObjectURL(s)}}else{const e=btoa(String.fromCodePoint(...(new TextEncoder).encode(t.text+o)));n=await import(`data:application/javascript;base64,${e}`)}return n&&"object"==typeof n.default?n.default:{}}(t,`state#${this._name}`);else{const t=setTimeout(()=>{console.warn(`[@wcstack/state] Warning: No state source found for <${i.state}> element with name="${this._name}".`)},6e4);this._state=await this._setStatePromise,clearTimeout(t)}}}catch(t){l(`Failed to initialize state: ${t}`)}await this._loadingPromise,this._name=this.getAttribute("name")||"default",_n(this.rootNode,this._name,this)}async _initializeBindWebComponent(){if(this.hasAttribute("bind-component")){this.rootNode instanceof ShadowRoot||l('"bind-component" can only be used inside a shadow root.');const e=this.rootNode.host,n=this.getAttribute("bind-component");await customElements.whenDefined(e.tagName.toLowerCase()),e.hasAttribute(t)&&await f(e),n in e||l(`Component does not have property "${n}" for state binding.`);const o=e[n];"object"==typeof o&&null!==o||l(`Component property "${n}" is not an object for state binding.`),this._boundComponent=e,this._boundComponentStateProp=n,fo(this,this._boundComponent,this._boundComponentStateProp,o)}}async _callStateConnectedCallback(){await this.createStateAsync("writable",async t=>{P in t&&await t[ft]()})}_callStateDisconnectedCallback(){this.createState("writable",t=>{v in t&&t[ht]()})}async connectedCallback(){this._rootNode=this.getRootNode(),this._initialized||(await this._initializeBindWebComponent(),await this._initialize(),this._initialized=!0,this._resolveInitialize?.()),await this._callStateConnectedCallback()}disconnectedCallback(){null!==this._rootNode&&(this._callStateDisconnectedCallback(),_n(this.rootNode,this._name,null),this._rootNode=null)}get initializePromise(){return this._initializePromise}get listPaths(){return this._listPaths}get elementPaths(){return this._elementPaths}get getterPaths(){return this._getterPaths}get setterPaths(){return this._setterPaths}get loopContextStack(){return this._loopContextStack}get dynamicDependency(){return this._dynamicDependency}get staticDependency(){return this._staticDependency}get version(){return this._version}get rootNode(){return null===this._rootNode&&l("State rootNode is not available."),this._rootNode}get boundComponentStateProp(){return this._boundComponentStateProp}_addDependency(t,e,n){const o=t.get(e);return void 0===o?(t.set(e,[n]),!0):!o.includes(n)&&(o.push(n),!0)}addDynamicDependency(t,e){return this._addDependency(this._dynamicDependency,t,e)}addStaticDependency(t,e){return this._addDependency(this._staticDependency,t,e)}setPathInfo(t,e){if("for"===e&&(this._listPaths.add(t),this._elementPaths.add(t+"."+S)),!this._pathSet.has(t)){const e=k(t);if(this._pathSet.add(t),null!==e.parentPath){let t=e;for(;null!==t.parentPath&&this.addStaticDependency(t.parentPath,t.path);)t=k(t.parentPath)}}}_createState(t,e,n){try{const o=function(t,e,n,o){const s=new Yn(t,n,o);return new Proxy(e,s)}(t,this._state,this._name,e);return n(o)}finally{}}async createStateAsync(t,e){return await this._createState(this.rootNode,t,e)}createState(t,e){this._createState(this.rootNode,t,e)}nextVersion(){return this._version++,this._version}bindProperty(t,e){Object.defineProperty(this._state,t,e)}setInitialState(t){this._initialized?this._state=t:this._resolveSetState?.(t)}}function mo(){customElements.get(i.state)||customElements.define(i.state,po)}export{mo as bootstrapState};
//# sourceMappingURL=index.esm.min.js.map
