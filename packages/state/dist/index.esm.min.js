const t="data-bind-state",e="wcs-text",n="wcs-for",i="wcs-if",s="wcs-elseif",o="wcs-else",a={state:"wcs-state"};function r(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function l(t){throw new Error(`[@wcstack/state] ${t}`)}const d=".",c={};function h(t){if(c[t])return c[t];const e=new u(t);return c[t]=e,e}class u{path="";segments=[];wildcardPositions=[];wildcardPaths=[];wildcardParentPaths=[];wildcardPathInfos=[];wildcardParentPathInfos=[];_parentPathInfo=void 0;constructor(t){this.path=t,this.segments=t.split(d).filter(t=>t.length>0),this.wildcardPositions=this.segments.map((t,e)=>"*"===t?e:-1).filter(t=>-1!==t),this.wildcardPaths=this.wildcardPositions.map(t=>this.segments.slice(0,t+1).join(d)),this.wildcardParentPaths=this.wildcardPositions.map(t=>this.segments.slice(0,t).join(d)),this.wildcardPathInfos=this.wildcardPaths.map(e=>e===t?this:h(e)),this.wildcardParentPathInfos=this.wildcardParentPaths.map(e=>e===t?this:h(e))}get parentPathInfo(){if(void 0!==this._parentPathInfo)return this._parentPathInfo;if(0===this.segments.length)return null;const t=this.segments.slice(0,-1).join(d);return this._parentPathInfo=h(t),this._parentPathInfo}}const f=new WeakMap;function p(t){return f.get(t)||null}function g(t,e){null!==e?f.set(t,e):f.delete(t)}let _=0;class m{uuid=r();parentListIndex;position;length;_index;_version;_indexes;_listIndexes;constructor(t,e){this.parentListIndex=t,this.position=t?t.position+1:0,this.length=this.position+1,this._index=e,this._version=_}get index(){return this._index}set index(t){this._index=t,this._version=++_,this.indexes[this.position]=t}get version(){return this._version}get dirty(){return null!==this.parentListIndex&&(this.parentListIndex.dirty||this.parentListIndex.version>this._version)}get indexes(){return null===this.parentListIndex?void 0===this._indexes&&(this._indexes=[this._index]):(void 0===this._indexes||this.dirty)&&(this._indexes=[...this.parentListIndex.indexes,this._index],this._version=_),this._indexes}get listIndexes(){return null===this.parentListIndex?void 0===this._listIndexes&&(this._listIndexes=[new WeakRef(this)]):void 0===this._listIndexes&&(this._listIndexes=[...this.parentListIndex.listIndexes,new WeakRef(this)]),this._listIndexes}get varName(){return`$${this.position+1}`}at(t){return t>=0?this.listIndexes[t]?.deref()||null:this.listIndexes[this.listIndexes.length+t]?.deref()||null}}function x(t,e){return new m(t,e)}function y(t,e){const n=[];for(let i=0;i<t.length;i++)n.push(x(e,i));return n}function N(t,e,n){if(0===e.length)return;const i=e[0];"class"===i?function(t,e,n){"boolean"!=typeof n&&l("Invalid value for class application: expected boolean, got "+typeof n),t.classList.toggle(e,n)}(t,e[1],n):"attr"===i?function(t,e,n){t.getAttribute(e)!==n&&t.setAttribute(e,n)}(t,e[1],n):"style"===i?function(t,e,n){const i=t.style;i[e]!==n&&(i[e]=n)}(t,e[1],n):1===e.length?function(t,e,n){t[e]!==n&&(t[e]=n)}(t,i,n):function(t,e,n){let i=t[e[0]];for(let t=1;t<e.length-1;t++){const n=e[t];if(null==i)return;i=i[n]}i[e[e.length-1]]!==n&&(i[e[e.length-1]]=n)}(t,e,n)}class w{_content;_childNodeArray=[];_firstNode=null;_lastNode=null;constructor(t){this._content=t,this._childNodeArray=Array.from(this._content.childNodes),this._firstNode=this._childNodeArray.length>0?this._childNodeArray[0]:null,this._lastNode=this._childNodeArray.length>0?this._childNodeArray[this._childNodeArray.length-1]:null}get firstNode(){return this._firstNode}get lastNode(){return this._lastNode}mountAfter(t){const e=t.parentNode,n=t.nextSibling;e&&this._childNodeArray.forEach(t=>{e.insertBefore(t,n)})}unmount(){this._childNodeArray.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)})}}function P(t){return new w(t)}const b=new Map;function I(t,e){null===e?b.delete(t):b.set(t,e)}const v=new WeakMap,L=new WeakMap;function S(t,e,n){const i=function(t){return b.get(t)||null}(e);i||l(`Fragment with UUID "${e}" not found.`),v.get(t);const s=Array.isArray(n)?n:[],o=p(s)||[];t.parentNode,t.nextSibling;const a=L.get(t)||[];for(const t of a)t.unmount();let r=t;for(const t of o){const t=P(document.importNode(i,!0));t.mountAfter(r),r=t.lastNode||r}L.set(t,[]),v.set(t,s)}function T(t,e){if("text"===t.bindingType)!function(t,e){t.nodeValue!==e&&(t.nodeValue=e)}(t.placeHolderNode,e);else if("prop"===t.bindingType)N(t.node,t.propSegments,e);else if("for"===t.bindingType){if(!t.uuid)throw new Error("BindingInfo for 'for' binding must have a UUID.");S(t.node,t.uuid,e)}}class E{_bindingInfosByPath;_listPaths;constructor(t,e){this._bindingInfosByPath=t,this._listPaths=e}_getNestValue(t,e,n){let i=e;if(i.path in t)return Reflect.get(t,i.path,n);const s=i.parentPathInfo;if(null===s)return;const o=this._getNestValue(t,s,n),a=i.segments[i.segments.length-1];return a in o?Reflect.get(o,a):void console.warn(`[@wcstack/state] Property "${e.path}" does not exist on state.`)}get(t,e,n){let i;try{if("string"==typeof e){const s=h(e);if(s.segments.length>1)return i=this._getNestValue(t,s,n)}return e in t?i=Reflect.get(t,e,n):void console.warn(`[@wcstack/state] Property "${String(e)}" does not exist on state.`)}finally{if("string"==typeof e&&this._listPaths.has(e)&&null===p(i)){g(i,y(i??[],null))}}}set(t,e,n,i){let s=!1;if("string"==typeof e){const o=h(e);if(o.segments.length>1){if(null===o.parentPathInfo)return!1;const e=this._getNestValue(t,o.parentPathInfo,i),a=o.segments[o.segments.length-1];s=Reflect.set(e,a,n)}else s=Reflect.set(t,e,n,i);if(this._bindingInfosByPath.has(String(e))){const t=this._bindingInfosByPath.get(String(e))||[];for(const e of t)T(e,n)}}else s=Reflect.set(t,e,n,i);if("string"==typeof e&&this._listPaths.has(e)){g(n,y(n??[],null))}return s}}const M=new Map;const A=new Map;function C(t){const e=A.get(t)||null;if(null===e&&"default"===t){const t=document.querySelector(`${a.state}:not([name])`);if(t instanceof R)return A.set("default",t),t}return e}function k(t,e){null===e?A.delete(t):A.set(t,e)}class R extends HTMLElement{_uuid=r();_state;_proxyState;_name="default";_initialized=!1;_bindingInfosByPath=new Map;_initializePromise;_resolveInitialize=null;_listPaths=new Set;_isLoadingState=!1;_isLoadedState=!1;static get observedAttributes(){return["name","src","state"]}constructor(){var t,e;super(),t=this._uuid,null===(e=this)?M.delete(t):M.set(t,e),this._initializePromise=new Promise(t=>{this._resolveInitialize=t})}get uuid(){return this._uuid}get state(){var t,e,n;return void 0===this._state&&l(`${a.state} _state is not initialized yet.`),void 0===this._proxyState&&(this._proxyState=(t=this._state,e=this._bindingInfosByPath,n=this._listPaths,new Proxy(t,new E(e,n)))),this._proxyState}get name(){return this._name}attributeChangedCallback(t,e,n){"name"===t&&e!==n&&(k(this._name,null),this._name=n,k(this._name,this)),"state"===t&&e!==n&&(this._isLoadedState&&l("The state has already been loaded. The 'state' attribute cannot be changed multiple times."),this._isLoadingState&&l("The state is currently loading. The 'state' attribute cannot be changed during loading."),this._state=function(t){const e=document.getElementById(t);if(e&&"application/json"===e.type)try{return JSON.parse(e.textContent||"{}")}catch(t){l("Failed to parse JSON from script element:"+t)}return{}}(n),this._isLoadedState=!0),"src"===t&&e!==n&&(this._isLoadedState&&l("The state has already been loaded. The 'src' attribute cannot be changed multiple times."),this._isLoadingState&&l("The state is currently loading. The 'src' attribute cannot be changed during loading."),n&&n.endsWith(".json")?(this._isLoadingState=!0,async function(t){try{const e=await fetch(t);return e.ok||l(`Failed to fetch JSON file: ${e.statusText}`),await e.json()}catch(t){return console.error("Failed to load JSON file:",t),{}}}(n).then(t=>{this._isLoadedState=!0,this._state=t}).finally(()=>{this._isLoadingState=!1})):n&&n.endsWith(".js")?(this._isLoadingState=!0,async function(t){try{return(await import(t)).default||{}}catch(t){l(`Failed to load script file: ${t}`)}}(n).then(t=>{this._isLoadedState=!0,this._state=t}).finally(()=>{this._isLoadingState=!1})):l(`Unsupported src file type: ${n}`))}async _initialize(){if(!this._isLoadedState&&!this._isLoadingState){this._isLoadingState=!0;try{const t=this.querySelector('script[type="module"]');t&&(this._state=await async function(t,e){let n=null;const i=`\n//# sourceURL=${e}\n`;if("function"==typeof URL.createObjectURL){const e=new Blob([t.text+i],{type:"application/javascript"}),s=URL.createObjectURL(e);try{n=await import(s)}finally{URL.revokeObjectURL(s)}}else{const e=btoa(String.fromCodePoint(...(new TextEncoder).encode(t.text+i)));n=await import(`data:application/javascript;base64,${e}`)}return n&&"object"==typeof n.default?n.default:{}}(t,`state#${this._name}`),this._isLoadedState=!0)}catch(t){l(`Failed to load state from inner script: ${t.message}`)}finally{this._isLoadingState=!1}}void 0===this._state&&(this._state={})}async connectedCallback(){this._initialized||(await this._initialize(),this._initialized=!0,this._resolveInitialize?.())}disconnectedCallback(){k(this._name,null)}get bindingInfosByPath(){return this._bindingInfosByPath}get initializePromise(){return this._initializePromise}get listPaths(){return this._listPaths}addBindingInfo(t){const e=t.statePathName,n=this._bindingInfosByPath.get(e);void 0===n?this._bindingInfosByPath.set(e,[t]):n.push(t),"for"===t.bindingType&&this._listPaths.add(e)}}const $=new Set(["if","elseif","else","for"]),F=t=>t.trim();function O(t){const[e,...n]=t.split("|").map(F),[i,s="default"]=e.split("@").map(F);return{stateName:s,statePathName:i,statePathInfo:h(i),filterTexts:n}}function W(t){const[...e]=t.split(";").map(F).filter(t=>t.length>0),n=e.map(t=>{const e=t.indexOf(":");-1===e&&l(`Invalid bindText: "${t}". Missing ':' separator between propPart and statePart.`);const n=t.slice(0,e).trim(),i=t.slice(e+1).trim();if("else"===n)return{propName:"else",propSegments:["else"],propModifiers:[],statePathName:"",statePathInfo:null,stateName:"",filterTexts:[],bindingType:"else"};if("if"===n||"elseif"===n||"for"===n){return{propName:n,propSegments:[n],propModifiers:[],...O(i),bindingType:n}}{const t=O(i),e=function(t){const[e,n]=t.split("#").map(F),i=e.split(".").map(F);return{propName:e,propSegments:i,propModifiers:n?n.split(",").map(F):[]}}(n);return e.propSegments[0].startsWith("on")?{...e,...t,bindingType:"event"}:{...e,...t,bindingType:"prop"}}});if(n.length>1){n.some(t=>$.has(t.bindingType))&&l(`Invalid bindText: "${t}". 'if', 'elseif', 'else', and 'for' bindings must be single binding.`)}return n}const B=new WeakMap,U=new Set([e,n,i,s,o]),z=new RegExp("^\\s*@@\\s*(.+?)\\s*:\\s*(.+?)\\s*$");const j=new Map;function D(t,e){null===e?j.delete(t):j.set(t,e)}function H(e){const n=[];if(e.nodeType===Node.ELEMENT_NODE){const i=e,s=W(i.getAttribute(t)||"");for(const t of s)n.push({...t,node:e,placeHolderNode:i,uuid:null})}else if(e.nodeType===Node.COMMENT_NODE){const t=function(t){return B.get(t)||null}(e);null===t&&l("Comment node binding text not found.");let i=function(t){return j.get(t)||null}(t),s=null;null===i?(i={propName:"textContent",propSegments:["textContent"],propModifiers:[],...O(t),bindingType:"text"},s=null):s=t;let o=e;"text"===i.bindingType&&(o=document.createTextNode("")),n.push({...i,node:e,placeHolderNode:o,uuid:s})}return n}function V(e){const n=[],i=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT,{acceptNode(e){if(e.nodeType===Node.ELEMENT_NODE){return e.hasAttribute(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}return function(t){if(t.nodeType!==Node.COMMENT_NODE)return!1;const e=t.data.trim(),n=z.exec(e);return null!==n&&!!U.has(n[1])&&(B.set(t,n[2]),!0)}(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;i.nextNode();)n.push(i.currentNode);return n}const J=new Set(["radio","checkbox"]),K=new Set(["value","valueAsNumber","valueAsDate"]);function q(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const n=t,i=n.tagName.toLowerCase();if("input"===i){const t=(n.getAttribute("type")||"text").toLowerCase();if("button"===t)return!1;if(J.has(t)&&"checked"===e)return!0;if(K.has(e))return!0}return"select"===i&&"value"===e||"textarea"===i&&"value"===e}const G=new WeakMap;function Q(t){const e=t.node,n=t.placeHolderNode;e!==n&&null!==e.parentNode&&e.parentNode.replaceChild(n,e)}const X=new WeakSet;async function Y(t,e){const n=V(t),i=[];n.forEach(t=>{if(!X.has(t)){X.add(t),function(t){G.delete(t)}(t);const e=H(t);i.push(...e)}});const s=[],o=new Map;for(const t of i){const e=C(t.stateName);if(null===e&&l(`State element with name "${t.stateName}" not found for binding.`),Q(t),t.propName.startsWith("on")){const n=t.propName.slice(2);t.node.addEventListener(n,n=>{const i=e.state[t.statePathName];"function"==typeof i&&i.call(e.state,n)});continue}if(q(t.node,t.propName)&&-1===t.propModifiers.indexOf("ro")){let n="select"===t.node.tagName.toLowerCase()?"change":"input";for(const e of t.propModifiers)e.startsWith("on")&&(n=e.slice(2));t.node.addEventListener(n,n=>{const i=n.target;if(void 0===i)return void console.warn("[@wcstack/state] event.target is undefined.");if(!(t.propName in i))return void console.warn(`[@wcstack/state] Property "${t.propName}" does not exist on target element.`);const s=i[t.propName];e.state[t.statePathName]=s})}e.addBindingInfo(t);let n=o.get(e);void 0===n&&(n=new Map,o.set(e,n));const i=n.get(t.statePathName);if(void 0!==i){s.push({bindingInfo:t,value:i});continue}await e.initializePromise;const a=e.state[t.statePathName];s.push({bindingInfo:t,value:a}),n.set(t.statePathName,a)}for(const t of s)T(t.bindingInfo,t.value)}const Z=new Map([["for",n],["if",i],["elseif",s],["else",o]]);function tt(e){const n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode(e){if(e instanceof HTMLTemplateElement){if((e.getAttribute(t)||"").length>0)return NodeFilter.FILTER_ACCEPT}return NodeFilter.FILTER_SKIP}});for(;n.nextNode();){const e=n.currentNode,i=W(e.getAttribute(t)||"")[0],s=e.content,o=r();I(o,s),D(o,i);const a=Z.get(i.bindingType);if(void 0===a)continue;const l=document.createComment(`@@${a}:${o}`);e.replaceWith(l),tt(s)}}function et(){document.addEventListener("DOMContentLoaded",async()=>{tt(document),await Y(document.body)})}function nt(){customElements.get(a.state)||customElements.define(a.state,R),et()}export{nt as bootstrapState};
//# sourceMappingURL=index.esm.min.js.map
