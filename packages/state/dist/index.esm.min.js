const t="data-bind-state",e="wcs-text",n="wcs-for",s="wcs-if",i="wcs-elseif",o="wcs-else",r={state:"wcs-state"},a="en";function l(t){throw new Error(`[@wcstack/state] ${t}`)}const d=new Map;function c(t){const e=d.get(t)||null;if(null===e&&"default"===t){const t=document.querySelector(`${r.state}:not([name])`);if(t instanceof Dt)return d.set("default",t),t}return e}function u(t,e){null===e?d.delete(t):d.set(t,e)}class h{_loopContextStack=[];createLoopContext(t,e,n){const s=this._loopContextStack[this._loopContextStack.length-1];if(void 0!==s){s.elementPathInfo.wildcardCount+1!==t.wildcardCount&&l("Cannot push loop context for a list whose wildcard count is not exactly one more than the current active loop context.");const e=t.wildcardParentPathInfos[t.wildcardParentPathInfos.length-1];s.elementPathInfo!==e&&l("Cannot push loop context for a list whose parent wildcard path info does not match the current active loop context.")}else 1!==t.wildcardCount&&l("Cannot push loop context for a list with wildcard positions when there is no active loop context.");const i={elementPathInfo:t,listIndex:e};let o;this._loopContextStack.push(i);try{o=n(i)}finally{if(o instanceof Promise)return o.finally(()=>{this._loopContextStack.pop()});this._loopContextStack.pop()}return o}}const f="*",p={};function m(t){if(p[t])return p[t];const e=new g(t);return p[t]=e,e}class g{path;segments;lastSegment;cumulativePaths;cumulativePathSet;cumulativePathInfos;cumulativePathInfoSet;parentPath;wildcardPaths;wildcardPathSet;indexByWildcardPath;wildcardPathInfos;wildcardPathInfoSet;wildcardParentPaths;wildcardParentPathSet;wildcardParentPathInfos;wildcardParentPathInfoSet;wildcardPositions;lastWildcardPath;lastWildcardInfo;wildcardCount;parentPathInfo;constructor(t){const e=e=>t===e?this:m(e),n=t.split("."),s=[],i=[],o=[],r={},a=[],l=[],d=[],c=[];let u="",h="",p=0;for(let t=0;t<n.length;t++)u+=n[t],n[t]===f&&(o.push(u),r[u]=p,a.push(e(u)),l.push(h),d.push(e(h)),c.push(t),p++),s.push(u),i.push(e(u)),h=u,u+=".";const g=o.length>0?o[o.length-1]:null,_=s.length>1?s[s.length-2]:null;this.path=t,this.segments=n,this.lastSegment=n[n.length-1],this.cumulativePaths=s,this.cumulativePathSet=new Set(s),this.cumulativePathInfos=i,this.cumulativePathInfoSet=new Set(i),this.wildcardPaths=o,this.wildcardPathSet=new Set(o),this.indexByWildcardPath=r,this.wildcardPathInfos=a,this.wildcardPathInfoSet=new Set(a),this.wildcardParentPaths=l,this.wildcardParentPathSet=new Set(l),this.wildcardParentPathInfos=d,this.wildcardParentPathInfoSet=new Set(d),this.wildcardPositions=c,this.lastWildcardPath=g,this.lastWildcardInfo=g?e(g):null,this.parentPath=_,this.parentPathInfo=_?e(_):null,this.wildcardCount=p}}const _=new Map;class x{path;segments;paths;wildcardCount;wildcardType;wildcardIndexes;pathInfo;constructor(t){const e=t.split("."),n=e.slice(),s=[];let i=0,o=0,r="",a=0,l="none";const d=[];for(let t=0;t<e.length;t++){const l=e[t];if("*"===l)n[t]="*",d.push(null),i++,a++;else{const e=Number(l);Number.isNaN(e)||(n[t]="*",d.push(e),o++,a++)}r+=l,s.push(r),r+=t<l.length-1?".":""}const c=m(n.join("."));(i>0||o>0)&&(l=i===a?"context":o===a?"all":"partial"),this.path=t,this.segments=e,this.paths=s,this.wildcardCount=a,this.wildcardType=l,this.wildcardIndexes=d,this.pathInfo=c}}function y(t){let e;return _.get(t)??(_.set(t,e=new x(t)),e)}const I=new WeakMap,w=new WeakMap;class v{pathInfo;listIndex;_parentAddress;constructor(t,e){this.pathInfo=t,this.listIndex=e}get parentAddress(){if(void 0!==this._parentAddress)return this._parentAddress;const t=this.pathInfo.parentPathInfo;if(null===t)return null;let e=null;return e=this.pathInfo.segments[this.pathInfo.segments.length-1]===f?this.listIndex?.parentListIndex??null:this.listIndex,this._parentAddress=N(t,e)}}function N(t,e){if(null===e){let e=w.get(t);return void 0!==e||(e=new v(t,null),w.set(t,e)),e}{let n=I.get(e);void 0===n&&(n=new WeakMap,I.set(e,n));let s=n.get(t);return void 0!==s||(s=new v(t,e),n.set(t,s)),s}}function S(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}let P=0;class b{uuid=S();parentListIndex;position;length;_index;_version;_indexes;_listIndexes;constructor(t,e){this.parentListIndex=t,this.position=t?t.position+1:0,this.length=this.position+1,this._index=e,this._version=P}get index(){return this._index}set index(t){this._index=t,this._version=++P,this.indexes[this.position]=t}get version(){return this._version}get dirty(){return null!==this.parentListIndex&&(this.parentListIndex.dirty||this.parentListIndex.version>this._version)}get indexes(){return null===this.parentListIndex?void 0===this._indexes&&(this._indexes=[this._index]):(void 0===this._indexes||this.dirty)&&(this._indexes=[...this.parentListIndex.indexes,this._index],this._version=P),this._indexes}get listIndexes(){return null===this.parentListIndex?void 0===this._listIndexes&&(this._listIndexes=[new WeakRef(this)]):void 0===this._listIndexes&&(this._listIndexes=[...this.parentListIndex.listIndexes,new WeakRef(this)]),this._listIndexes}get varName(){return`$${this.position+1}`}at(t){return t>=0?this.listIndexes[t]?.deref()||null:this.listIndexes[this.listIndexes.length+t]?.deref()||null}}function L(t,e){return new b(t,e)}const C=new WeakMap;function A(t){return C.get(t)||null}function $(t,e,n,s,i){let o;if(!(e.pathInfo.path in t)){const i=k(t,e.parentAddress??l("address.parentAddress is undefined"),n,s),o=e.pathInfo.segments[e.pathInfo.segments.length-1];if("*"===o){const t=e.listIndex?.index??l("address.listIndex?.index is undefined");return Reflect.get(i,t)}return Reflect.get(i,o)}if(!i.getterPaths.has(e.pathInfo.path))return Reflect.get(t,e.pathInfo.path);s.pushAddress(e);try{return o=Reflect.get(t,e.pathInfo.path,n)}finally{s.popAddress()}}function T(t,e,n,s,i,o){let r,a=i.cache.get(e)??null;const l=s.stateElement.mightChangeByPath.get(e.pathInfo.path);if(null!==a){const t=a.versionInfo;if(void 0===l)return a.value;if(t.version>s.updater.versionInfo.version)return a.value;if(!(t.version<l.version||t.revision<l.revision))return a.value}try{return r=$(t,e,n,s,i)}finally{let t=null;if(o){const n=A(a?.value)??[];t=function(t,e,n,s){const i=Array.isArray(e)?e:[],o=Array.isArray(n)?n:[],r=[];if(0===o.length)return[];if(0===i.length){for(let e=0;e<o.length;e++){const n=L(t,e);r.push(n)}return r}if(function(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}(i,o))return s;const a=new Map;for(let t=0;t<i.length;t++)a.set(i[t],t);for(let e=0;e<o.length;e++){const n=o[e],i=a.get(n);if(void 0===i){const n=L(t,e);r.push(n)}else{const t=s[i];t.index!==e&&(t.index=e),r.push(t)}}return r}(e.listIndex,a?.value,r,n),d=r,null!==(c=t)?C.set(d,c):C.delete(d)}const n=Object.assign(a??{},{value:r,versionInfo:{...s.updater.versionInfo}});i.cache.set(e,n)}var d,c}function k(t,e,n,s){!function(t,e){if(t.addressStackIndex>=0){const n=t.lastAddressStack?.pathInfo??null,s=t.stateElement;null!==n&&s.getterPaths.has(n.path)&&n.path!==e.pathInfo.path&&s.addDynamicDependency(n.path,e.pathInfo.path)}}(s,e);const i=s.stateElement,o=i.listPaths.has(e.pathInfo.path);return e.pathInfo.wildcardCount>0||i.getterPaths.has(e.pathInfo.path)||o?T(t,e,n,s,i,o):$(t,e,n,s,i)}function E(t,e,n,s){const i=e.pathInfo;switch(e.wildcardType){case"none":return null;case"context":return function(t,e){const n=t.lastAddressStack;if(null==n)return null;if(null==n.pathInfo)return null;if(null==n.listIndex)return null;const s=n.pathInfo.indexByWildcardPath[e];return void 0!==s?n.listIndex.at(s):null}(s,i.wildcardPaths.at(-1)??l("lastWildcardPath is null"))??l(`ListIndex not found: ${e.pathInfo.path}`);case"all":let o=null;for(let i=0;i<e.pathInfo.wildcardCount;i++){const r=e.pathInfo.wildcardParentPathInfos[i]??l("wildcardParentPathInfo is null");o=(A(k(t,N(r,o),n,s))??l(`ListIndex not found: ${r.path}`))[e.wildcardIndexes[i]??l("wildcardIndex is null")]??l(`ListIndex not found: ${r.path}`)}return o;case"partial":l(`Partial wildcard type is not supported yet: ${e.pathInfo.path}`)}}const M={};for(let t=0;t<128;t++)M[`$${t+1}`]=t;function R(t,e,n,s){const i=M[e];if(void 0!==i){const t=s.lastAddressStack?.listIndex;return t?.indexes[i]??l(`ListIndex not found: ${e.toString()}`)}if("string"==typeof e){if("$$setLoopContext"===e)return(t,e=async()=>{})=>async function(t,e,n){void 0!==t.loopContext&&l("already in loop context"),t.setLoopContext(e);try{if(!e)return await n();{const s=N(e.elementPathInfo,e.listIndex);t.pushAddress(s);try{return await n()}finally{t.popAddress()}}}finally{t.clearLoopContext()}}(s,t,e);if("$$getByAddress"===e)return e=>k(t,e,n,s);const i=y(e),o=E(t,i,n,s),r=N(i.pathInfo,o);return k(t,r,n,s)}if("symbol"==typeof e)return Reflect.get(t,e,n)}const O=new WeakMap;function D(t,e){null===e?O.delete(t):O.set(t,e)}function W(t,e,n,s,i){try{if(!(e.pathInfo.path in t)){const o=k(t,e.parentAddress??l("address.parentAddress is undefined"),s,i),r=e.pathInfo.segments[e.pathInfo.segments.length-1];if("*"===r){const t=e.listIndex?.index??l("address.listIndex?.index is undefined");return Reflect.set(o,t,n)}return Reflect.set(o,r,n)}i.pushAddress(e);try{return Reflect.set(t,e.pathInfo.path,n,s)}finally{i.popAddress()}}finally{i.updater.enqueueUpdateAddress(e)}}function B(t,e,n,s,i){let o=e.parentAddress??l("address.parentAddress is undefined"),r=function(t){return O.get(t)??null}(o);if(null===r){const e=k(t,o,s,i)??[],n=A(e)??[];r={value:[...e],listIndexes:[...n]},D(o,r)}try{return W(t,e,n,s,i)}finally{const a=r.value.indexOf(n),l=k(t,o,s,i)??[],d=A(l)??[],c=e.listIndex.index,u=-1!==a?r.listIndexes[a]:L(o.listIndex,-1);d[c]=u;if(new Set(l).size===r.value.length){for(let t=0;t<d.length;t++)d[t].index=t;D(o,null)}}}function F(t,e,n,s,i){if("string"==typeof e){const o=y(e),r=E(t,o,s,i);return function(t,e,n,s,i){const o=i.stateElement,r=o.elementPaths.has(e.pathInfo.path),a=o.listPaths.has(e.pathInfo.path),l=e.pathInfo.wildcardCount>0||o.getterPaths.has(e.pathInfo.path);try{return r?B(t,e,n,s,i):W(t,e,n,s,i)}finally{if(l||a){let t=o.cache.get(e)??null;null===t?(t={value:n,versionInfo:{version:i.updater.versionInfo.version,revision:i.updater.versionInfo.revision}},o.cache.set(e,t)):(t.value=n,t.versionInfo.version=i.updater.versionInfo.version,t.versionInfo.revision=i.updater.versionInfo.revision)}}}(t,N(o.pathInfo,r),n,s,i)}return Reflect.set(t,e,n,s)}function U(t,e,n){if(0===e.length)return;const s=e[0];"class"===s?function(t,e,n){"boolean"!=typeof n&&l("Invalid value for class application: expected boolean, got "+typeof n),t.classList.toggle(e,n)}(t,e[1],n):"attr"===s?function(t,e,n){t.getAttribute(e)!==n&&t.setAttribute(e,n)}(t,e[1],n):"style"===s?function(t,e,n){const s=t.style;s[e]!==n&&(s[e]=n)}(t,e[1],n):1===e.length?function(t,e,n){t[e]!==n&&(t[e]=n)}(t,s,n):function(t,e,n){let s=t[e[0]];for(let t=1;t<e.length-1;t++){const n=e[t];if(null==s)return;s=s[n]}s[e[e.length-1]]!==n&&(s[e[e.length-1]]=n)}(t,e,n)}function j(t){const e=t.node,n=t.placeHolderNode;e!==n&&null!==e.parentNode&&e.parentNode.replaceChild(n,e)}function z(t,e){let n=t;if(0===e.length)return n;for(let t=0;t<e.length&&(n=n?.childNodes[e[t]]??null,null!==n);t++);return n}function q(t,e){const n=[];for(const s of e)if("text"!==s.bindingType)n.push({...s,node:t,placeHolderNode:t});else{const e=document.createTextNode("");n.push({...s,node:t,placeHolderNode:e})}return n}const H=new Set(["if","elseif","else","for"]),J=t=>t.trim();function V(t){l(`filter ${t} requires at least one option`)}function K(t){l(`filter ${t} requires a number as option`)}function Y(t){l(`filter ${t} requires a number value`)}function G(t){l(`filter ${t} requires a date value`)}function Q(t){return!(!t||isNaN(Number(t)))}const X={eq:t=>{const e=t?.[0]??V("eq");return t=>"number"==typeof t?(Q(e)||K("eq"),t===Number(e)):t===e},ne:t=>{const e=t?.[0]??V("ne");return t=>"number"==typeof t?(Q(e)||K("ne"),t!==Number(e)):t!==e},not:t=>t=>("boolean"!=typeof t&&l(`filter ${"not"} requires a boolean value`),!t),lt:t=>{const e=t?.[0]??V("lt");return Q(e)||K("lt"),t=>("number"!=typeof t&&Y("lt"),t<Number(e))},le:t=>{const e=t?.[0]??V("le");return Q(e)||K("le"),t=>("number"!=typeof t&&Y("le"),t<=Number(e))},gt:t=>{const e=t?.[0]??V("gt");return Q(e)||K("gt"),t=>("number"!=typeof t&&Y("gt"),t>Number(e))},ge:t=>{const e=t?.[0]??V("ge");return Q(e)||K("ge"),t=>("number"!=typeof t&&Y("ge"),t>=Number(e))},inc:t=>{const e=t?.[0]??V("inc");return Q(e)||K("inc"),t=>("number"!=typeof t&&Y("inc"),t+Number(e))},dec:t=>{const e=t?.[0]??V("dec");return Q(e)||K("dec"),t=>("number"!=typeof t&&Y("dec"),t-Number(e))},mul:t=>{const e=t?.[0]??V("mul");return Q(e)||K("mul"),t=>("number"!=typeof t&&Y("mul"),t*Number(e))},div:t=>{const e=t?.[0]??V("div");return Q(e)||K("div"),t=>("number"!=typeof t&&Y("div"),t/Number(e))},mod:t=>{const e=t?.[0]??V("mod");return Q(e)||K("mod"),t=>("number"!=typeof t&&Y("mod"),t%Number(e))},fix:t=>{const e=t?.[0]??"0";return Q(e)||K("fix"),t=>("number"!=typeof t&&Y("fix"),t.toFixed(Number(e)))},locale:t=>{const e=t?.[0]??a;return t=>("number"!=typeof t&&Y("locale"),t.toLocaleString(e))},uc:t=>t=>String(t).toUpperCase(),lc:t=>t=>String(t).toLowerCase(),cap:t=>t=>{const e=String(t);return 0===e.length?e:1===e.length?e.toUpperCase():e.charAt(0).toUpperCase()+e.slice(1)},trim:t=>t=>String(t).trim(),slice:t=>{const e=t?.[0]??V("slice");return Q(e)||K("slice"),t=>String(t).slice(Number(e))},substr:t=>{const e=t?.[0]??V("substr");Q(e)||K("substr");const n=t?.[1]??V("substr");return Q(n)||K("substr"),t=>String(t).substr(Number(e),Number(n))},pad:t=>{const e=t?.[0]??V("pad");Q(e)||K("pad");const n=t?.[1]??"0";return t=>String(t).padStart(Number(e),n)},rep:t=>{const e=t?.[0]??V("rep");return Q(e)||K("rep"),t=>String(t).repeat(Number(e))},rev:t=>t=>String(t).split("").reverse().join(""),int:t=>t=>parseInt(String(t),10),float:t=>t=>parseFloat(String(t)),round:t=>{const e=t?.[0]??"0";return Q(e)||K("round"),t=>{"number"!=typeof t&&Y("round");const n=Math.pow(10,Number(e));return Math.round(t*n)/n}},floor:t=>{const e=t?.[0]??"0";return Q(e)||K("floor"),t=>{"number"!=typeof t&&Y("floor");const n=Math.pow(10,Number(e));return Math.floor(t*n)/n}},ceil:t=>{const e=t?.[0]??"0";return Q(e)||K("ceil"),t=>{"number"!=typeof t&&Y("ceil");const n=Math.pow(10,Number(e));return Math.ceil(t*n)/n}},percent:t=>{const e=t?.[0]??"0";return Q(e)||K("percent"),t=>("number"!=typeof t&&Y("percent"),`${(100*t).toFixed(Number(e))}%`)},date:t=>{const e=t?.[0]??a;return t=>(t instanceof Date||G("date"),t.toLocaleDateString(e))},time:t=>{const e=t?.[0]??a;return t=>(t instanceof Date||G("time"),t.toLocaleTimeString(e))},datetime:t=>{const e=t?.[0]??a;return t=>(t instanceof Date||G("datetime"),t.toLocaleString(e))},ymd:t=>{const e=t?.[0]??"-";return t=>{t instanceof Date||G("ymd");const n=t.getFullYear().toString(),s=(t.getMonth()+1).toString().padStart(2,"0"),i=t.getDate().toString().padStart(2,"0");return`${n}${e}${s}${e}${i}`}},falsy:t=>t=>!1===t||null==t||0===t||""===t||Number.isNaN(t),truthy:t=>t=>!1!==t&&null!=t&&0!==t&&""!==t&&!Number.isNaN(t),defaults:t=>{const e=t?.[0]??V("defaults");return t=>!1===t||null==t||0===t||""===t||Number.isNaN(t)?e:t},boolean:t=>t=>Boolean(t),number:t=>t=>Number(t),string:t=>t=>String(t),null:t=>t=>""===t?null:t},Z=(t,e)=>n=>{const s=n[t];return s||l(`filter not found: ${t}`),s(e)};const tt=new Map;function et(t){const e=t.indexOf("|");let n="",s=[],i="",o=[];-1!==e?(n=t.slice(0,e).trim(),i=t.slice(e+1).trim(),tt.has(i)?o=tt.get(i):(s=i.split("|").map(J),o=s.map(t=>{const e=t.indexOf("("),n=t.lastIndexOf(")");if(-1!==e&&-1===n&&l(`Invalid filter format: missing closing parenthesis in "${t}"`),-1!==n&&-1===e&&l(`Invalid filter format: missing opening parenthesis in "${t}"`),-1===e){const e=t.trim();return{filterName:e,args:[],filterFn:Z(e,[])(X)}}{const s=function(t){const e=[];let n="",s=null;for(let i=0;i<t.length;i++){const o=t[i];s?o===s?s=null:n+=o:'"'===o||"'"===o?s=o:","===o?(e.push(n.trim()),n=""):n+=o}return n.trim()&&e.push(n.trim()),e}(t.substring(e+1,n)),i=t.substring(0,e).trim();return{filterName:i,args:s,filterFn:Z(i,s)(X)}}}),tt.set(i,o))):n=t.trim();const[r,a="default"]=n.split("@").map(J);return{stateName:a,statePathName:r,statePathInfo:m(r),filters:o}}function nt(t){const[...e]=t.split(";").map(J).filter(t=>t.length>0),n=e.map(t=>{const e=t.indexOf(":");-1===e&&l(`Invalid bindText: "${t}". Missing ':' separator between propPart and statePart.`);const n=t.slice(0,e).trim(),s=t.slice(e+1).trim();if("else"===n)return{propName:"else",propSegments:["else"],propModifiers:[],statePathName:"",statePathInfo:null,stateName:"",filters:[],bindingType:"else"};if("if"===n||"elseif"===n||"for"===n){return{propName:n,propSegments:[n],propModifiers:[],...et(s),bindingType:n}}{const t=et(s),e=function(t){const[e,n]=t.split("#").map(J),s=e.split(".").map(J);return{propName:e,propSegments:s,propModifiers:n?n.split(",").map(J):[]}}(n);return e.propSegments[0].startsWith("on")?{...e,...t,bindingType:"event"}:{...e,...t,bindingType:"prop"}}});if(n.length>1){n.some(t=>H.has(t.bindingType))&&l(`Invalid bindText: "${t}". 'if', 'elseif', 'else', and 'for' bindings must be single binding.`)}return n}const st=new WeakMap,it=new Set([e,n,s,i,o]),ot=new RegExp("^\\s*@@\\s*(.*?)\\s*:\\s*(.+?)\\s*$");const rt=new Map;function at(t,e){null===e?rt.delete(t):rt.set(t,e)}function lt(t){return rt.get(t)||null}function dt(e){if(e.nodeType===Node.ELEMENT_NODE){return nt(e.getAttribute(t)||"")}if(e.nodeType===Node.COMMENT_NODE){const t=function(t){return st.get(t)||null}(e);null===t&&l("Comment node binding text not found.");const n=lt(t);let s=n?.parseBindTextResult??null,i=null;return null===s?(s={propName:"textContent",propSegments:["textContent"],propModifiers:[],...et(t),bindingType:"text"},i=null):i=t,[{...s,uuid:i}]}return[]}function ct(n){const s=[],i=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT,{acceptNode(n){if(n.nodeType===Node.ELEMENT_NODE){return n.hasAttribute(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}return function(t){if(t.nodeType!==Node.COMMENT_NODE)return!1;const n=t.data.trim(),s=ot.exec(n);if(null===s)return!1;const i=s[1]||e;return!!it.has(i)&&(st.set(t,s[2]),!0)}(n)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;i.nextNode();)s.push(i.currentNode);return s}const ut=new WeakSet;const ht=new Map,ft=new Map;function pt(t){if(!t.propName.startsWith("on"))return!1;const e=function(t){return`${t.stateName}::${t.statePathName}`}(t);let n=ht.get(e);var s,i;void 0===n&&(s=t.stateName,i=t.statePathName,n=t=>{const e=c(s);null===e&&l(`State element with name "${s}" not found for event handler.`),e.createState(async e=>{const n=e[i];return"function"!=typeof n&&l(`Handler "${i}" is not a function on state "${s}".`),n.call(e,t)})},ht.set(e,n));const o=t.propName.slice(2);t.node.addEventListener(o,n);let r=ft.get(e);return void 0===r?(r=new Set([t]),ft.set(e,r)):r.add(t),!0}const mt=new Set(["radio","checkbox"]),gt=new Set(["value","valueAsNumber","valueAsDate"]);const _t=new WeakMap;function xt(t){return _t.get(t)||null}function yt(t,e){null!==e?_t.set(t,e):_t.delete(t)}const It=new Map,wt=new Map;function vt(t){if(function(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const n=t,s=n.tagName.toLowerCase();if("input"===s){const t=(n.getAttribute("type")||"text").toLowerCase();if("button"===t)return!1;if(mt.has(t)&&"checked"===e)return!0;if(gt.has(e))return!0}return"select"===s&&"value"===e||"textarea"===s&&"value"===e}(t.node,t.propName)&&-1===t.propModifiers.indexOf("ro")){const i=function(t){let e="select"===t.node.tagName.toLowerCase()?"change":"input";for(const n of t.propModifiers)n.startsWith("on")&&(e=n.slice(2));return e}(t),o=function(t,e){return`${t.stateName}::${t.propName}::${t.statePathName}::${e}`}(t,i);let r=It.get(o);void 0===r&&(e=t.stateName,n=t.propName,s=t.statePathName,r=t=>{const i=t.target;if(void 0===i)return void console.warn("[@wcstack/state] event.target is undefined.");if(!(n in i))return void console.warn(`[@wcstack/state] Property "${n}" does not exist on target element.`);const o=i[n],r=c(e);null===r&&l(`State element with name "${e}" not found for two-way binding.`);const a=xt(i);r.createState(async t=>{t.$$setLoopContext(a,async()=>{t[s]=o})})},It.set(o,r)),t.node.addEventListener(i,r);let a=wt.get(o);return void 0===a?(a=new Set([t]),wt.set(o,a)):a.add(t),!0}var e,n,s;return!1}async function Nt(t){const e=[],n=new Map;for(const e of t){const t=c(e.stateName);if(null===t&&l(`State element with name "${e.stateName}" not found for binding.`),await t.initializePromise,j(e),pt(e))continue;vt(e),t.addBindingInfo(e);let s=n.get(t);void 0===s?n.set(t,[e]):s.push(e)}for(const[t,s]of n.entries()){const n=new Map;await t.createState(async t=>{for(const i of s){let s=n.get(i.statePathName);if(void 0===s){const e=xt(i.node);s=await t.$$setLoopContext(e,()=>t[i.statePathName]),n.set(i.statePathName,s)}e.push({bindingInfo:i,value:s})}})}for(const t of e)$t(t.bindingInfo,t.value)}async function St(t,e){const[n,s]=function(t){const e=ct(t),n=[];for(const t of e)if(!ut.has(t)){ut.add(t);const e=q(t,dt(t));n.push(...e)}return[e,n]}(t);for(const t of n)yt(t,e);await Nt(s)}async function Pt(t,e,n){const[s,i]=function(t,e){const n=[],s=[];for(const i of e){const e=z(t,i.nodePath);if(null===e&&l(`Node not found by path [${i.nodePath.join(", ")}] in fragment.`),!ut.has(e)){ut.add(e);const t=q(e,i.parseBindTextResults);s.push(...t),n.push(e)}}return[n,s]}(t,e);for(const t of s)yt(t,n);await Nt(i)}class bt{_content;_childNodeArray=[];_firstNode=null;_lastNode=null;constructor(t){this._content=t,this._childNodeArray=Array.from(this._content.childNodes),this._firstNode=this._childNodeArray.length>0?this._childNodeArray[0]:null,this._lastNode=this._childNodeArray.length>0?this._childNodeArray[this._childNodeArray.length-1]:null}get firstNode(){return this._firstNode}get lastNode(){return this._lastNode}mountAfter(t){const e=t.parentNode,n=t.nextSibling;e&&this._childNodeArray.forEach(t=>{e.insertBefore(t,n)})}unmount(){this._childNodeArray.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)})}}function Lt(t){return new bt(t)}const Ct=new WeakMap,At=new WeakMap;function $t(t,e){let n=e;for(const e of t.filters)n=e.filterFn(n);if("text"===t.bindingType)!function(t,e){t.nodeValue!==e&&(t.nodeValue=e)}(t.placeHolderNode,n);else if("prop"===t.bindingType)U(t.node,t.propSegments,n);else if("for"===t.bindingType){if(!t.uuid)throw new Error("BindingInfo for 'for' binding must have a UUID.");!function(t,e,n){const s=lt(e);s||l(`Fragment with UUID "${e}" not found.`),Ct.get(t);const i=Array.isArray(n)?n:[],o=A(i)||[],r=At.get(t)||[];for(const t of r)t.unmount();const a=[];let d=t;const u=s.parseBindTextResult.statePathInfo;u||l("List path info not found in fragment bind text result.");const h=m(u.path+"."+f),p=s.parseBindTextResult.stateName,g=c(p);g||l(`State element with name "${p}" not found.`);const _=g.loopContextStack;for(const t of o)_.createLoopContext(h,t,t=>{const e=document.importNode(s.fragment,!0);Pt(e,s.nodeInfos,t);const n=Lt(e);n.mountAfter(d),d=n.lastNode||d,a.push(n)});At.set(t,a),Ct.set(t,i)}(t.node,t.uuid,n)}}class Tt{_stateName;_versionInfo;_updateAddresses=[];_state;_applyPromise=null;_applyResolve=null;_stateElement;constructor(t,e,n){this._versionInfo={version:n,revision:0},this._stateName=t,this._state=e,this._stateElement=c(this._stateName)??l(`Updater: State element with name "${this._stateName}" not found.`)}get versionInfo(){return this._versionInfo}enqueueUpdateAddress(t){const e=this._stateElement;this._updateAddresses.push(t),this._versionInfo.revision++,e.mightChangeByPath.set(t.pathInfo.path,{version:this._versionInfo.version,revision:this._versionInfo.revision}),null===this._applyPromise&&(this._applyPromise=new Promise(t=>{this._applyResolve=t}),queueMicrotask(()=>{this._processUpdates()}))}_processUpdates(){const t=this._stateElement,e=new Set(this._updateAddresses);this._updateAddresses.length=0;const n=[];for(const s of e){const e=this._state.$$getByAddress(s),i=t.bindingInfosByAddress.get(s);if(void 0!==i)for(const t of i)n.push({bindingInfo:t,value:e})}for(const t of n){const{bindingInfo:e,value:n}=t;$t(e,n)}null!==this._applyResolve&&(this._applyResolve(),this._applyResolve=null,this._applyPromise=null)}}class kt{_stateElement;_stateName;_addressStack=[];_addressStackIndex=-1;_updater;_loopContext;constructor(t){this._stateName=t;const e=c(this._stateName);null===e&&l(`StateHandler: State element with name "${this._stateName}" not found.`),this._stateElement=e}get stateName(){return this._stateName}get stateElement(){return this._stateElement}get lastAddressStack(){return this._addressStackIndex>=0?this._addressStack[this._addressStackIndex]:null}get addressStack(){return this._addressStack}get addressStackIndex(){return this._addressStackIndex}get updater(){return void 0===this._updater&&l("StateHandler: updater is not set yet."),this._updater}set updater(t){this._updater=t}get loopContext(){return this._loopContext}pushAddress(t){this._addressStackIndex++,this._addressStackIndex>=this._addressStack.length?this._addressStack.push(t):this._addressStack[this._addressStackIndex]=t}popAddress(){if(this._addressStackIndex<0)return null;const t=this._addressStack[this._addressStackIndex];return this._addressStackIndex--,t}setLoopContext(t){this._loopContext=t}clearLoopContext(){this._loopContext=void 0}get(t,e,n){return R(t,e,n,this)}set(t,e,n,s){return F(t,e,n,s,this)}has(t,e){return Reflect.has(t,e)}}function Et(t,e){const n=new kt(e),s=new Proxy(t,n);return n.updater=function(t,e,n){return new Tt(t,e,n)}(e,s,n.stateElement.nextVersion()),s}const Mt=new WeakMap;function Rt(t){const e=xt(t.node);if(null===e)return null;let n=Mt.get(e);if(void 0===n)n=new WeakMap,Mt.set(e,n);else{const e=n.get(t);if(void 0!==e)return e}let s=null;try{const n=t.statePathInfo?.wildcardParentPathSet;void 0===n&&l("BindingInfo does not have statePathInfo for list index retrieval.");const i=e.elementPathInfo.wildcardParentPathSet,o=n.intersection(i).size;return o>0&&(s=e.listIndex.at(o-1)),s}finally{n.set(t,s)}}function Ot(t){const e=new Set,n=function(t){let e={},n=t;for(;n&&n!==Object.prototype;)Object.assign(e,Object.getOwnPropertyDescriptors(n)),n=Object.getPrototypeOf(n);return e}(t);for(const[t,s]of Object.entries(n))"function"==typeof s.get&&e.add(t);return{getterPaths:e}}class Dt extends HTMLElement{__state;_proxyState;_name="default";_initialized=!1;_bindingInfosByAddress=new Map;_initializePromise;_resolveInitialize=null;_listPaths=new Set;_elementPaths=new Set;_getterPaths=new Set;_isLoadingState=!1;_isLoadedState=!1;_loopContextStack=function(){return new h}();_cache=new Map;_mightChangeByPath=new Map;_dynamicDependency=new Map;_staticDependency=new Map;_pathSet=new Set;_version=0;static get observedAttributes(){return["name","src","state"]}constructor(){super(),this._initializePromise=new Promise(t=>{this._resolveInitialize=t})}get _state(){return void 0===this.__state&&l(`${r.state} _state is not initialized yet.`),this.__state}set _state(t){this.__state=t,this._listPaths.clear(),this._elementPaths.clear(),this._getterPaths.clear(),this._pathSet.clear(),this._proxyState=void 0;const e=Ot(t);for(const t of e.getterPaths)this._getterPaths.add(t)}get name(){return this._name}attributeChangedCallback(t,e,n){"name"===t&&e!==n&&(u(this._name,null),this._name=n,u(this._name,this)),"state"===t&&e!==n&&(this._isLoadedState&&l("The state has already been loaded. The 'state' attribute cannot be changed multiple times."),this._isLoadingState&&l("The state is currently loading. The 'state' attribute cannot be changed during loading."),this._state=function(t){const e=document.getElementById(t);if(e&&"application/json"===e.type)try{return JSON.parse(e.textContent||"{}")}catch(t){l("Failed to parse JSON from script element:"+t)}return{}}(n),this._isLoadedState=!0),"src"===t&&e!==n&&(this._isLoadedState&&l("The state has already been loaded. The 'src' attribute cannot be changed multiple times."),this._isLoadingState&&l("The state is currently loading. The 'src' attribute cannot be changed during loading."),n&&n.endsWith(".json")?(this._isLoadingState=!0,async function(t){try{const e=await fetch(t);return e.ok||l(`Failed to fetch JSON file: ${e.statusText}`),await e.json()}catch(t){return console.error("Failed to load JSON file:",t),{}}}(n).then(t=>{this._isLoadedState=!0,this._state=t}).finally(()=>{this._isLoadingState=!1})):n&&n.endsWith(".js")?(this._isLoadingState=!0,async function(t){try{return(await import(t)).default||{}}catch(t){l(`Failed to load script file: ${t}`)}}(n).then(t=>{this._isLoadedState=!0,this._state=t}).finally(()=>{this._isLoadingState=!1})):l(`Unsupported src file type: ${n}`))}async _initialize(){if(!this._isLoadedState&&!this._isLoadingState){this._isLoadingState=!0;try{const t=this.querySelector('script[type="module"]');t&&(this._state=await async function(t,e){let n=null;const s=`\n//# sourceURL=${e}\n`;if("function"==typeof URL.createObjectURL){const e=new Blob([t.text+s],{type:"application/javascript"}),i=URL.createObjectURL(e);try{n=await import(i)}finally{URL.revokeObjectURL(i)}}else{const e=btoa(String.fromCodePoint(...(new TextEncoder).encode(t.text+s)));n=await import(`data:application/javascript;base64,${e}`)}return n&&"object"==typeof n.default?n.default:{}}(t,`state#${this._name}`),this._isLoadedState=!0)}catch(t){l(`Failed to load state from inner script: ${t.message}`)}finally{this._isLoadingState=!1}}void 0===this._state&&(this._state={})}async connectedCallback(){this._initialized||(await this._initialize(),this._initialized=!0,this._resolveInitialize?.())}disconnectedCallback(){u(this._name,null)}get bindingInfosByAddress(){return this._bindingInfosByAddress}get initializePromise(){return this._initializePromise}get listPaths(){return this._listPaths}get elementPaths(){return this._elementPaths}get getterPaths(){return this._getterPaths}get loopContextStack(){return this._loopContextStack}get cache(){return this._cache}get mightChangeByPath(){return this._mightChangeByPath}get dynamicDependency(){return this._dynamicDependency}get staticDependency(){return this._staticDependency}get version(){return this._version}addDynamicDependency(t,e){const n=this._dynamicDependency.get(t);void 0===n?this._dynamicDependency.set(t,[e]):n.includes(e)||n.push(e)}addStaticDependency(t,e){const n=this._staticDependency.get(t);void 0===n?this._staticDependency.set(t,[e]):n.includes(e)||n.push(e)}addBindingInfo(t){const e=Rt(t),n=N(t.statePathInfo,e),s=t.statePathName,i=this._bindingInfosByAddress.get(n);if(void 0===i?this._bindingInfosByAddress.set(n,[t]):i.push(t),"for"===t.bindingType&&(this._listPaths.add(s),this._elementPaths.add(s+"."+f)),!this._pathSet.has(s)){const t=m(s);this._pathSet.add(s),null!==t.parentPath&&this.addStaticDependency(t.parentPath,s)}}deleteBindingInfo(t){const e=Rt(t),n=N(t.statePathInfo,e),s=this._bindingInfosByAddress.get(n);if(void 0!==s){const e=s.indexOf(t);-1!==e&&s.splice(e,1)}}async createState(t){return t(Et(this._state,this._name))}nextVersion(){return this._version++,this._version}}function Wt(t){let e=t;const n=[];for(;null!==e.parentNode;){const t=Array.from(e.parentNode.childNodes).indexOf(e);n.unshift(t),e=e.parentNode}return n}function Bt(t){const e=[],n=ct(t);for(const t of n){const n=dt(t);e.push({nodePath:Wt(t),parseBindTextResults:n})}return e}const Ft=new Map([["for",n],["if",s],["elseif",i],["else",o]]);function Ut(e){const n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode(e){if(e instanceof HTMLTemplateElement){if((e.getAttribute(t)||"").length>0)return NodeFilter.FILTER_ACCEPT}return NodeFilter.FILTER_SKIP}});for(;n.nextNode();){const e=n.currentNode,s=nt(e.getAttribute(t)||"")[0],i=Ft.get(s.bindingType);if(void 0===i)continue;const o=e.content,r=S(),a=document.createComment(`@@${i}:${r}`);e.replaceWith(a),Ut(o),at(r,{fragment:o,parseBindTextResult:s,nodeInfos:Bt(o)})}}function jt(){document.addEventListener("DOMContentLoaded",async()=>{Ut(document),await St(document.body,null)})}function zt(){customElements.get(r.state)||customElements.define(r.state,Dt),jt()}export{zt as bootstrapState};
//# sourceMappingURL=index.esm.min.js.map
