const t={bindAttributeName:"data-bind-state",tagNames:{state:"wcs-state",loop:"wcs-loop"}};function e(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}class n{_content;_childNodeArray=[];_firstNode=null;_lastNode=null;constructor(t){this._content=t,this._childNodeArray=Array.from(this._content.childNodes),this._firstNode=this._childNodeArray.length>0?this._childNodeArray[0]:null,this._lastNode=this._childNodeArray.length>0?this._childNodeArray[this._childNodeArray.length-1]:null}get firstNode(){return this._firstNode}get lastNode(){return this._lastNode}mountAfter(t){const e=t.parentNode,n=t.nextSibling;e&&this._childNodeArray.forEach(t=>{e.insertBefore(t,n)})}unmount(){this._childNodeArray.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)})}}function i(t){return new n(t)}const s=".",o={};function a(t){if(o[t])return o[t];const e=new r(t);return o[t]=e,e}class r{path="";segments=[];wildcardPositions=[];wildcardPaths=[];wildcardParentPaths=[];wildcardPathInfos=[];wildcardParentPathInfos=[];_parentPathInfo=void 0;constructor(t){this.path=t,this.segments=t.split(s).filter(t=>t.length>0),this.wildcardPositions=this.segments.map((t,e)=>"*"===t?e:-1).filter(t=>-1!==t),this.wildcardPaths=this.wildcardPositions.map(t=>this.segments.slice(0,t+1).join(s)),this.wildcardParentPaths=this.wildcardPositions.map(t=>this.segments.slice(0,t).join(s)),this.wildcardPathInfos=this.wildcardPaths.map(e=>e===t?this:a(e)),this.wildcardParentPathInfos=this.wildcardParentPaths.map(e=>e===t?this:a(e))}get parentPathInfo(){if(void 0!==this._parentPathInfo)return this._parentPathInfo;if(0===this.segments.length)return null;const t=this.segments.slice(0,-1).join(s);return this._parentPathInfo=a(t),this._parentPathInfo}}function l(t){throw new Error(`[@wcstack/state] ${t}`)}const d=new WeakMap;function h(t){return d.get(t)||null}function c(t,e){null!==e?d.set(t,e):d.delete(t)}function u(t,e,n){if(t.nodeType===Node.ELEMENT_NODE){const i=t;if(1===e.length){i[e[0]]=n}else{const t=e[0];if("style"===t){const t=i,s=e[1];t.style[s]=n}else if("attr"===t){const t=e[1];null==n?i.removeAttribute(t):i.setAttribute(t,String(n))}else{const s=i[t];if("object"==typeof s&&null!==s){s[e[1]]=n}}}}else if(t.nodeType===Node.TEXT_NODE){t.textContent=String(n)}}const p=new Map;function f(t){return p.get(t)||null}const m=new Map;function _(t,e){null===e?m.delete(t):m.set(t,e)}function g(t){if(t.nodeType!==Node.COMMENT_NODE)return null;const e=t.data.trim(),n=/^@@loop:(.+)$/.exec(e);if(null===n)return null;const i=function(t){return m.get(t)||null}(n[1]);return null===i?null:i}const N=`${t.bindAttributeName.replace(/^data-/,"")}:`;const x=t.bindAttributeName.replace(/^data-/,"");function y(e){const n=[],i=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_COMMENT,{acceptNode(e){if(console.log("node:",e),e.nodeType===Node.ELEMENT_NODE){return e.hasAttribute(t.bindAttributeName)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}return function(t){if(t.nodeType!==Node.COMMENT_NODE)return!1;const e=t.data.trim();return null!==RegExp(`^{{\\s*${x}:(.+?)\\s*}}$`).exec(e)}(e)||g(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});for(;i.nextNode();)n.push(i.currentNode);return n}const P=new Set(["radio","checkbox"]),I=new Set(["value","valueAsNumber","valueAsDate"]);function b(t,e){if(t.nodeType!==Node.ELEMENT_NODE)return!1;const n=t,i=n.tagName.toLowerCase();if("input"===i){const t=(n.getAttribute("type")||"text").toLowerCase();if("button"===t)return!1;if(P.has(t)&&"checked"===e)return!0;if(I.has(e))return!0}return"select"===i&&"value"===e||"textarea"===i&&"value"===e}const w=new WeakMap;const v=new WeakSet;async function E(e,n){const i=y(e),s=[];i.forEach(e=>{if(!v.has(e)){v.add(e),function(t,e){null!==e?w.set(t,e):w.delete(t)}(e,n);const i=function(e){const n=[],i=[];if(e.nodeType===Node.ELEMENT_NODE){const i=e;if(i.tagName.toLowerCase()===t.tagNames.loop){const t=i;n.push(t.bindingInfo)}else{const e=(i.getAttribute(t.bindAttributeName)||"").split(";").map(t=>t.trim()).filter(t=>t.length>0);for(const t of e){const[e,s]=t.split(":").map(t=>t.trim()),[o,r]=(e??"").split("#").map(t=>t.trim()),d=r?r.split(",").map(t=>t.trim()):[],h=(o??"").split(".").map(t=>t.trim()),[c,...u]=(s??h.at(-1)??"").split("|").map(t=>t.trim()),p=c.split("@").map(t=>t.trim()),m=p[0]||"",_=p[1]||"default",g=a(m);null===f(_)&&l(`State element with name "${_}" not found for binding "${t}".`),""!==o&&""!==m||l(`Invalid binding syntax: "${t}".`);const N={propName:o||"",propSegments:h,propModifiers:d,statePathName:m,statePathInfo:g,stateName:_,filterTexts:u,node:i};n.push(N)}}}else if(e.nodeType===Node.COMMENT_NODE){const t=g(e);if(t){const e=t;n.push(e.bindingInfo)}else{const t=e,s=t.data.trim(),o=RegExp(`^{{\\s*${N}\\s*(.+?)\\s*}}$`).exec(s);if(null!==o){const e=o[1],[s,...r]=(e??"").split("|").map(t=>t.trim()),d=s.split("@").map(t=>t.trim()),h=d[0]||"",c=d[1]||"default",u=a(h);null===f(c)&&l(`State element with name "${c}" not found for binding "${e}".`),""===h&&l(`Invalid binding syntax: "${e}".`);const p=document.createTextNode(""),m=t.parentNode,_=t.nextSibling;null===m&&l("Comment node has no parent node."),m.insertBefore(p,_),i.push(t);const g={propName:"textContent",propSegments:["textContent"],propModifiers:[],statePathName:h,statePathInfo:u,stateName:c,filterTexts:r,node:p};n.push(g)}}for(const t of i)t.remove()}return n}(e);s.push(...i)}});const o=[],r=new Map;for(const t of s){const e=f(t.stateName);if(null===e)return void console.warn(`[@wcstack/state] State element with name "${t.stateName}" not found for event binding.`);if(t.propName.startsWith("on")){const n=t.propName.slice(2);t.node.addEventListener(n,n=>{const i=e.state[t.statePathName];"function"==typeof i&&i.call(e.state,n)});continue}if(b(t.node,t.propName)&&-1===t.propModifiers.indexOf("ro")){let n="select"===t.node.tagName.toLowerCase()?"change":"input";for(const e of t.propModifiers)e.startsWith("on")&&(n=e.slice(2));t.node.addEventListener(n,n=>{const i=n.target;if(void 0===i)return void console.warn("[@wcstack/state] event.target is undefined.");if(!(t.propName in i))return void console.warn(`[@wcstack/state] Property "${t.propName}" does not exist on target element.`);const s=i[t.propName];e.state[t.statePathName]=s})}e.addBindingInfo(t);let n=r.get(e);void 0===n&&(n=new Map,r.set(e,n));const i=n.get(t.statePathName);if(void 0!==i){o.push({bindingInfo:t,value:i});continue}await e.initializePromise;const s=e.state[t.statePathName];o.push({bindingInfo:t,value:s}),n.set(t.statePathName,s)}for(const t of o)u(t.bindingInfo.node,t.bindingInfo.propSegments,t.value)}class L extends HTMLElement{_uuid=e();_path="";_stateElement=null;_placeHolder=document.createComment(`@@loop:${this._uuid}`);_initializePromise;_resolveInitialize=null;_initialized=!1;_loopContent=null;_loopContents=[];_loopValue=null;_bindingInfo=null;static get observedAttributes(){return[t.bindAttributeName]}constructor(){super(),_(this._uuid,this),this._initializePromise=new Promise(t=>{this._resolveInitialize=t})}get uuid(){return this._uuid}get path(){return this._path}get stateElement(){return null===this._stateElement&&l("Loop stateElement is not set."),this._stateElement}get loopContent(){return null===this._loopContent&&l("Loop content is not initialized."),this._loopContent}get bindingInfo(){return null===this._bindingInfo&&l("Loop bindingInfo is not set."),this._bindingInfo}get initializePromise(){return this._initializePromise}attributeChangedCallback(e,n,i){if(e===t.bindAttributeName&&n!==i){const t=i||"",[e,n]=t.split("@").map(t=>t.trim());""===e&&l(`Invalid loop binding syntax: "${t}".`);const s=n??"default",o=a(e),r=f(s);null===r&&l(`State element with name "${s}" not found for loop binding "${t}".`),this._bindingInfo={propName:"loopValue",propSegments:["loopValue"],propModifiers:[],statePathName:e,statePathInfo:o,stateName:s,filterTexts:[],node:this},r.listPaths.add(this.bindingInfo.statePathName)}}initialize(){const e=this.querySelector("template");e||l(`${t.tagNames.loop} requires a <template> child element.`),this._loopContent=e.content}async connectedCallback(){this.replaceWith(this._placeHolder),this._initialized||(this.initialize(),this._resolveInitialize?.(),this._initialized=!0)}get loopValue(){return this._loopValue}set loopValue(t){this.render(t,this._loopValue),this._loopValue=t}render(t,e){if(Array.isArray(t)){null===this._placeHolder.parentNode&&l("Loop placeholder has no parent node.");for(let t of this._loopContents)t.unmount();this._loopContents=[];const e=h(t);null===e&&l("List indexes not found for loop value.");let n=this._placeHolder;for(let s=0;s<t.length;s++){const t=e[s],o=document.importNode(this.loopContent,!0);E(o,t);const a=i(o);a.mountAfter(n),this._loopContents.push(a),n=a.lastNode||n}}else for(let t of this._loopContents)t.unmount()}}let C=0;class S{uuid=e();parentListIndex;position;length;_index;_version;_indexes;_listIndexes;constructor(t,e){this.parentListIndex=t,this.position=t?t.position+1:0,this.length=this.position+1,this._index=e,this._version=C}get index(){return this._index}set index(t){this._index=t,this._version=++C,this.indexes[this.position]=t}get version(){return this._version}get dirty(){return null!==this.parentListIndex&&(this.parentListIndex.dirty||this.parentListIndex.version>this._version)}get indexes(){return null===this.parentListIndex?void 0===this._indexes&&(this._indexes=[this._index]):(void 0===this._indexes||this.dirty)&&(this._indexes=[...this.parentListIndex.indexes,this._index],this._version=C),this._indexes}get listIndexes(){return null===this.parentListIndex?void 0===this._listIndexes&&(this._listIndexes=[new WeakRef(this)]):void 0===this._listIndexes&&(this._listIndexes=[...this.parentListIndex.listIndexes,new WeakRef(this)]),this._listIndexes}get varName(){return`$${this.position+1}`}at(t){return t>=0?this.listIndexes[t]?.deref()||null:this.listIndexes[this.listIndexes.length+t]?.deref()||null}}function A(t,e){return new S(t,e)}function T(t,e){const n=[];for(let i=0;i<t.length;i++)n.push(A(e,i));return n}class ${_bindingInfosByPath;_listPaths;constructor(t,e){this._bindingInfosByPath=t,this._listPaths=e}_getNestValue(t,e,n){let i=e;if(i.path in t)return Reflect.get(t,i.path,n);const s=i.parentPathInfo;if(null===s)return;const o=this._getNestValue(t,s,n),a=i.segments[i.segments.length-1];return a in o?Reflect.get(o,a,n):void console.warn(`[@wcstack/state] Property "${e.path}" does not exist on state.`)}get(t,e,n){let i;try{if("string"==typeof e){const s=a(e);if(s.segments.length>1)return i=this._getNestValue(t,s,n)}return e in t?i=Reflect.get(t,e,n):void console.warn(`[@wcstack/state] Property "${String(e)}" does not exist on state.`)}finally{if("string"==typeof e&&this._listPaths.has(e)&&null===h(i)){c(i,T(i??[],null))}}}set(t,e,n,i){let s=!1;if("string"==typeof e){const o=a(e);if(o.segments.length>1){if(null===o.parentPathInfo)return!1;const e=this._getNestValue(t,o.parentPathInfo,i),a=o.segments[o.segments.length-1];s=Reflect.set(e,a,n,i)}else s=Reflect.set(t,e,n,i);if(this._bindingInfosByPath.has(String(e))){const t=this._bindingInfosByPath.get(String(e))||[];for(const e of t)u(e.node,e.propSegments,n)}}else s=Reflect.set(t,e,n,i);if("string"==typeof e&&this._listPaths.has(e)){c(n,T(n??[],null))}return s}}class M extends HTMLElement{_uuid=e();_state;_proxyState;_name="default";_initialized=!1;_bindingInfosByPath=new Map;_initializePromise;_resolveInitialize=null;_listPaths=new Set;static get observedAttributes(){return["name"]}constructor(){super(),_(this._uuid,this),this._initializePromise=new Promise(t=>{this._resolveInitialize=t})}get uuid(){return this._uuid}get state(){var e,n,i;return void 0===this._state&&l(`${t.tagNames.state} _state is not initialized yet.`),void 0===this._proxyState&&(this._proxyState=(e=this._state,n=this._bindingInfosByPath,i=this._listPaths,new Proxy(e,new $(n,i)))),this._proxyState}get name(){return this._name}async _getState(t){const e=this.querySelector('script[type="module"]');if(e)return await async function(t,e){let n=null;const i=`\n//# sourceURL=${e}\n`;if("function"==typeof URL.createObjectURL){const e=new Blob([t.text+i],{type:"application/javascript"}),s=URL.createObjectURL(e);try{n=await import(s)}finally{URL.revokeObjectURL(s)}}else{const e=btoa(String.fromCodePoint(...(new TextEncoder).encode(t.text+i)));n=await import(`data:application/javascript;base64,${e}`)}return n&&"object"==typeof n.default?n.default:{}}(e,`state#${t}`);const n=this.getAttribute("src");if(n&&n.endsWith(".json"))return await async function(t){try{const e=await fetch(t);return e.ok||l(`Failed to fetch JSON file: ${e.statusText}`),await e.json()}catch(t){return console.error("Failed to load JSON file:",t),{}}}(n);if(n&&n.endsWith(".js"))return await async function(t){try{return(await import(t)).default||{}}catch(t){l(`Failed to load script file: ${t}`)}}(n);n&&l(`Unsupported src file type: ${n}`);const i=this.getAttribute("state");return i?function(t){const e=document.getElementById(t);if(e&&"application/json"===e.type)try{return JSON.parse(e.textContent||"{}")}catch(t){l("Failed to parse JSON from script element:"+t)}return{}}(i):{}}attributeChangedCallback(t,e,n){"name"===t&&e!==n&&(this._name=n,function(t,e){null===e?p.delete(t):p.set(t,e)}(this._name,this))}async _initialize(){this.hasAttribute("name")||this.setAttribute("name","default"),this._state=await this._getState(this._name)}async connectedCallback(){this._initialized||(await this._initialize(),this._initialized=!0,this._resolveInitialize?.())}get bindingInfosByPath(){return this._bindingInfosByPath}get initializePromise(){return this._initializePromise}get listPaths(){return this._listPaths}addBindingInfo(t){const e=t.statePathName,n=this._bindingInfosByPath.get(e);void 0===n?this._bindingInfosByPath.set(e,[t]):n.push(t)}}function z(){customElements.get(t.tagNames.state)||customElements.define(t.tagNames.state,M),customElements.get(t.tagNames.loop)||customElements.define(t.tagNames.loop,L),document.addEventListener("DOMContentLoaded",async()=>{await E(document.body,null)})}export{z as bootstrapState};
//# sourceMappingURL=index.esm.min.js.map
