const t={tagNames:{route:"wcs-route",router:"wcs-router",outlet:"wcs-outlet",layout:"wcs-layout",layoutOutlet:"wcs-layout-outlet",link:"wcs-link"},enableShadowRoot:!1};function e(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function a(t){throw new Error(`[@wcstack/router] ${t}`)}const s=new Set(["props","states","attr",""]);function o(t,e){t.hasAttribute("data-bind")||a(`${t.tagName} has no 'data-bind' attribute.`);const o=t.getAttribute("data-bind")||"";s.has(o)||a(`${t.tagName} has invalid 'data-bind' attribute: ${o}`);const i=o;for(const[a,s]of Object.entries(e))switch(i){case"props":t.props={...t.props,[a]:s};break;case"states":t.states={...t.states,[a]:s};break;case"attr":t.setAttribute(a,s);break;case"":t[a]=s}}class i extends Error{fallbackPath;constructor(t,e){super(t),this.fallbackPath=e}}class n extends HTMLElement{_name="";_path="";_routeParentNode=null;_routeChildNodes=[];_routerNode=null;_uuid=e();_placeHolder=null;_childNodeArray=[];_isMadeArray=!1;_paramNames=[];_patternText="";_params={};_absolutePattern=null;_weight=-1;_absoluteWeight=0;_childIndex=0;_hasGuard=!1;_guardHandler=null;_waitForSetGuardHandler=null;_resolveSetGuardHandler=null;_guardFallbackPath="";_initialized=!1;_isFallbackRoute=!1;constructor(){super()}get routeParentNode(){return this._routeParentNode}set routeParentNode(t){this._routeParentNode=t,t?(t.routeChildNodes.push(this),this._childIndex=t.routeChildNodes.length-1):(this.routerNode.routeChildNodes.push(this),this._childIndex=this.routerNode.routeChildNodes.length-1)}get routeChildNodes(){return this._routeChildNodes}get routerNode(){return this._routerNode||a(`${t.tagNames.route} has no routerNode.`),this._routerNode}set routerNode(e){this._routerNode=e,this._isFallbackRoute&&(this._routerNode.fallbackRoute&&a(`${t.tagNames.router} can have only one fallback route.`),this.routerNode.fallbackRoute=this)}get path(){return this._path}get isRelative(){return!this._path.startsWith("/")}_checkParentNode(e,s){return this.isRelative&&!this._routeParentNode&&a(`${t.tagNames.route} is relative but has no parent route.`),!this.isRelative&&this._routeParentNode&&a(`${t.tagNames.route} is absolute but has a parent route.`),this.isRelative&&this._routeParentNode?e(this._routeParentNode):s()}get absolutePath(){return this._checkParentNode(t=>{const e=t.absolutePath;return e.endsWith("/")?e+this._path:e+"/"+this._path},()=>this._path)}get uuid(){return this._uuid}get placeHolder(){return this._placeHolder||a(`${t.tagNames.route} placeHolder is not set.`),this._placeHolder}set placeHolder(t){this._placeHolder=t}get rootElement(){return this.shadowRoot??this}get childNodeArray(){return this._isMadeArray||(this._childNodeArray=Array.from(this.rootElement.childNodes),this._isMadeArray=!0),this._childNodeArray}testPath(t){const e={},a=this._absolutePattern?.exec(t)??(this._absolutePattern=new RegExp(`^${this.absolutePatternText}$`)).exec(t);return a?(this.absoluteParamNames.forEach((t,s)=>{e[t]=a[s+1]}),{path:t,routes:this.routes,params:e,lastPath:""}):null}get routes(){return this.routeParentNode?this.routeParentNode.routes.concat(this):[this]}get patternText(){return this._patternText}get absolutePatternText(){return this._checkParentNode(t=>{const e=t.absolutePatternText;return e.endsWith("\\/")?e+this._patternText:e+"\\/"+this._patternText},()=>this._patternText)}get params(){return this._params}get absoluteParamNames(){return this._checkParentNode(t=>[...t.absoluteParamNames,...this._paramNames],()=>[...this._paramNames])}get weight(){return this._weight}get absoluteWeight(){return this._absoluteWeight>0?this._absoluteWeight:this._absoluteWeight=this._checkParentNode(t=>t.absoluteWeight+this._weight,()=>this._weight)}get childIndex(){return this._childIndex}get name(){return this._name}async guardCheck(t){if(this._hasGuard&&this._waitForSetGuardHandler&&await this._waitForSetGuardHandler,this._guardHandler){const e=t.path,a=t.lastPath;if(!await this._guardHandler(e,a))throw new i("Navigation cancelled by guard.",this._guardFallbackPath)}}show(e){this._params={};for(const t of this._paramNames)this._params[t]=e[t];const a=this.placeHolder.parentNode,s=this.placeHolder.nextSibling;for(const e of this.childNodeArray)if(s?a?.insertBefore(e,s):a?.appendChild(e),e.nodeType===Node.ELEMENT_NODE){const a=e;a.querySelectorAll("[data-bind]").forEach(t=>{o(t,this._params)}),a.hasAttribute("data-bind")&&o(a,this._params),a.querySelectorAll(t.tagNames.layoutOutlet).forEach(t=>{t.assignParams(this._params)}),a.tagName.toLowerCase()===t.tagNames.layoutOutlet&&a.assignParams(this._params)}return!0}hide(){this._params={};for(const t of this.childNodeArray)t.parentNode?.removeChild(t)}shouldChange(t){for(const e of this._paramNames)if(this._params[e]!==t[e])return!0;return!1}get guardHandler(){return this._guardHandler||a(`${t.tagNames.route} has no guardHandler.`),this._guardHandler}set guardHandler(t){this._resolveSetGuardHandler?.(),this._guardHandler=t}initialize(){if(this._initialized)return;this.hasAttribute("path")?this._path=this.getAttribute("path")||"":this.hasAttribute("index")?this._path="":this.hasAttribute("fallback")?(this._path="",this._isFallbackRoute=!0):a(`${t.tagNames.route} should have a "path" or "index" attribute.`);const e=this._path.split("/"),s=[];for(const t of e)t.startsWith(":")?(this._paramNames.push(t.substring(1)),s.push("([^\\/]+)"),this._weight+=1):(s.push(t),this._weight+=2);this._patternText=s.join("\\/"),this._hasGuard=this.hasAttribute("guard"),this._hasGuard&&(this._guardFallbackPath=this.getAttribute("guard")||"/",this._waitForSetGuardHandler=new Promise(t=>{this._resolveSetGuardHandler=t})),this._initialized=!0}}const r=new Map;class l extends HTMLElement{_uuid=e();_name="";_initialized=!1;constructor(){super()}async _loadTemplateFromSource(e){try{const s=await fetch(e);s.ok||a(`${t.tagNames.layout} failed to fetch layout from source: ${e}, status: ${s.status}`);const o=await s.text();return r.set(e,o),o}catch(s){a(`${t.tagNames.layout} failed to load layout from source: ${e}, error: ${s}`)}}_loadTemplateFromDocument(t){const e=document.getElementById(`${t}`);return e&&e instanceof HTMLTemplateElement?e.innerHTML:null}async loadTemplate(){const e=this.getAttribute("src"),a=this.getAttribute("layout");e&&a&&console.warn(`${t.tagNames.layout} have both "src" and "layout" attributes.`);const s=document.createElement("template");if(e)r.has(e)?s.innerHTML=r.get(e)||"":(s.innerHTML=await this._loadTemplateFromSource(e)||"",r.set(e,s.innerHTML));else if(a){const e=this._loadTemplateFromDocument(a);e?s.innerHTML=e:console.warn(`${t.tagNames.layout} could not find template with id "${a}".`)}return s}get uuid(){return this._uuid}get enableShadowRoot(){return!!this.hasAttribute("enable-shadow-root")||!this.hasAttribute("disable-shadow-root")&&t.enableShadowRoot}get name(){return this._name}_initialize(){this._name=this.getAttribute("name")||"",this._initialized=!0}connectedCallback(){this._initialized||this._initialize()}}class h extends HTMLElement{_routesNode=null;_lastRoutes=[];_initialized=!1;constructor(){super()}get routesNode(){return this._routesNode||a(`${t.tagNames.outlet} has no routesNode.`),this._routesNode}set routesNode(t){this._routesNode=t}get rootNode(){return this.shadowRoot?this.shadowRoot:this}get lastRoutes(){return this._lastRoutes}set lastRoutes(t){this._lastRoutes=[...t]}_initialize(){t.enableShadowRoot&&this.attachShadow({mode:"open"}),this._initialized=!0}connectedCallback(){this._initialized||this._initialize()}}class u extends HTMLElement{_layout=null;_initialized=!1;_layoutChildNodes=[];constructor(){super()}get layout(){return this._layout||a(`${t.tagNames.layoutOutlet} has no layout.`),this._layout}set layout(t){this._layout=t,this.setAttribute("name",t.name)}get name(){return this.layout.name}async _initialize(){this._initialized=!0,this.layout.enableShadowRoot&&this.attachShadow({mode:"open"});const e=await this.layout.loadTemplate();if(this.shadowRoot){this.shadowRoot.appendChild(e.content.cloneNode(!0));for(const t of Array.from(this.layout.childNodes))this._layoutChildNodes.push(t),this.appendChild(t)}else{const a=e.content.cloneNode(!0),s=new Map;a.querySelectorAll("slot").forEach(e=>{const a=e.getAttribute("name")||"";s.has(a)?console.warn(`${t.tagNames.layoutOutlet} duplicate slot name "${a}" in layout template.`):s.set(a,e)});const o=new Map,i=document.createDocumentFragment();for(const t of Array.from(this.layout.childNodes)){if(this._layoutChildNodes.push(t),t instanceof Element){const e=t.getAttribute("slot")||"";if(e.length>0&&s.has(e)){o.has(e)||o.set(e,document.createDocumentFragment()),o.get(e)?.appendChild(t);continue}}i.appendChild(t)}for(const[t,e]of s){const a=o.get(t);a&&e.replaceWith(a)}const n=s.get("");n&&n.replaceWith(i),this.appendChild(a)}}async connectedCallback(){this._initialized||await this._initialize()}assignParams(t){for(const e of this._layoutChildNodes)e instanceof Element&&(e.querySelectorAll("[data-bind]").forEach(e=>{o(e,t)}),e.hasAttribute("data-bind")&&o(e,t))}}function d(){return document.createElement(t.tagNames.layoutOutlet)}async function c(e,a,s,o){const i=s.length>0?s[s.length-1]:null,n=document.createDocumentFragment(),r=Array.from(a.childNodes);for(const a of r)if(a.nodeType===Node.ELEMENT_NODE){let r=a,l=a;const h=l.tagName.toLowerCase();if(h===t.tagNames.route){const t=document.createDocumentFragment();for(const e of Array.from(l.childNodes))t.appendChild(e);const a=document.importNode(l,!0);customElements.upgrade(a),a.appendChild(t);const n=a;n.initialize(),n.routerNode=e,n.routeParentNode=i,n.placeHolder=document.createComment(`@@route:${n.uuid}`),s.push(n),o.set(n.uuid,n),r=n.placeHolder,l=n}else if(h===t.tagNames.layout){const t=document.createDocumentFragment();for(const e of Array.from(l.childNodes))t.appendChild(e);const e=document.importNode(l,!0);customElements.upgrade(e),e.appendChild(t);const a=e,s=d();s.layout=a,r=s,l=e}const u=await c(e,l,s,o);l.innerHTML="",l.appendChild(u),n.appendChild(r)}else n.appendChild(a);return n}async function m(t){const e=new Map;return await c(t,t.template.content,[],e)}function _(t,e,a,s,o){const i=a.concat(e),n=e.testPath(s);if(n)o.push(n);else for(const a of e.routeChildNodes)_(t,a,i,s,o)}async function p(e,s,o,i){const n=e.basename,r=o.startsWith(n)?o.slice(n.length):o;let l=function(t,e){const a=[],s=t.routeChildNodes,o=[];for(const i of s)_(t,i,a,e,o);return o.sort((t,e)=>{const a=t.routes.at(-1),s=e.routes.at(-1),o=a.absoluteWeight-s.absoluteWeight;return 0!==o?-o:a.childIndex-s.childIndex}),o.length>0?o[0]:null}(e,r);l||(e.fallbackRoute?l={routes:[e.fallbackRoute],params:{},path:r,lastPath:i}:a(`${t.tagNames.router} No route matched for path: ${r}`)),l.lastPath=i;const h=s.lastRoutes;await async function(t,e,a){const s=new Set(e.routes);for(const t of a)s.has(t)||t.hide();try{for(const t of e.routes)await t.guardCheck(e)}catch(e){const a=e;if("fallbackPath"in a){const e=a;return console.warn(`Navigation cancelled: ${a.message}. Redirecting to ${e.fallbackPath}`),void queueMicrotask(()=>{t.navigate(e.fallbackPath)})}throw e}const o=new Set(a);let i=!1;for(const t of e.routes)(!o.has(t)||t.shouldChange(e.params)||i)&&(i=t.show(e.params))}(e,l,h),e.path=r,s.lastRoutes=l.routes}function g(){const t=window.navigation;return t?"function"!=typeof t.addEventListener||"function"!=typeof t.removeEventListener?null:t:null}class N extends HTMLElement{static _instance=null;_outlet=null;_template=null;_routeChildNodes=[];_basename="";_path="";_initialized=!1;_fallbackRoute=null;constructor(){super(),N._instance&&a(`${t.tagNames.router} can only be instantiated once.`),N._instance=this}_normalizePath(t){let e=t;return e.endsWith("/")||(e=e.replace(/\/[^/]*$/,"/")),e.startsWith("/")||(e="/"+e),e=e.replace(/\/{2,}/g,"/"),e}_getBasename(){let t=new URL(document.baseURI).pathname||"/";return"/"===t?"":this._normalizePath(t)}static get instance(){return N._instance||a(`${t.tagNames.router} has not been instantiated.`),N._instance}static navigate(t){N.instance.navigate(t)}get basename(){return this._basename}_getOutlet(){let e=document.querySelector(t.tagNames.outlet);return e||(e=document.createElement(t.tagNames.outlet),document.body.appendChild(e)),e}_getTemplate(){return this.querySelector("template")}get outlet(){return this._outlet||a(`${t.tagNames.router} has no outlet.`),this._outlet}get template(){return this._template||a(`${t.tagNames.router} has no template.`),this._template}get routeChildNodes(){return this._routeChildNodes}get path(){return this._path}set path(t){this._path=t}get fallbackRoute(){return this._fallbackRoute}set fallbackRoute(t){this._fallbackRoute=t}async navigate(t){const e=this._basename+t,a=g();a?.navigate?a.navigate(e):(history.pushState(null,"",e),await p(this,this.outlet,e,this._path))}_onNavigateFunc(t){if(!t.canIntercept||t.hashChange||null!==t.downloadRequest)return;const e=this;t.intercept({async handler(){const a=new URL(t.destination.url);await p(e,e.outlet,a.pathname,this._path)}})}_onNavigate=this._onNavigateFunc.bind(this);async _initialize(){this._initialized=!0,this._basename=this.getAttribute("basename")||this._getBasename()||"";const e=null!==document.querySelector("base[href]"),s=new URL(window.location.href);""!==this._basename||e||"/"===s.pathname||a(`${t.tagNames.router} basename is empty, but current path is not "/".`),this._outlet=this._getOutlet(),this._outlet.routesNode=this,this._template=this._getTemplate(),this._template||a(`${t.tagNames.router} should have a <template> child element.`);const o=await m(this);this._outlet.rootNode.appendChild(o);const i=this._normalizePath(window.location.pathname);await p(this,this.outlet,i,this._path)}async connectedCallback(){this._initialized||await this._initialize(),g()?.addEventListener("navigate",this._onNavigate)}disconnectedCallback(){g()?.removeEventListener("navigate",this._onNavigate)}}class f extends HTMLElement{_childNodeArray=[];_uuid=e();_commentNode=document.createComment(`@@link:${this._uuid}`);_path="";_router=null;_anchorElement=null;_initialized=!1;constructor(){super()}get uuid(){return this._uuid}get commentNode(){return this._commentNode}get router(){if(this._router)return this._router;const e=document.querySelector(t.tagNames.router);if(e)return this._router=e;a(`${t.tagNames.link} is not connected to a router.`)}_initialize(){this.replaceWith(this._commentNode),this._childNodeArray=Array.from(this.childNodes),this._path=this.getAttribute("to")||"",this._initialized=!0}connectedCallback(){this._initialized||this._initialize();const e=this._commentNode.parentNode;e||a(`${t.tagNames.link} comment node has no parent`);const s=this._commentNode.nextSibling,o=document.createElement("a");this._path.startsWith("/")?o.href=this.router.basename+this._path:o.href=new URL(this._path).toString();for(const t of this._childNodeArray)o.appendChild(t);s?e.insertBefore(o,s):e.appendChild(o),this._anchorElement=o,g()?.addEventListener("currententrychange",this._updateActiveState),this._updateActiveState()}disconnectedCallback(){g()?.removeEventListener("currententrychange",this._updateActiveState),this._anchorElement&&this._anchorElement.remove();for(const t of this._childNodeArray)t.parentNode?.removeChild(t)}_updateActiveState=()=>{const t=new URL(window.location.href).pathname,e=this.router.basename+this._path;this._anchorElement&&(t===e?this._anchorElement.classList.add("active"):this._anchorElement.classList.remove("active"))}}function b(){customElements.get(t.tagNames.layout)||customElements.define(t.tagNames.layout,l),customElements.get(t.tagNames.layoutOutlet)||customElements.define(t.tagNames.layoutOutlet,u),customElements.get(t.tagNames.outlet)||customElements.define(t.tagNames.outlet,h),customElements.get(t.tagNames.route)||customElements.define(t.tagNames.route,n),customElements.get(t.tagNames.router)||customElements.define(t.tagNames.router,N),customElements.get(t.tagNames.link)||customElements.define(t.tagNames.link,f)}export{t as config,b as registerComponents};
//# sourceMappingURL=index.esm.min.js.map
